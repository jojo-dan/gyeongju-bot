<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>경주 가족여행 가이드</title>
<meta property="og:title" content="경주 가족여행 가이드">
<meta property="og:description" content="2026.02.19~24 · 6일간의 식당·관광지 완벽 가이드">
<meta property="og:image" content="https://gyeongju-trip.vercel.app/og-image.png">
<meta property="og:url" content="https://gyeongju-trip.vercel.app/guide">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #E5E5E5;
  --housing: #FFFFFF;
  --display: #2A2A2A;
  --display-text: #FFFFFF;
  --display-dim: rgba(255,255,255,0.65);
  --accent: #E85D2A;
  --text: #1A1A1A;
  --text-mid: #555;
  --text-light: #666;
  --border: #D5D5D5;
  --item-bg: #F5F3F0;
  --item-text: #1A1A1A;
  --item-text-mid: #444;
  --item-text-dim: #666;
  --serif: 'Playfair Display', Georgia, 'Noto Serif KR', serif;
  --mono: 'IBM Plex Mono', 'SF Mono', monospace;
  --system: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', sans-serif;
  --radius-device: 16px;
  --radius-display: 10px;
  --radius-btn: 8px;
  --shadow-device: 0 2px 24px rgba(0,0,0,0.08), 0 0 0 1px rgba(0,0,0,0.03);
  --shadow-btn: 0 1px 3px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
}

body {
  font-family: var(--system);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  -webkit-text-size-adjust: 100%;
}

/* ═══ HEADER ═══ */
.header {
  padding: 32px 20px 20px;
  text-align: center;
}
.header h1 {
  font-family: var(--serif);
  font-size: 28px;
  font-weight: 700;
  letter-spacing: -0.5px;
  color: var(--text);
  margin-bottom: 4px;
}
.header .sub-info {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 500;
  color: var(--text-mid);
  letter-spacing: 0.5px;
}
.header .sub-detail {
  font-family: var(--system);
  font-size: 13px;
  color: var(--text-light);
  margin-top: 4px;
}
.daily-link {
  display: inline-block;
  margin-top: 10px;
  font-family: var(--system);
  font-size: 13px;
  font-weight: 600;
  color: var(--text-mid);
  text-decoration: none;
  border: 1px solid var(--border);
  border-radius: var(--radius-btn);
  padding: 6px 14px;
  background: var(--housing);
  transition: opacity 0.15s;
}
.daily-link:active { opacity: 0.7; }

/* ═══ CONTAINER ═══ */
.container {
  max-width: 420px;
  margin: 0 auto;
  padding: 0 16px 32px;
}

/* ═══ SECTION NAV (Sticky) ═══ */
.section-nav {
  display: flex;
  gap: 0;
  max-width: 420px;
  margin: 0 auto 16px;
  padding: 0 16px;
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--bg);
  padding-top: 8px;
  padding-bottom: 8px;
}
.section-nav-btn {
  flex: 1 1 0;
  padding: 10px 0;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--text-mid);
  background: var(--housing);
  border: 1px solid var(--border);
  cursor: pointer;
  text-align: center;
  min-height: 40px;
  transition: all 0.15s ease;
  line-height: 1.3;
}
.section-nav-btn:first-child { border-radius: var(--radius-btn) 0 0 var(--radius-btn); }
.section-nav-btn:last-child { border-radius: 0 var(--radius-btn) var(--radius-btn) 0; }
.section-nav-btn:not(:first-child) { border-left: none; }
.section-nav-btn.active {
  background: var(--text);
  color: #fff;
  border-color: var(--text);
}

/* ═══ SECTION HEADER (Full-bleed Dark) ═══ */
.section-device {
  background: var(--display);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  padding: 20px 16px;
  margin-bottom: 12px;
}
.section-label {
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--accent);
  letter-spacing: 1px;
  margin-bottom: 8px;
}
.section-title {
  font-family: var(--mono);
  font-size: 20px;
  font-weight: 600;
  color: var(--display-text);
  letter-spacing: 0.5px;
}
.section-subtitle {
  font-family: var(--mono);
  font-size: 13px;
  color: var(--display-dim);
  margin-top: 4px;
}

/* ═══ OVERVIEW: DAY CARD (Accordion) ═══ */
.day-overview {
  background: var(--housing);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  margin-bottom: 10px;
  overflow: hidden;
}
.day-overview summary {
  list-style: none;
  cursor: pointer;
  user-select: none;
  padding: 14px 16px;
}
.day-overview summary::-webkit-details-marker { display: none; }
.day-overview-summary-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.day-overview-num {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 600;
  color: var(--accent);
  letter-spacing: 0.5px;
}
.day-overview-date {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-light);
}
.day-overview-title {
  font-family: var(--system);
  font-size: 17px;
  font-weight: 700;
  color: var(--item-text);
  margin-top: 4px;
}
.day-overview-keyword {
  font-family: var(--system);
  font-size: 13px;
  color: var(--text-light);
  margin-top: 2px;
}
.day-overview-chevron {
  font-size: 12px;
  color: var(--text-light);
  transition: transform 0.15s;
  margin-left: 8px;
}
.day-overview[open] .day-overview-chevron {
  transform: rotate(90deg);
}
.day-overview-items {
  padding: 0 16px 14px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  border-top: 1px solid var(--border);
  margin-top: 0;
  padding-top: 12px;
}
.day-item-row {
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: var(--system);
  font-size: 14px;
  color: var(--item-text-mid);
}
.day-item-icon {
  width: 20px;
  text-align: center;
  flex-shrink: 0;
  font-size: 13px;
}
.day-item-text {
  flex: 1;
}
.day-item-chosen {
  font-family: var(--mono);
  font-size: 11px;
  color: #1A6B1A;
  font-weight: 600;
  flex-shrink: 0;
}
.day-item-optional {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-light);
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 1px 4px;
  flex-shrink: 0;
}

/* ═══ PLACE GUIDE (Accordion) ═══ */
.place-card {
  background: var(--housing);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  margin-bottom: 12px;
  overflow: hidden;
}
.place-card > summary {
  list-style: none;
  cursor: pointer;
  user-select: none;
  padding: 16px 16px 14px;
}
.place-card > summary::-webkit-details-marker { display: none; }
.place-summary-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.place-name {
  font-family: var(--system);
  font-size: 18px;
  font-weight: 700;
  color: var(--item-text);
}
.place-chevron {
  font-size: 12px;
  color: var(--text-light);
  transition: transform 0.15s;
  margin-left: 8px;
  flex-shrink: 0;
}
.place-card[open] .place-chevron {
  transform: rotate(90deg);
}
.place-subtitle {
  font-family: var(--system);
  font-size: 13px;
  color: var(--text-light);
  margin-top: 2px;
}
.place-body {
  border-top: 1px solid var(--border);
  margin: 0 16px;
  padding-top: 14px;
}
.place-section {
  padding: 0 0 14px;
}
.place-section-label {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 600;
  color: var(--accent);
  letter-spacing: 0.5px;
  text-transform: uppercase;
  margin-bottom: 8px;
}
.place-list {
  list-style: none;
}
.place-list li {
  font-family: var(--system);
  font-size: 14px;
  color: var(--item-text-mid);
  padding: 4px 0;
  padding-left: 12px;
  position: relative;
  line-height: 1.5;
}
.place-list li::before {
  content: '';
  position: absolute;
  left: 0;
  top: 11px;
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--accent);
}
.baby-tip-box {
  background: #F0F7FF;
  border-radius: 8px;
  padding: 12px 14px;
  margin-bottom: 10px;
}
.baby-tip-label {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 600;
  color: #1D4ED8;
  letter-spacing: 0.3px;
  margin-bottom: 4px;
}
.baby-tip-text {
  font-family: var(--system);
  font-size: 13px;
  color: #1A1A1A;
  line-height: 1.5;
}
.practical-grid {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 4px 10px;
  font-family: var(--system);
  font-size: 13px;
  padding-bottom: 4px;
}
.practical-label {
  color: var(--text-light);
  font-weight: 600;
  white-space: nowrap;
}
.practical-value {
  color: var(--item-text-mid);
}

/* ═══ RESTAURANT GUIDE ═══ */
.sort-bar {
  display: flex;
  gap: 0;
  margin-bottom: 12px;
}
.sort-btn {
  flex: 1 1 0;
  padding: 8px 0;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--text-mid);
  background: var(--housing);
  border: 1px solid var(--border);
  cursor: pointer;
  text-align: center;
  min-height: 36px;
  transition: all 0.15s;
}
.sort-btn:first-child { border-radius: var(--radius-btn) 0 0 var(--radius-btn); }
.sort-btn:last-child { border-radius: 0 var(--radius-btn) var(--radius-btn) 0; }
.sort-btn:not(:first-child) { border-left: none; }
.sort-btn.active {
  background: var(--text);
  color: #fff;
  border-color: var(--text);
}

/* Restaurant card (accordion) */
.rest-card {
  background: var(--housing);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  margin-bottom: 10px;
  overflow: hidden;
}
.rest-card > summary {
  list-style: none;
  cursor: pointer;
  user-select: none;
  padding: 14px 16px;
}
.rest-card > summary::-webkit-details-marker { display: none; }
.rest-summary-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
}
.rest-name {
  font-family: var(--system);
  font-size: 16px;
  font-weight: 700;
  color: var(--item-text);
  flex: 1;
}
.rest-rating {
  font-family: var(--mono);
  font-size: 14px;
  font-weight: 600;
  color: var(--accent);
  margin-left: 8px;
}
.rest-chevron {
  font-size: 12px;
  color: var(--text-light);
  transition: transform 0.15s;
  margin-left: 8px;
  flex-shrink: 0;
}
.rest-card[open] .rest-chevron {
  transform: rotate(90deg);
}
.rest-summary-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  font-family: var(--system);
  font-size: 13px;
  color: var(--text-light);
}
.rest-menu-brief {
  color: var(--item-text-mid);
}
.rest-open-tag {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 3px;
}
.rest-open-tag.open { background: #DEF7E5; color: #1A6B1A; }
.rest-open-tag.closed { background: #FEE2E2; color: #C53030; }
.rest-open-tag.unknown { background: var(--item-bg); color: var(--text-light); }

/* ═══ STAY SECTION ═══ */
.stay-card {
  background: var(--housing);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  margin-bottom: 10px;
  overflow: hidden;
}
.stay-card > summary {
  list-style: none;
  cursor: pointer;
  user-select: none;
  padding: 14px 16px;
}
.stay-card > summary::-webkit-details-marker { display: none; }
.stay-card-title {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.stay-card-name {
  font-family: var(--system);
  font-size: 16px;
  font-weight: 700;
  color: var(--item-text);
}
.stay-card-chevron {
  font-size: 12px;
  color: var(--text-light);
  transition: transform 0.15s;
  margin-left: 8px;
  flex-shrink: 0;
}
.stay-card[open] .stay-card-chevron {
  transform: rotate(90deg);
}
.stay-card-sub {
  font-family: var(--system);
  font-size: 13px;
  color: var(--text-light);
  margin-top: 2px;
}
.stay-body {
  border-top: 1px solid var(--border);
  margin: 0 16px;
  padding: 14px 0;
}
.stay-room-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-bottom: 14px;
}
.stay-room-chip {
  background: var(--item-bg);
  border-radius: var(--radius-btn);
  padding: 10px 8px;
  text-align: center;
}
.stay-room-label {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 600;
  color: var(--item-text);
}
.stay-room-detail {
  font-family: var(--system);
  font-size: 11px;
  color: var(--text-light);
  margin-top: 2px;
  line-height: 1.4;
}
.stay-amenity-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 8px;
}
.stay-amenity-tag {
  font-family: var(--system);
  font-size: 12px;
  color: var(--item-text-mid);
  background: var(--item-bg);
  border-radius: 4px;
  padding: 4px 8px;
}
.stay-highlight-box {
  background: #FFF7ED;
  border-radius: 8px;
  padding: 12px 14px;
  margin-bottom: 10px;
}
.stay-highlight-label {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 600;
  color: var(--accent);
  letter-spacing: 0.3px;
  margin-bottom: 4px;
}
.stay-highlight-text {
  font-family: var(--system);
  font-size: 13px;
  color: #1A1A1A;
  line-height: 1.5;
}
.rest-distance {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-light);
}

/* Restaurant body (expanded) */
.rest-body {
  border-top: 1px solid var(--border);
  margin: 0 16px;
  padding: 14px 0;
}
.rest-info-row {
  font-family: var(--system);
  font-size: 13px;
  color: var(--item-text-mid);
  padding: 3px 0;
}
.rest-info-label {
  font-weight: 600;
  color: var(--text-light);
  margin-right: 6px;
}
.rest-badges {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-top: 8px;
}
.badge {
  display: inline-block;
  padding: 3px 7px;
  border-radius: 4px;
  font-family: var(--system);
  font-size: 11px;
  font-weight: 600;
}
.badge-dad-good { background: #DEF7E5; color: #1A6B1A; }
.badge-dad-caution { background: #FDE8E0; color: #C04A1A; }
.badge-hiro-good { background: #DBEAFE; color: #1D4ED8; }
.badge-hiro-caution { background: #FEE2E2; color: #C53030; }
.rest-meals-list {
  margin-top: 10px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-light);
}
.rest-map-link {
  display: inline-block;
  margin-top: 8px;
  font-family: var(--system);
  font-size: 12px;
  font-weight: 600;
  color: var(--text-mid);
  text-decoration: none;
  border-bottom: 1px solid var(--border);
  padding-bottom: 1px;
}

/* ═══ FOOTER ═══ */
.footer {
  text-align: center;
  padding: 20px 16px 40px;
}
.footer-link {
  display: inline-block;
  font-family: var(--system);
  font-size: 14px;
  font-weight: 700;
  color: #fff;
  background: var(--text);
  border-radius: var(--radius-btn);
  padding: 12px 24px;
  text-decoration: none;
  box-shadow: var(--shadow-btn);
  transition: opacity 0.15s;
}
.footer-link:active { opacity: 0.8; }
.footer-note {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text-light);
  margin-top: 12px;
}

/* ═══ SCROLL TO TOP ═══ */
.scroll-top {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--text);
  color: #fff;
  border: none;
  font-size: 18px;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  opacity: 0;
  transition: opacity 0.2s;
  pointer-events: none;
  z-index: 200;
}
.scroll-top.visible {
  opacity: 1;
  pointer-events: auto;
}

/* ═══ LOADING ═══ */
.loading {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-light);
  font-family: var(--system);
  font-size: 14px;
}
.loading .spinner {
  display: inline-block;
  width: 24px; height: 24px;
  border: 2px solid var(--border);
  border-top-color: var(--text);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="header">
  <h1>경주 가족여행 가이드</h1>
  <div class="sub-info">2026.02.19(목) — 02.24(화)</div>
  <div class="sub-detail">5박 6일 · 까사멜로우</div>
  <a href="/" class="daily-link">일정 상세 보기</a>
</div>

<div class="section-nav">
  <button class="section-nav-btn active" onclick="scrollToSection('overview')">일정</button>
  <button class="section-nav-btn" onclick="scrollToSection('places')">장소</button>
  <button class="section-nav-btn" onclick="scrollToSection('restaurants')">식당</button>
  <button class="section-nav-btn" onclick="scrollToSection('stay')">숙소</button>
</div>

<div class="container">
  <div id="contentArea">
    <div class="loading">
      <div class="spinner"></div>
      <div>가이드 불러오는 중...</div>
    </div>
  </div>
</div>

<button class="scroll-top" id="scrollTopBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})">&#8593;</button>

<script>
let travelData = null;

// ═══ DATA FETCH ═══
(async function init() {
  try {
    const res = await fetch('/api/data');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    travelData = json.record;
    render();
  } catch (e) {
    document.getElementById('contentArea').innerHTML =
      '<div class="loading" style="color:#C04A1A">데이터를 불러올 수 없습니다. 새로고침해 주세요.</div>';
  }
})();

// ═══ RENDER ═══
function render() {
  if (!travelData) return;
  let html = '';
  html += renderOverviewSection(travelData.days);
  html += renderPlacesSection(travelData.days);
  html += renderRestaurantSection(travelData.days);
  html += renderStaySection();
  html += renderFooter();
  document.getElementById('contentArea').innerHTML = html;
}

// ═══ ① OVERVIEW ═══
function renderOverviewSection(days) {
  let html = '<div id="overview">';
  html += '<div class="section-device">';
  html += '<div class="section-label">OVERVIEW</div>';
  html += '<div class="section-title">일정 한눈에 보기</div>';
  html += '<div class="section-subtitle">6일간의 여행 요약</div>';
  html += '</div>';

  days.forEach(function(day) {
    html += '<details class="day-overview">';
    html += '<summary>';
    html += '<div class="day-overview-summary-row">';
    html += '<span class="day-overview-num">DAY ' + day.dayNum + '</span>';
    html += '<span style="display:flex;align-items:center"><span class="day-overview-date">' + formatDate(day.date) + ' ' + day.dow + '</span>';
    html += '<span class="day-overview-chevron">\u25B8</span></span>';
    html += '</div>';
    html += '<div class="day-overview-title">' + esc(day.title) + '</div>';
    if (day.keyword) {
      html += '<div class="day-overview-keyword">' + esc(day.keyword) + '</div>';
    }
    html += '</summary>';
    html += '<div class="day-overview-items">';
    day.items.forEach(function(item) {
      var icon = item.cat === 'meal' ? '\uD83C\uDF7D' : item.cat === 'cafe' ? '\u2615' : '\uD83C\uDFDB';
      html += '<div class="day-item-row">';
      html += '<span class="day-item-icon">' + icon + '</span>';
      html += '<span class="day-item-text">' + esc(item.title);
      if (item.options && item.options.length > 0 && item.chosen) {
        html += ' <b>' + esc(item.chosen) + '</b>';
      }
      html += '</span>';
      if (item.chosen) {
        html += '<span class="day-item-chosen">확정</span>';
      }
      if (item.optional) {
        html += '<span class="day-item-optional">선택</span>';
      }
      html += '</div>';
    });
    html += '</div></details>';
  });
  html += '</div>';
  return html;
}

// ═══ ② PLACES GUIDE ═══
function renderPlacesSection(days) {
  var html = '<div id="places" style="margin-top:20px">';
  html += '<div class="section-device">';
  html += '<div class="section-label">PLACES</div>';
  html += '<div class="section-title">장소 가이드</div>';
  html += '<div class="section-subtitle">주요 관광지 · 아이 동반 팁</div>';
  html += '</div>';

  // 고유 장소 추출 (guide 필드가 있는 activity)
  var seen = {};
  var places = [];
  days.forEach(function(day) {
    day.items.forEach(function(item) {
      if (item.cat === 'activity' && item.guide && !seen[item.id]) {
        seen[item.id] = true;
        places.push(item);
      }
    });
  });

  places.forEach(function(item) {
    var g = item.guide;
    html += '<details class="place-card">';
    html += '<summary>';
    html += '<div class="place-summary-row">';
    html += '<span class="place-name">' + esc(item.title) + '</span>';
    html += '<span class="place-chevron">\u25B8</span>';
    html += '</div>';
    if (g.subtitle) html += '<div class="place-subtitle">' + esc(g.subtitle) + '</div>';
    html += '</summary>';
    html += '<div class="place-body">';

    // Must-Do
    if (g.mustDo && g.mustDo.length > 0) {
      html += '<div class="place-section">';
      html += '<div class="place-section-label">Must-Do</div>';
      html += '<ul class="place-list">';
      g.mustDo.forEach(function(m) { html += '<li>' + esc(m) + '</li>'; });
      html += '</ul></div>';
    }

    // Baby Tips
    if (g.babyTips) {
      var bt = g.babyTips;
      html += '<div class="place-section">';
      html += '<div class="place-section-label">아이 동반 팁</div>';

      if (bt.stroller) {
        html += '<div class="baby-tip-box">';
        html += '<div class="baby-tip-label">유모차</div>';
        html += '<div class="baby-tip-text">' + esc(bt.stroller) + '</div>';
        html += '</div>';
      }

      if (bt.restSpots && bt.restSpots.length > 0) {
        html += '<div class="baby-tip-box">';
        html += '<div class="baby-tip-label">쉴 곳</div>';
        bt.restSpots.forEach(function(s) {
          html += '<div class="baby-tip-text">' + esc(s) + '</div>';
        });
        html += '</div>';
      }

      if (bt.restroom) {
        html += '<div class="baby-tip-box">';
        html += '<div class="baby-tip-label">화장실</div>';
        html += '<div class="baby-tip-text">' + esc(bt.restroom) + '</div>';
        html += '</div>';
      }

      if (bt.nursingRoom) {
        html += '<div class="baby-tip-box">';
        html += '<div class="baby-tip-label">수유실</div>';
        html += '<div class="baby-tip-text">' + esc(bt.nursingRoom) + '</div>';
        html += '</div>';
      }

      if (bt.recommendedRoute) {
        html += '<div class="baby-tip-box">';
        html += '<div class="baby-tip-label">추천 동선</div>';
        html += '<div class="baby-tip-text">' + esc(bt.recommendedRoute) + '</div>';
        html += '</div>';
      }

      html += '</div>';
    }

    // Practical Info
    if (g.practicalInfo) {
      var pi = g.practicalInfo;
      html += '<div class="place-section">';
      html += '<div class="place-section-label">실용 정보</div>';
      html += '<div class="practical-grid">';
      if (pi.fee) { html += '<span class="practical-label">입장료</span><span class="practical-value">' + esc(pi.fee) + '</span>'; }
      if (pi.hours) { html += '<span class="practical-label">운영시간</span><span class="practical-value">' + esc(pi.hours) + '</span>'; }
      if (pi.parking) { html += '<span class="practical-label">주차</span><span class="practical-value">' + esc(pi.parking) + '</span>'; }
      if (pi.timeNeeded) { html += '<span class="practical-label">소요시간</span><span class="practical-value">' + esc(pi.timeNeeded) + '</span>'; }
      if (pi.fromAccommodation) { html += '<span class="practical-label">숙소에서</span><span class="practical-value">' + esc(pi.fromAccommodation) + '</span>'; }
      if (pi.closedDays) { html += '<span class="practical-label">휴무</span><span class="practical-value">' + esc(pi.closedDays) + '</span>'; }
      html += '</div></div>';
    }

    html += '</div>'; // place-body
    html += '</details>';
  });

  html += '</div>';
  return html;
}

// ═══ ③ RESTAURANTS ═══

var allRestaurants = [];
var restSortMode = 'rating'; // 'rating' | 'distance'
var userLat = null, userLng = null;

// 테스트 위치 오버라이드 (?testloc=1 → 까사멜로우)
(function() {
  var params = new URLSearchParams(location.search);
  if (params.get('testloc') === '1') {
    userLat = 35.8579382;
    userLng = 129.262038;
    restSortMode = 'distance';
  }
})();

function extractRestaurants(days) {
  var map = {};
  days.forEach(function(day) {
    day.items.forEach(function(item) {
      if (item.cat !== 'meal' && item.cat !== 'cafe') return;
      if (!item.options) return;
      item.options.forEach(function(opt) {
        var key = opt.name;
        if (!key) return;
        if (!map[key]) {
          map[key] = {
            name: opt.name,
            menu: opt.menu || opt.desc || '',
            hours: opt.hours || '',
            loc: opt.loc || '',
            lat: opt.lat || null,
            lng: opt.lng || null,
            dad: opt.dad || '',
            dadNote: opt.dadNote || '',
            hiro: opt.hiro || '',
            hiroNote: opt.hiroNote || '',
            rating: opt.rating || null,
            ratingSource: opt.ratingSource || '',
            priceRange: opt.priceRange || '',
            menuDetail: opt.menuDetail || null,
            mapUrl: opt.mapUrl || '',
            category: opt.category || '',
            cat: item.cat,
            meals: [],
            distKm: null
          };
        }
        map[key].meals.push('Day ' + day.dayNum + ' ' + (item.time || ''));
        // Merge missing data from other appearances
        if (!map[key].hours && opt.hours) map[key].hours = opt.hours;
        if (!map[key].lat && opt.lat) { map[key].lat = opt.lat; map[key].lng = opt.lng; }
        if (!map[key].rating && opt.rating) map[key].rating = opt.rating;
      });
    });
  });
  return Object.values(map);
}

function sortRestaurants(list) {
  if (restSortMode === 'distance' && userLat) {
    list.forEach(function(r) {
      r.distKm = (r.lat && r.lng) ? haversineKm(userLat, userLng, r.lat, r.lng) : 9999;
    });
    list.sort(function(a, b) { return a.distKm - b.distKm; });
  } else {
    // Sort by rating (desc), then by name
    list.sort(function(a, b) {
      var ra = a.rating || 0, rb = b.rating || 0;
      if (rb !== ra) return rb - ra;
      return a.name.localeCompare(b.name);
    });
  }
  return list;
}

function haversineKm(lat1, lng1, lat2, lng2) {
  var R = 6371;
  var dLat = (lat2 - lat1) * Math.PI / 180;
  var dLng = (lng2 - lng1) * Math.PI / 180;
  var a = Math.sin(dLat / 2) * Math.sin(dLat / 2)
    + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180)
    * Math.sin(dLng / 2) * Math.sin(dLng / 2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function parseOpenClosed(hoursStr) {
  if (!hoursStr) return { status: 'unknown', label: '' };
  // Try HH:MM~HH:MM pattern
  var m = hoursStr.match(/(\d{1,2}):?(\d{2})?\s*[~\-]\s*(\d{1,2}):?(\d{2})?/);
  if (!m) return { status: 'unknown', label: hoursStr };
  var openH = parseInt(m[1]);
  var openM = m[2] ? parseInt(m[2]) : 0;
  var closeH = parseInt(m[3]);
  var closeM = m[4] ? parseInt(m[4]) : 0;
  var now = new Date();
  var nowMin = now.getHours() * 60 + now.getMinutes();
  var openMin = openH * 60 + openM;
  var closeMin = closeH * 60 + closeM;
  if (nowMin >= openMin && nowMin < closeMin) {
    return { status: 'open', label: '영업 중' };
  } else {
    return { status: 'closed', label: '영업 종료' };
  }
}

function renderRestaurantSection(days) {
  allRestaurants = extractRestaurants(days);
  allRestaurants = sortRestaurants(allRestaurants);

  var html = '<div id="restaurants" style="margin-top:20px">';
  html += '<div class="section-device">';
  html += '<div class="section-label">RESTAURANTS</div>';
  html += '<div class="section-title">식당 · 카페 가이드</div>';
  html += '<div class="section-subtitle">' + allRestaurants.length + '곳 · 메뉴 · 알레르기 정보</div>';
  html += '</div>';

  // Sort bar
  html += '<div class="sort-bar">';
  html += '<button class="sort-btn' + (restSortMode === 'rating' ? ' active' : '') + '" onclick="changeRestSort(\'rating\')">별점순</button>';
  html += '<button class="sort-btn' + (restSortMode === 'distance' ? ' active' : '') + '" onclick="changeRestSort(\'distance\')">' + (userLat ? '거리순' : '거리순 (위치 필요)') + '</button>';
  html += '</div>';

  html += '<div id="restList">';
  html += renderRestCards(allRestaurants);
  html += '</div>';

  html += '</div>';
  return html;
}

function renderRestCards(list) {
  var html = '';
  list.forEach(function(r) {
    html += '<details class="rest-card">';

    // Summary (collapsed view)
    html += '<summary>';
    html += '<div class="rest-summary-top">';
    html += '<span class="rest-name">' + esc(r.name) + '</span>';
    if (r.rating) html += '<span class="rest-rating">' + r.rating.toFixed(1) + '</span>';
    html += '<span class="rest-chevron">\u25B8</span>';
    html += '</div>';
    html += '<div class="rest-summary-meta">';
    if (r.menu) html += '<span class="rest-menu-brief">' + esc(r.menu) + '</span>';
    var oc = parseOpenClosed(r.hours);
    if (oc.status !== 'unknown') {
      html += '<span class="rest-open-tag ' + oc.status + '">' + oc.label + '</span>';
    }
    if (r.distKm !== null && r.distKm < 100) {
      html += '<span class="rest-distance">' + (r.distKm < 1 ? r.distKm.toFixed(1) : Math.round(r.distKm)) + 'km</span>';
    }
    html += '</div>';
    html += '</summary>';

    // Body (expanded)
    html += '<div class="rest-body">';

    if (r.menuDetail && r.menuDetail.length > 0) {
      r.menuDetail.forEach(function(m) {
        html += '<div class="rest-info-row">' + esc(m.item);
        if (m.price) html += ' <span style="color:var(--text-light)">' + formatPrice(m.price) + '</span>';
        html += '</div>';
      });
    } else if (r.menu) {
      html += '<div class="rest-info-row"><span class="rest-info-label">메뉴</span>' + esc(r.menu) + '</div>';
    }
    if (r.priceRange) {
      html += '<div class="rest-info-row"><span class="rest-info-label">가격대</span>' + esc(r.priceRange) + '</div>';
    }
    if (r.hours) {
      html += '<div class="rest-info-row"><span class="rest-info-label">영업시간</span>' + esc(r.hours) + '</div>';
    }
    if (r.loc) {
      html += '<div class="rest-info-row"><span class="rest-info-label">위치</span>' + esc(r.loc) + '</div>';
    }

    var badges = buildBadges(r);
    if (badges) html += '<div class="rest-badges">' + badges + '</div>';

    if (r.meals.length > 0) {
      // Deduplicate meals
      var uniqueMeals = [];
      r.meals.forEach(function(m) { if (uniqueMeals.indexOf(m) === -1) uniqueMeals.push(m); });
      html += '<div class="rest-meals-list">' + uniqueMeals.join(' / ') + '</div>';
    }

    if (r.mapUrl) {
      html += '<a class="rest-map-link" href="' + escAttr(r.mapUrl) + '" target="_blank" rel="noopener">지도에서 보기 \u2192</a>';
    }

    html += '</div>';
    html += '</details>';
  });
  return html;
}

function changeRestSort(mode) {
  if (mode === 'distance' && !userLat) {
    requestRestLocation();
    return;
  }
  restSortMode = mode;
  allRestaurants = sortRestaurants(allRestaurants);
  // Re-render sort bar + list
  var container = document.getElementById('restaurants');
  if (!container) return;
  // Just re-render the whole restaurant section
  render();
}

function requestRestLocation() {
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(function(pos) {
    userLat = pos.coords.latitude;
    userLng = pos.coords.longitude;
    restSortMode = 'distance';
    render();
  }, function() {}, { enableHighAccuracy: false, timeout: 10000, maximumAge: 300000 });
}

function buildBadges(opt) {
  var b = '';
  if (opt.dad === 'good') b += '<span class="badge badge-dad-good">아빠 OK</span>';
  if (opt.dad === 'caution') b += '<span class="badge badge-dad-caution">아빠 주의' + (opt.dadNote ? ' · ' + esc(opt.dadNote) : '') + '</span>';
  if (opt.hiro === 'good') b += '<span class="badge badge-hiro-good">히로 OK</span>';
  if (opt.hiro === 'caution') b += '<span class="badge badge-hiro-caution">히로 주의' + (opt.hiroNote ? ' · ' + esc(opt.hiroNote) : '') + '</span>';
  return b;
}

// ═══ ④ STAY ═══

var STAY_DATA = {
  name: '까사멜로우',
  nameEn: 'Casa Mellow',
  desc: '아이와 함께하는 서툰 여행을 응원하며',
  address: '경상북도 경주시 북군4길 75',
  phone: '010-3583-6648',
  email: 'ssoong6648@naver.com',
  instagram: '@casa.mellow',
  checkin: '15:30',
  checkout: '11:00',
  parking: '건물 외부 전용 주차장',
  mapUrl: 'https://map.naver.com/p/search/까사멜로우 경주',
  stayfolioUrl: 'https://www.stayfolio.com/findstay/casa-mellow',
  rooms: [
    { name: 'A-1', type: '복층', people: '4/8명', bed: 'Q2 + S1', bath: '2.5', price: '289,000~' },
    { name: 'A-2', type: '복층', people: '4/8명', bed: 'Q2 + S1', bath: '2.5', price: '329,000~' },
    { name: 'B', type: '독채', people: '4/8명', bed: '4개', bath: '2', price: '329,000~' }
  ],
  amenities: {
    kitchen: ['인덕션', '전자레인지', '식기세척기', '토스터기', '캡슐커피머신', '전기포트', '제빙기', '조리도구', '기본조미료', '와인잔'],
    bath: ['샴푸', '컨디셔너', '바디워시', '핸드워시', '치약', '타월', '샤워가운'],
    general: ['TV', '냉장고', '세탁기', '헤어드라이어', '스피커', '슬리퍼', '생수'],
    baby: ['젖병소독기', '유아용 어메니티', '유아 샤워용품', '키즈가구']
  },
  kids: ['실내 키즈룸 (미끄럼틀, 놀이기구)', '야외 모래 놀이터', '미니 바이킹', '전 객실 키즈 어메니티'],
  pool: { depth: '약 70cm', note: '온수 풀 · 사계절 이용 · 시간 제한 없음 · 보호자 동반 필수' },
  bbq: { note: '무료 이용 · 전기그릴 기본 제공 · 시간 제한 없음', extra: '웨버 가스그릴 추가 가능 (유료)' },
  rules: ['전 공간 절대 금연', '실내 냄새나는 음식 조리 금지', '퇴실 전 정리 및 분리수거', '야간 소음 주의', '24개월 미만 영유아 무료', '기준인원 초과 시 1인 1박 30,000원']
};

function renderStaySection() {
  var s = STAY_DATA;
  var html = '<div id="stay" style="margin-top:20px">';

  // Section header
  html += '<div class="section-device">';
  html += '<div class="section-label">STAY</div>';
  html += '<div class="section-title">숙소 안내</div>';
  html += '<div class="section-subtitle">' + esc(s.name) + ' · 5박</div>';
  html += '</div>';

  // ── 기본 정보 카드 (기본 열림)
  html += '<details class="stay-card" open>';
  html += '<summary><div class="stay-card-title"><span class="stay-card-name">' + esc(s.name) + '</span><span class="stay-card-chevron">&#9654;</span></div>';
  html += '<div class="stay-card-sub">' + esc(s.desc) + '</div></summary>';
  html += '<div class="stay-body">';
  html += '<div class="practical-grid">';
  html += '<span class="practical-label">주소</span><span class="practical-value">' + esc(s.address) + '</span>';
  html += '<span class="practical-label">체크인</span><span class="practical-value">' + esc(s.checkin) + '</span>';
  html += '<span class="practical-label">체크아웃</span><span class="practical-value">' + esc(s.checkout) + '</span>';
  html += '<span class="practical-label">주차</span><span class="practical-value">' + esc(s.parking) + '</span>';
  html += '<span class="practical-label">연락처</span><span class="practical-value">' + esc(s.phone) + '</span>';
  html += '<span class="practical-label">인스타</span><span class="practical-value">' + esc(s.instagram) + '</span>';
  html += '</div>';
  html += '<div style="margin-top:10px; display:flex; gap:8px;">';
  html += '<a href="' + escAttr(s.mapUrl) + '" target="_blank" style="flex:1; text-align:center; padding:8px; font-size:13px; font-weight:600; color:var(--text-mid); border:1px solid var(--border); border-radius:var(--radius-btn); text-decoration:none; background:var(--housing);">지도 보기</a>';
  html += '<a href="' + escAttr(s.stayfolioUrl) + '" target="_blank" style="flex:1; text-align:center; padding:8px; font-size:13px; font-weight:600; color:#fff; border:none; border-radius:var(--radius-btn); text-decoration:none; background:var(--text);">스테이폴리오</a>';
  html += '</div>';
  html += '</div></details>';

  // ── 객실 정보
  html += '<details class="stay-card">';
  html += '<summary><div class="stay-card-title"><span class="stay-card-name">객실 정보</span><span class="stay-card-chevron">&#9654;</span></div>';
  html += '<div class="stay-card-sub">전 객실 복층 · 키즈룸 · 온수풀</div></summary>';
  html += '<div class="stay-body">';
  html += '<div class="stay-room-grid">';
  s.rooms.forEach(function(r) {
    html += '<div class="stay-room-chip">';
    html += '<div class="stay-room-label">' + esc(r.name) + '</div>';
    html += '<div class="stay-room-detail">' + esc(r.type) + '<br>' + esc(r.people) + '<br>' + esc(r.bed) + '<br>욕실 ' + esc(r.bath) + '</div>';
    html += '</div>';
  });
  html += '</div>';
  html += '<div class="practical-grid">';
  html += '<span class="practical-label">1층</span><span class="practical-value">거실 · 주방 · 키즈룸 · 세탁실 · BBQ · 풀장</span>';
  html += '<span class="practical-label">2층</span><span class="practical-value">침실 · 테라스 · 화장실/샤워실</span>';
  html += '<span class="practical-label">초과 요금</span><span class="practical-value">1인 1박 30,000원 (24개월 미만 무료)</span>';
  html += '</div>';
  html += '</div></details>';

  // ── 키즈 시설
  html += '<details class="stay-card">';
  html += '<summary><div class="stay-card-title"><span class="stay-card-name">키즈 시설</span><span class="stay-card-chevron">&#9654;</span></div>';
  html += '<div class="stay-card-sub">실내 키즈룸 + 야외 놀이터</div></summary>';
  html += '<div class="stay-body">';
  html += '<ul class="place-list">';
  s.kids.forEach(function(k) {
    html += '<li>' + esc(k) + '</li>';
  });
  html += '</ul>';
  html += '<div class="stay-highlight-box" style="margin-top:10px">';
  html += '<div class="stay-highlight-label">BABY AMENITY</div>';
  html += '<div class="stay-highlight-text">' + s.amenities.baby.map(esc).join(' · ') + '</div>';
  html += '</div>';
  html += '</div></details>';

  // ── 수영장 & BBQ
  html += '<details class="stay-card">';
  html += '<summary><div class="stay-card-title"><span class="stay-card-name">수영장 · BBQ</span><span class="stay-card-chevron">&#9654;</span></div>';
  html += '<div class="stay-card-sub">온수 풀 · 전기그릴 무료</div></summary>';
  html += '<div class="stay-body">';
  html += '<div class="place-section"><div class="place-section-label">POOL</div>';
  html += '<div class="practical-grid">';
  html += '<span class="practical-label">수심</span><span class="practical-value">' + esc(s.pool.depth) + '</span>';
  html += '<span class="practical-label">이용</span><span class="practical-value">' + esc(s.pool.note) + '</span>';
  html += '</div></div>';
  html += '<div class="place-section"><div class="place-section-label">BBQ</div>';
  html += '<div class="practical-grid">';
  html += '<span class="practical-label">기본</span><span class="practical-value">' + esc(s.bbq.note) + '</span>';
  html += '<span class="practical-label">추가</span><span class="practical-value">' + esc(s.bbq.extra) + '</span>';
  html += '</div></div>';
  html += '</div></details>';

  // ── 비품 & 어메니티
  html += '<details class="stay-card">';
  html += '<summary><div class="stay-card-title"><span class="stay-card-name">비품 · 어메니티</span><span class="stay-card-chevron">&#9654;</span></div>';
  html += '<div class="stay-card-sub">주방 · 욕실 · 일반</div></summary>';
  html += '<div class="stay-body">';
  var amenityGroups = [
    { label: 'KITCHEN', items: s.amenities.kitchen },
    { label: 'BATH', items: s.amenities.bath },
    { label: 'GENERAL', items: s.amenities.general }
  ];
  amenityGroups.forEach(function(g) {
    html += '<div class="place-section"><div class="place-section-label">' + g.label + '</div>';
    html += '<div class="stay-amenity-tags">';
    g.items.forEach(function(item) {
      html += '<span class="stay-amenity-tag">' + esc(item) + '</span>';
    });
    html += '</div></div>';
  });
  html += '</div></details>';

  // ── 이용 규칙
  html += '<details class="stay-card">';
  html += '<summary><div class="stay-card-title"><span class="stay-card-name">이용 규칙</span><span class="stay-card-chevron">&#9654;</span></div>';
  html += '<div class="stay-card-sub">숙소 이용 시 참고사항</div></summary>';
  html += '<div class="stay-body">';
  html += '<ul class="place-list">';
  s.rules.forEach(function(r) {
    html += '<li>' + esc(r) + '</li>';
  });
  html += '</ul>';
  html += '</div></details>';

  html += '</div>';
  return html;
}

// ═══ FOOTER ═══
function renderFooter() {
  var html = '<div class="footer">';
  html += '<a href="/" class="footer-link">일정 상세 보기 \u2192</a>';
  html += '<div class="footer-note">식당 별점·가격은 참고용이며 현장과 다를 수 있습니다</div>';
  html += '</div>';
  return html;
}

// ═══ SECTION NAV ═══
function scrollToSection(id) {
  var el = document.getElementById(id);
  if (el) {
    var offset = 60;
    var y = el.getBoundingClientRect().top + window.pageYOffset - offset;
    window.scrollTo({ top: y, behavior: 'smooth' });
  }
  // update active
  document.querySelectorAll('.section-nav-btn').forEach(function(btn) { btn.classList.remove('active'); });
  event.currentTarget.classList.add('active');
}

// Scroll spy for section nav
var spyTimer = null;
window.addEventListener('scroll', function() {
  // Scroll to top button
  var btn = document.getElementById('scrollTopBtn');
  if (window.scrollY > 400) btn.classList.add('visible');
  else btn.classList.remove('visible');

  // Section spy
  if (spyTimer) return;
  spyTimer = setTimeout(function() {
    spyTimer = null;
    var sections = ['overview', 'places', 'restaurants', 'stay'];
    var active = sections[0];
    sections.forEach(function(id) {
      var el = document.getElementById(id);
      if (el && el.getBoundingClientRect().top < 100) active = id;
    });
    var idx = sections.indexOf(active);
    document.querySelectorAll('.section-nav-btn').forEach(function(btn, i) {
      btn.classList.toggle('active', i === idx);
    });
  }, 100);
});

// ═══ UTILS ═══
function formatDate(dateStr) {
  var p = dateStr.split('-');
  return parseInt(p[1]) + '/' + parseInt(p[2]);
}

function formatPrice(n) {
  if (!n) return '';
  return n.toLocaleString() + '원';
}

function esc(str) {
  if (!str) return '';
  var d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function escAttr(str) {
  return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
