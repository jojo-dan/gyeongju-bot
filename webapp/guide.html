<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>경주 가족여행 가이드</title>
<meta property="og:title" content="경주 가족여행 가이드">
<meta property="og:description" content="2026.02.19~24 · 6일간의 식당·관광지 완벽 가이드">
<meta property="og:image" content="https://gyeongju-trip.vercel.app/og-image.png">
<meta property="og:url" content="https://gyeongju-trip.vercel.app/guide">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/earlyaccess/kopubbatang.css" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}

:root{
  --bg:#FAF7F2;
  --bg-warm:#F3EDE4;
  --card:#FFFFFF;
  --card-hover:#FDFCFA;
  --hero:#3D2E1F;
  --hero-text:#FAF7F2;
  --hero-dim:rgba(250,247,242,0.55);
  --accent:#C45D3E;
  --accent-soft:#E8896E;
  --accent-bg:rgba(196,93,62,0.08);
  --sage:#7B8F6B;
  --sage-bg:rgba(123,143,107,0.1);
  --blue:#4A6FA5;
  --blue-bg:rgba(74,111,165,0.08);
  --text:#2C2218;
  --text-mid:#5C4F42;
  --text-light:#8C7E72;
  --text-muted:#A89E94;
  --border:rgba(60,46,31,0.1);
  --border-strong:rgba(60,46,31,0.18);
  --serif:'Spectral','KoPub Batang',Georgia,serif;
  --body:'Spectral','KoPub Batang',Georgia,serif;
  --mono:'DM Mono','SF Mono',monospace;
  --r-card:20px;
  --r-btn:12px;
  --r-tag:6px;
  --shadow-card:0 1px 3px rgba(60,46,31,0.06),0 8px 24px rgba(60,46,31,0.04);
  --shadow-card-hover:0 2px 8px rgba(60,46,31,0.1),0 12px 32px rgba(60,46,31,0.06);
  --shadow-hero:0 4px 32px rgba(60,46,31,0.12);
}

:root[data-fontsize="small"] { --base-font: 14px; }
:root[data-fontsize="large"] { --base-font: 18px; }

html{scroll-behavior:smooth}

body{
  font-family:var(--body);
  font-size:var(--base-font, 16px);
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  -webkit-text-size-adjust:100%;
  overflow-x:hidden;
}

/* ═══ SUBTLE GRAIN TEXTURE ═══ */
body::before{
  content:'';
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:9999;
  opacity:0.03;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-repeat:repeat;
  background-size:256px;
}

/* ═══ DARK MODE ═══ */
[data-theme="dark"]{
  --bg:#1A1714;
  --bg-warm:#242019;
  --card:#2C261F;
  --card-hover:#332D25;
  --hero:#2C261F;
  --hero-text:#E8E0D6;
  --hero-dim:rgba(232,224,214,0.45);
  --accent:#E8896E;
  --accent-soft:#C45D3E;
  --accent-bg:rgba(232,137,110,0.15);
  --sage:#9AB089;
  --sage-bg:rgba(154,176,137,0.15);
  --blue:#7DA0CC;
  --blue-bg:rgba(125,160,204,0.12);
  --text:#E8E0D6;
  --text-mid:#B5AA9E;
  --text-light:#8C7E72;
  --text-muted:#6B5F54;
  --border:rgba(250,247,242,0.08);
  --border-strong:rgba(250,247,242,0.15);
  --shadow-card:0 1px 3px rgba(0,0,0,0.3),0 8px 24px rgba(0,0,0,0.2);
  --shadow-card-hover:0 2px 8px rgba(0,0,0,0.4),0 12px 32px rgba(0,0,0,0.25);
  --shadow-hero:0 4px 32px rgba(0,0,0,0.4);
}
@media(prefers-color-scheme:dark){
  :root:not([data-theme="light"]){
    --bg:#1A1714;
    --bg-warm:#242019;
    --card:#2C261F;
    --card-hover:#332D25;
    --hero:#2C261F;
    --hero-text:#E8E0D6;
    --hero-dim:rgba(232,224,214,0.45);
    --accent:#E8896E;
    --accent-soft:#C45D3E;
    --accent-bg:rgba(232,137,110,0.15);
    --sage:#9AB089;
    --sage-bg:rgba(154,176,137,0.15);
    --blue:#7DA0CC;
    --blue-bg:rgba(125,160,204,0.12);
    --text:#E8E0D6;
    --text-mid:#B5AA9E;
    --text-light:#8C7E72;
    --text-muted:#6B5F54;
    --border:rgba(250,247,242,0.08);
    --border-strong:rgba(250,247,242,0.15);
    --shadow-card:0 1px 3px rgba(0,0,0,0.3),0 8px 24px rgba(0,0,0,0.2);
    --shadow-card-hover:0 2px 8px rgba(0,0,0,0.4),0 12px 32px rgba(0,0,0,0.25);
    --shadow-hero:0 4px 32px rgba(0,0,0,0.4);
  }
}

/* ═══ THEME TOGGLE ═══ */
.theme-toggle{
  position:fixed;
  top:12px;
  right:16px;
  z-index:200;
  width:36px;height:36px;
  border-radius:50%;
  border:1.5px solid var(--border-strong);
  background:var(--card);
  color:var(--text-mid);
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  transition:all 0.2s;
}
.theme-toggle:active{transform:scale(0.9)}
.theme-toggle svg{width:16px;height:16px}

/* ═══ HEADER ═══ */
.header{
  padding:40px 24px 28px;
  text-align:center;
  position:relative;
}
.header::after{
  content:'';
  display:block;
  width:40px;
  height:2px;
  background:var(--accent);
  margin:20px auto 0;
  border-radius:1px;
}
.header h1{
  font-family:var(--serif);
  font-size:34px;
  font-weight:700;
  letter-spacing:-0.5px;
  color:var(--text);
  line-height:1.2;
}
.header .sub-info{
  font-family:var(--mono);
  font-size:12px;
  font-weight:400;
  color:var(--text-light);
  letter-spacing:1px;
  margin-top:10px;
  text-transform:uppercase;
}
.header .sub-detail{
  font-family:var(--body);
  font-size:14px;
  color:var(--text-mid);
  margin-top:4px;
  font-weight:500;
}
.daily-link{
  display:inline-flex;
  align-items:center;
  gap:6px;
  margin-top:16px;
  font-family:var(--body);
  font-size:13px;
  font-weight:600;
  color:var(--text-mid);
  text-decoration:none;
  border:1px solid var(--border-strong);
  border-radius:var(--r-btn);
  padding:8px 18px;
  background:var(--card);
  transition:all 0.2s;
}
.daily-link:active{transform:scale(0.97);opacity:0.8}
.daily-link svg{width:14px;height:14px}

/* ═══ CONTAINER ═══ */
.container{max-width:440px;margin:0 auto;padding:0 16px 40px}

/* ═══ SECTION NAV ═══ */
.section-nav{
  display:flex;
  gap:6px;
  max-width:440px;
  margin:0 auto 20px;
  padding:0 16px;
  position:sticky;
  top:0;
  z-index:100;
  background:linear-gradient(var(--bg),var(--bg) 85%,transparent);
  padding-top:10px;
  padding-bottom:14px;
}
.section-nav-btn{
  flex:1 1 0;
  padding:10px 0;
  font-family:var(--mono);
  font-size:11px;
  font-weight:500;
  color:var(--text-muted);
  background:transparent;
  border:1.5px solid var(--border);
  cursor:pointer;
  text-align:center;
  min-height:40px;
  border-radius:var(--r-btn);
  transition:all 0.25s cubic-bezier(0.4,0,0.2,1);
  letter-spacing:0.3px;
  text-transform:uppercase;
}
.section-nav-btn.active{
  background:var(--hero);
  color:var(--hero-text);
  border-color:var(--hero);
  box-shadow:0 2px 8px rgba(61,46,31,0.2);
}
.section-nav-btn:not(.active):active{
  background:var(--bg-warm);
}

/* ═══ SECTION HEADER ═══ */
.section-hero{
  background:var(--hero);
  border-radius:var(--r-card);
  box-shadow:var(--shadow-hero);
  padding:28px 22px;
  margin-bottom:16px;
  position:relative;
  overflow:hidden;
}
.section-hero::before{
  content:'';
  position:absolute;
  top:-20px;right:-20px;
  width:120px;height:120px;
  border-radius:50%;
  background:rgba(196,93,62,0.12);
  pointer-events:none;
}
.section-hero::after{
  content:'';
  position:absolute;
  bottom:-30px;left:-10px;
  width:80px;height:80px;
  border-radius:50%;
  background:rgba(123,143,107,0.08);
  pointer-events:none;
}
.section-label{
  font-family:var(--mono);
  font-size:11px;
  font-weight:500;
  color:var(--accent-soft);
  letter-spacing:2px;
  text-transform:uppercase;
  margin-bottom:10px;
}
.section-title{
  font-family:var(--serif);
  font-size:26px;
  font-weight:700;
  color:var(--hero-text);
  letter-spacing:-0.3px;
  line-height:1.25;
}
.section-subtitle{
  font-family:var(--body);
  font-size:13px;
  color:var(--hero-dim);
  margin-top:6px;
  font-weight:400;
}

/* ═══ CARD (shared) ═══ */
.card{
  background:var(--card);
  border-radius:var(--r-card);
  box-shadow:var(--shadow-card);
  margin-bottom:12px;
  overflow:hidden;
  transition:box-shadow 0.3s;
}
.card[open]{box-shadow:var(--shadow-card-hover)}
.card>summary{
  list-style:none;
  cursor:pointer;
  user-select:none;
  padding:16px 20px;
  transition:background 0.15s;
}
.card>summary::-webkit-details-marker{display:none}
.card>summary:active{background:var(--bg-warm)}
.card-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.card-name{
  font-family:var(--body);
  font-size:calc(var(--base-font, 16px) + 2px);
  font-weight:700;
  color:var(--text);
  line-height:1.3;
  flex:1;
  min-width:0;
}
.card-chevron{
  width:20px;height:20px;
  display:flex;align-items:center;justify-content:center;
  color:var(--text-muted);
  transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);
  flex-shrink:0;
  margin-left:12px;
}
.card-chevron svg{width:12px;height:12px}
.card[open] .card-chevron{transform:rotate(90deg)}
.card-sub{
  font-family:var(--body);
  font-size:13px;
  color:var(--text-light);
  margin-top:3px;
  line-height:1.4;
}
.card-body{
  border-top:1px solid var(--border);
  margin:0 20px;
  padding:16px 0 18px;
}

/* ═══ FADE IN ANIMATION ═══ */
.fade-up{
  opacity:0;
  transform:translateY(16px);
  animation:fadeUp 0.5s cubic-bezier(0.4,0,0.2,1) forwards;
}
@keyframes fadeUp{
  to{opacity:1;transform:translateY(0)}
}

/* ═══ DAY OVERVIEW ═══ */
.day-num{
  font-family:var(--mono);
  font-size:11px;
  font-weight:500;
  color:var(--accent);
  letter-spacing:1px;
  text-transform:uppercase;
}
.day-date{
  font-family:var(--mono);
  font-size:11px;
  color:var(--text-muted);
}
.day-title{
  font-family:var(--body);
  font-size:18px;
  font-weight:700;
  color:var(--text);
  margin-top:5px;
  line-height:1.3;
}
.day-keyword{
  font-family:var(--body);
  font-size:13px;
  color:var(--text-light);
  margin-top:2px;
}
.day-items{
  padding:0 20px 16px;
  display:flex;flex-direction:column;gap:8px;
  border-top:1px solid var(--border);
  margin:0 0 0 0;
  padding-top:14px;
}
.day-item{
  display:flex;align-items:center;gap:10px;
  font-size:14px;color:var(--text-mid);
  line-height:1.4;
}
.day-item-icon{
  width:28px;height:28px;
  display:flex;align-items:center;justify-content:center;
  border-radius:8px;
  background:var(--bg-warm);
  flex-shrink:0;
  font-size:14px;
}
.day-item-text{flex:1}
.day-item-text b{color:var(--text);font-weight:600}
.tag{
  font-family:var(--mono);
  font-size:10px;
  font-weight:500;
  padding:3px 8px;
  border-radius:var(--r-tag);
  flex-shrink:0;
  letter-spacing:0.3px;
}
.tag-chosen{background:var(--sage-bg);color:var(--sage)}
.tag-optional{background:var(--bg-warm);color:var(--text-light)}

/* ═══ PLACE GUIDE ═══ */
.place-section{padding:0 0 14px}
.place-section-label{
  font-family:var(--mono);
  font-size:10px;
  font-weight:500;
  color:var(--accent);
  letter-spacing:1.5px;
  text-transform:uppercase;
  margin-bottom:8px;
}
.place-list{list-style:none}
.place-list li{
  font-size:14px;
  color:var(--text-mid);
  padding:5px 0 5px 14px;
  position:relative;
  line-height:1.55;
}
.place-list li::before{
  content:'';
  position:absolute;left:0;top:13px;
  width:5px;height:5px;
  border-radius:50%;
  background:var(--accent-soft);
}

.baby-tip{
  background:var(--blue-bg);
  border-radius:12px;
  padding:14px 16px;
  margin-bottom:10px;
}
.baby-tip-label{
  font-family:var(--mono);
  font-size:10px;
  font-weight:500;
  color:var(--blue);
  letter-spacing:1px;
  text-transform:uppercase;
  margin-bottom:5px;
}
.baby-tip-text{
  font-size:13px;
  color:var(--text);
  line-height:1.55;
}

.info-grid{
  display:grid;
  grid-template-columns:auto 1fr;
  gap:6px 12px;
  font-size:13px;
}
.info-label{color:var(--text-light);font-weight:600;white-space:nowrap}
.info-value{color:var(--text-mid);line-height:1.4}

/* ═══ RESTAURANT SUB TABS ═══ */
.rest-sub-tabs {
  display: flex;
  gap: 6px;
  padding: 0 16px 12px;
  max-width: 440px;
  margin: 0 auto;
}
.rest-sub-tab {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  padding: 6px 12px;
  border-radius: 10px;
  border: 1.5px solid var(--border);
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.2s;
}
.rest-sub-tab.active {
  background: var(--hero);
  color: var(--hero-text);
  border-color: var(--hero);
}

/* ═══ RESTAURANT ═══ */
.sort-bar{
  display:flex;gap:8px;
  margin-bottom:16px;
}
.sort-btn{
  flex:1;
  padding:10px 0;
  font-family:var(--mono);
  font-size:11px;
  font-weight:500;
  color:var(--text-muted);
  background:var(--card);
  border:1.5px solid var(--border);
  cursor:pointer;
  text-align:center;
  border-radius:var(--r-btn);
  transition:all 0.25s;
  letter-spacing:0.3px;
  text-transform:uppercase;
}
.sort-btn.active{
  background:var(--hero);
  color:var(--hero-text);
  border-color:var(--hero);
  box-shadow:0 2px 8px rgba(61,46,31,0.15);
}

.rest-rating{
  font-family:var(--mono);
  font-size:14px;
  font-weight:500;
  color:var(--accent);
  margin-left:8px;
  flex-shrink:0;
}
.rest-meta{
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  font-size:calc(var(--base-font, 16px) - 3px);color:var(--text-light);margin-top:4px;
}
.rest-menu-brief{color:var(--text-mid)}
.open-tag{
  font-family:var(--mono);
  font-size:10px;
  font-weight:500;
  padding:3px 8px;
  border-radius:var(--r-tag);
  letter-spacing:0.3px;
}
.open-tag.open{background:var(--sage-bg);color:var(--sage)}
.open-tag.closed{background:rgba(196,62,62,0.08);color:#B04040}
.rest-dist{
  font-family:var(--mono);
  font-size:11px;
  color:var(--text-muted);
}

.rest-info{font-size:13px;color:var(--text-mid);padding:3px 0}
.rest-info-label{font-weight:600;color:var(--text-light);margin-right:6px}

.badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:var(--r-tag);
  font-size:11px;
  font-weight:600;
  letter-spacing:0.2px;
}
.badge-dad-good{background:var(--sage-bg);color:var(--sage)}
.badge-dad-caution{background:var(--accent-bg);color:var(--accent)}
.badge-hiro-good{background:var(--blue-bg);color:var(--blue)}
.badge-hiro-caution{background:rgba(196,62,62,0.08);color:#B04040}

.rest-meals{
  margin-top:10px;
  font-family:var(--mono);
  font-size:11px;
  color:var(--text-muted);
  letter-spacing:0.3px;
}
.rest-map-link{
  display:inline-flex;align-items:center;gap:4px;
  margin-top:10px;
  font-size:12px;font-weight:600;
  color:var(--accent);
  text-decoration:none;
  border-bottom:1px solid var(--accent-bg);
  padding-bottom:2px;
  transition:opacity 0.15s;
}
.rest-map-link:active{opacity:0.6}

/* ═══ STAY ═══ */
.stay-room-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  margin-bottom:16px;
}
.stay-room-chip{
  background:var(--bg-warm);
  border-radius:12px;
  padding:14px 10px;
  text-align:center;
}
.stay-room-label{
  font-family:var(--mono);
  font-size:14px;
  font-weight:500;
  color:var(--text);
}
.stay-room-detail{
  font-size:11px;
  color:var(--text-light);
  margin-top:4px;
  line-height:1.4;
}

.amenity-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.amenity-tag{
  font-size:12px;
  color:var(--text-mid);
  background:var(--bg-warm);
  border-radius:var(--r-tag);
  padding:5px 10px;
}

.highlight-box{
  background:var(--accent-bg);
  border-radius:12px;
  padding:14px 16px;
  margin-bottom:10px;
}
.highlight-label{
  font-family:var(--mono);
  font-size:10px;
  font-weight:500;
  color:var(--accent);
  letter-spacing:1px;
  text-transform:uppercase;
  margin-bottom:5px;
}
.highlight-text{
  font-size:13px;
  color:var(--text);
  line-height:1.55;
}

.link-row{
  display:flex;gap:8px;margin-top:12px;
}
.link-btn{
  flex:1;
  display:flex;align-items:center;justify-content:center;gap:6px;
  padding:11px 8px;
  font-size:13px;
  font-weight:600;
  text-decoration:none;
  border-radius:var(--r-btn);
  transition:all 0.2s;
}
.link-btn:active{transform:scale(0.97)}
.link-btn-outline{
  color:var(--text-mid);
  border:1.5px solid var(--border-strong);
  background:var(--card);
}
.link-btn-solid{
  color:#fff;
  border:none;
  background:var(--hero);
  box-shadow:0 2px 8px rgba(61,46,31,0.15);
}

/* ═══ FOOTER ═══ */
.footer{text-align:center;padding:24px 16px 48px}
.footer-cta{
  display:inline-flex;align-items:center;gap:8px;
  font-size:14px;font-weight:700;
  color:#fff;
  background:var(--hero);
  border-radius:var(--r-btn);
  padding:14px 28px;
  text-decoration:none;
  box-shadow:0 4px 16px rgba(61,46,31,0.18);
  transition:all 0.2s;
}
.footer-cta:active{transform:scale(0.97);opacity:0.9}
.footer-note{
  font-family:var(--mono);
  font-size:11px;
  color:var(--text-muted);
  margin-top:14px;
  letter-spacing:0.3px;
}

/* ═══ SCROLL TOP ═══ */
.scroll-top{
  position:fixed;bottom:24px;right:20px;
  width:44px;height:44px;
  border-radius:50%;
  background:var(--hero);
  color:var(--hero-text);
  border:none;
  font-size:18px;
  cursor:pointer;
  box-shadow:0 4px 16px rgba(61,46,31,0.25);
  opacity:0;
  transition:all 0.3s;
  pointer-events:none;
  z-index:200;
}
.scroll-top.visible{opacity:1;pointer-events:auto}
.scroll-top:active{transform:scale(0.9)}

/* ═══ LOADING ═══ */
.loading{
  text-align:center;
  padding:80px 20px;
  color:var(--text-light);
  font-size:14px;
}
.loading .spinner{
  display:inline-block;
  width:28px;height:28px;
  border:2px solid var(--border);
  border-top-color:var(--accent);
  border-radius:50%;
  animation:spin 0.8s linear infinite;
  margin-bottom:14px;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ═══ SEARCH TRIGGER ═══ */
.search-trigger {
  position: fixed;
  top: 12px;
  right: 104px;
  z-index: 200;
  width: 36px; height: 36px; border-radius: 50%;
  border: 1.5px solid var(--border-strong);
  background: var(--card);
  color: var(--text-mid);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: all 0.2s;
}
.search-trigger:active { transform: scale(0.9); }
.search-trigger.active {
  background: var(--hero);
  color: var(--hero-text);
  border-color: var(--hero);
}
.search-trigger svg { width: 16px; height: 16px; }

/* ═══ FONT SIZE TRIGGER ═══ */
.font-size-trigger {
  position: fixed;
  top: 12px;
  right: 60px;
  z-index: 200;
  width: 36px; height: 36px; border-radius: 50%;
  border: 1.5px solid var(--border-strong);
  background: var(--card);
  color: var(--text-mid);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: all 0.2s;
  font-family: var(--serif);
  font-size: 14px;
  font-weight: 700;
}
.font-size-trigger:active { transform: scale(0.9); }

/* ═══ SEARCH BAR ═══ */
.search-bar-wrapper {
  max-width: 440px;
  margin: 0 auto;
  padding: 0 16px;
  max-height: 0;
  overflow: hidden;
  opacity: 0;
  transition: max-height 0.35s cubic-bezier(0.4,0,0.2,1),
              opacity 0.25s ease;
}
.search-bar-wrapper.open {
  max-height: 120px;
  opacity: 1;
  padding-bottom: 4px;
}

.search-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--card);
  border: 1.5px solid var(--border-strong);
  border-radius: 20px;
  padding: 12px 18px;
  box-shadow: var(--shadow-card);
}
.search-bar input {
  flex: 1; border: none; outline: none; background: transparent;
  font-family: var(--serif);
  font-size: 16px;
  color: var(--text);
  opacity: 0.4;
  pointer-events: none;
}
.search-bar input::placeholder {
  color: var(--text-muted);
  font-style: italic;
  font-weight: 300;
}

/* ═══ FILTER CHIPS ═══ */
.search-filters {
  display: flex;
  gap: 6px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  padding: 8px 16px 12px;
  max-width: 440px;
  margin: 0 auto;
}
.search-filters::-webkit-scrollbar { display: none; }

.filter-chip {
  flex-shrink: 0;
  font-family: var(--mono);
  font-size: 11px; font-weight: 500;
  letter-spacing: 0.3px;
  padding: 8px 14px;
  border-radius: 12px;
  border: 1.5px solid var(--border);
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
  white-space: nowrap;
}
.filter-chip.active {
  background: var(--hero);
  color: var(--hero-text);
  border-color: var(--hero);
  box-shadow: 0 2px 8px rgba(61,46,31,0.15);
}

/* ═══ FILTER RESULT COUNT ═══ */
.filter-result-count {
  max-width: 440px;
  margin: 0 auto;
  padding: 0 16px 8px;
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 0.3px;
  display: none;
}
.filter-result-count.visible { display: block; }

/* ═══ SEARCH EMPTY STATE ═══ */
.search-empty {
  text-align: center;
  padding: 48px 24px;
  display: none;
}
.search-empty.visible { display: block; }
.search-empty::before {
  content: '';
  display: block; width: 40px; height: 2px;
  background: var(--accent);
  margin: 0 auto 20px; border-radius: 1px;
}
.search-empty-title {
  font-family: var(--serif);
  font-size: 20px; font-weight: 600;
  color: var(--text);
  font-style: italic;
  margin-bottom: 8px;
}
.search-empty-desc {
  font-size: 14px;
  color: var(--text-light);
  line-height: 1.6;
}

/* ═══ CHAT BUBBLE & SHEET ═══ */
.chat-fab {
  position: fixed; bottom: 24px; right: 20px; z-index: 300;
  width: 52px; height: 52px; border-radius: 50%;
  background: var(--accent); color: #fff; border: none;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 16px rgba(196,93,62,0.35);
  transition: transform 0.2s, box-shadow 0.2s;
}
.chat-fab:active { transform: scale(0.9); }
.chat-fab svg { width: 24px; height: 24px; }
.chat-fab.hidden { display: none; }

.chat-overlay {
  position: fixed; inset: 0; z-index: 400;
  background: rgba(0,0,0,0.3); backdrop-filter: blur(2px);
  opacity: 0; pointer-events: none; transition: opacity 0.25s;
}
.chat-overlay.open { opacity: 1; pointer-events: auto; }

.chat-sheet {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 401;
  max-width: 480px; margin: 0 auto;
  height: 65vh; max-height: 520px;
  background: var(--bg);
  border-radius: 20px 20px 0 0;
  box-shadow: 0 -4px 32px rgba(0,0,0,0.12);
  display: flex; flex-direction: column;
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
}
.chat-sheet.open { transform: translateY(0); }

.chat-sheet-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 20px 12px;
  border-bottom: 1px solid var(--border);
}
.chat-sheet-title {
  font-family: var(--serif); font-size: 16px; font-weight: 600;
  color: var(--text);
}
.chat-sheet-subtitle {
  font-family: var(--mono); font-size: 11px;
  color: var(--text-muted); margin-top: 2px;
}
.chat-close-btn {
  width: 32px; height: 32px; border-radius: 50%;
  border: 1px solid var(--border); background: var(--card);
  color: var(--text-mid); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}

.chat-messages {
  flex: 1; overflow-y: auto; padding: 16px 16px 8px;
  display: flex; flex-direction: column; gap: 10px;
  -webkit-overflow-scrolling: touch;
}

.chat-msg {
  max-width: 85%; padding: 10px 14px;
  border-radius: 16px; font-size: 14px; line-height: 1.55;
  font-family: var(--serif); word-break: break-word;
}
.chat-msg.user {
  align-self: flex-end;
  background: var(--accent); color: #fff;
  border-bottom-right-radius: 4px;
}
.chat-msg.bot {
  align-self: flex-start;
  background: var(--card); color: var(--text);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}
.chat-msg.bot .msg-label {
  font-family: var(--mono); font-size: 10px;
  color: var(--accent); margin-bottom: 4px; font-weight: 500;
}
.chat-msg.typing .dots span {
  display: inline-block; width: 6px; height: 6px;
  background: var(--text-muted); border-radius: 50%;
  margin: 0 2px; animation: dotBounce 1.2s infinite;
}
.chat-msg.typing .dots span:nth-child(2) { animation-delay: 0.2s; }
.chat-msg.typing .dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes dotBounce {
  0%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-6px); }
}

.chat-msg.error {
  align-self: center; max-width: 90%;
  background: rgba(196,93,62,0.08); color: var(--accent);
  font-size: 12px; text-align: center;
  border-radius: 10px; border: 1px solid rgba(196,93,62,0.15);
}

.chat-input-row {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 16px 14px;
  border-top: 1px solid var(--border);
  background: var(--bg);
}
.chat-input {
  flex: 1; border: 1.5px solid var(--border-strong);
  border-radius: 20px; padding: 10px 16px;
  font-family: var(--serif); font-size: 14px;
  background: var(--card); color: var(--text);
  outline: none; resize: none; max-height: 80px;
}
.chat-input:focus { border-color: var(--accent); }
.chat-input::placeholder { color: var(--text-muted); }
.chat-send-btn {
  width: 38px; height: 38px; border-radius: 50%;
  background: var(--accent); color: #fff; border: none;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: opacity 0.15s;
  flex-shrink: 0;
}
.chat-send-btn:disabled { opacity: 0.4; cursor: default; }
.chat-send-btn svg { width: 18px; height: 18px; }

.chat-welcome {
  text-align: center; padding: 32px 20px;
  color: var(--text-mid); font-family: var(--serif);
}
.chat-welcome-icon { font-size: 32px; margin-bottom: 12px; }
.chat-welcome-title { font-size: 15px; font-weight: 600; margin-bottom: 6px; color: var(--text); }
.chat-welcome-desc { font-size: 13px; line-height: 1.6; }
.chat-welcome-hints {
  display: flex; flex-wrap: wrap; gap: 6px;
  justify-content: center; margin-top: 16px;
}
.chat-hint-chip {
  font-family: var(--mono); font-size: 11px;
  padding: 6px 12px; border-radius: 20px;
  background: var(--card); border: 1px solid var(--border-strong);
  color: var(--text-mid); cursor: pointer;
  transition: all 0.15s;
}
.chat-hint-chip:hover { background: var(--accent-bg); color: var(--accent); border-color: var(--accent); }
</style>
</head>
<body>

<button class="search-trigger" id="searchTrigger" onclick="toggleSearch()" aria-label="검색/필터">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
</button>

<button class="font-size-trigger" id="fontSizeTrigger" onclick="cycleFontSize()" aria-label="글자 크기">가</button>

<button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="테마 전환">
  <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
</button>

<div class="header">
  <h1>경주 가족여행<br>가이드</h1>
  <div class="sub-info">2026.02.19 thu — 02.24 tue</div>
  <div class="sub-detail">5박 6일 · 까사멜로우</div>
  <a href="/" class="daily-link">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
    일정 상세 보기
  </a>
</div>

<div class="section-nav">
  <button class="section-nav-btn active" onclick="scrollToSection('places')">장소</button>
  <button class="section-nav-btn" onclick="scrollToSection('restaurants')">식당</button>
  <button class="section-nav-btn" onclick="scrollToSection('stay')">숙소</button>
</div>

<div class="search-bar-wrapper" id="searchBarWrapper">
  <div class="search-bar">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
    <input type="text" placeholder="검색은 2차에 추가 예정..." disabled>
  </div>
  <div class="search-filters" id="searchFilters">
    <button class="filter-chip" data-filter="hiro" onclick="toggleFilter(this)">아이 OK</button>
    <button class="filter-chip" data-filter="dad" onclick="toggleFilter(this)">아빠 OK</button>
    <button class="filter-chip" data-filter="cafe" onclick="toggleFilter(this)">카페</button>
    <button class="filter-chip" data-filter="korean" onclick="toggleFilter(this)">한식</button>
    <button class="filter-chip" data-filter="nursing" onclick="toggleFilter(this)">수유실</button>
    <button class="filter-chip" data-filter="stroller" onclick="toggleFilter(this)">유모차</button>
    <button class="filter-chip" data-filter="open" onclick="toggleFilter(this)">영업중</button>
  </div>
</div>
<div class="filter-result-count" id="filterResultCount"></div>

<div class="container">
  <div id="contentArea">
    <div class="loading">
      <div class="spinner"></div>
      <div>가이드 불러오는 중...</div>
    </div>
  </div>
</div>

<button class="scroll-top" id="scrollTopBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})">&#8593;</button>

<script>
let travelData = null;

(async function init() {
  try {
    const res = await fetch('/api/data');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    travelData = json.record;
    render();
  } catch (e) {
    document.getElementById('contentArea').innerHTML =
      '<div class="loading" style="color:var(--accent)">데이터를 불러올 수 없습니다.<br>새로고침해 주세요.</div>';
  }
})();

function render() {
  if (!travelData) return;
  let html = '';
  html += renderPlaces(travelData.days);
  html += renderRestaurants(travelData.days);
  html += renderStay();
  html += renderFooter();
  document.getElementById('contentArea').innerHTML = html;
  applyFilters();
}

// ═══ ① OVERVIEW ═══
function renderOverview(days) {
  var html = '<div id="overview">';
  html += '<div class="section-hero fade-up">';
  html += '<div class="section-label">Overview</div>';
  html += '<div class="section-title">일정 한눈에 보기</div>';
  html += '<div class="section-subtitle">6일간의 여행 요약</div>';
  html += '</div>';

  days.forEach(function(day, i) {
    html += '<details class="card fade-up" style="animation-delay:' + (i * 0.06) + 's">';
    html += '<summary>';
    html += '<div class="card-top">';
    html += '<div><span class="day-num">Day ' + day.dayNum + '</span>';
    html += '<span class="day-date" style="margin-left:8px">' + formatDate(day.date) + ' ' + day.dow + '</span></div>';
    html += '<div class="card-chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 5l7 7-7 7"/></svg></div>';
    html += '</div>';
    html += '<div class="day-title">' + esc(day.title) + '</div>';
    if (day.keyword) html += '<div class="day-keyword">' + esc(day.keyword) + '</div>';
    html += '</summary>';
    html += '<div class="day-items">';
    day.items.forEach(function(item) {
      var icon = item.cat === 'meal' ? '\uD83C\uDF7D' : item.cat === 'cafe' ? '\u2615' : '\uD83C\uDFDB';
      html += '<div class="day-item">';
      html += '<span class="day-item-icon">' + icon + '</span>';
      html += '<span class="day-item-text">' + esc(item.title);
      if (item.options && item.options.length > 0 && item.chosen) {
        html += ' <b>' + esc(item.chosen) + '</b>';
      }
      html += '</span>';
      if (item.chosen) html += '<span class="tag tag-chosen">확정</span>';
      if (item.optional) html += '<span class="tag tag-optional">선택</span>';
      html += '</div>';
    });
    html += '</div></details>';
  });
  html += '</div>';
  return html;
}

// ═══ ② PLACES ═══
function renderPlaces(days) {
  var html = '<div id="places" style="margin-top:28px">';
  html += '<div class="section-hero fade-up">';
  html += '<div class="section-label">Places</div>';
  html += '<div class="section-title">장소 가이드</div>';
  html += '<div class="section-subtitle">주요 관광지 · 아이 동반 팁</div>';
  html += '</div>';

  var seen = {};
  var places = [];
  days.forEach(function(day) {
    day.items.forEach(function(item) {
      if (item.cat === 'activity' && item.guide && !seen[item.id]) {
        seen[item.id] = true;
        places.push(item);
      }
    });
  });

  // 하드코딩 추가 장소 (홈플러스, 소아과)
  var extraPlaces = [
    {
      title: '홈플러스 경주점',
      id: 'extra_homeplus',
      cat: 'activity',
      guide: {
        subtitle: '경주 유일의 대형 할인점 · 2024 메가푸드마켓 리뉴얼',
        mustDo: ['BBQ 식재료·간식·음료 장보기', '아기 간식·이유식 재료 확보'],
        babyTips: {
          stroller: '단층 매장이라 유모차 이동 편리',
          nursingRoom: '매장 내 수유실 (전화확인: 054-770-8000)',
          restSpots: ['수퍼윙스 키즈카페 (1층)']
        },
        practicalInfo: {
          hours: '09:00~22:00',
          parking: '1층 고객주차장 + 2층 옥상주차장 (유료, 구매시 무료)',
          phone: '054-770-8000',
          closedDays: '매월 둘째·넷째 일요일 (\u26A0\uFE0F 2/22 휴무!)',
          address: '경상북도 경주시 공단로 97',
          fromAccommodation: '까사멜로우에서 차량 약 15분',
          mapUrl: 'https://map.naver.com/p/search/홈플러스%20경주점'
        }
      }
    },
    {
      title: '사랑의 소아과의원',
      id: 'extra_clinic',
      cat: 'activity',
      guide: {
        subtitle: '아이 아플 때 대비 — 소아청소년과 전문의',
        mustDo: ['방문 전 반드시 전화 확인 (임시 휴진 가능)', '야간/공휴일: E-GEN 앱에서 당일 진료 병원 검색'],
        babyTips: {},
        practicalInfo: {
          address: '경상북도 경주시 황성로 59, 2층',
          phone: '054-773-7740',
          hours: '평일 09:00~18:00 (추정), 토 09:00~13:00',
          closedDays: '일요일·공휴일 휴진',
          mapUrl: 'https://naver.me/GJrFT2S7'
        }
      }
    }
  ];
  extraPlaces.forEach(function(ep) {
    if (!seen[ep.id]) {
      seen[ep.id] = true;
      places.push(ep);
    }
  });

  places.forEach(function(item, i) {
    var g = item.guide;
    var hasNursing = (g.babyTips && g.babyTips.nursingRoom) ? '1' : '';
    var hasStroller = (g.babyTips && g.babyTips.stroller) ? '1' : '';
    var hasBabyTips = (g.babyTips) ? '1' : '';
    html += '<details class="card fade-up" data-section="places"';
    html += ' data-nursing="' + hasNursing + '"';
    html += ' data-stroller="' + hasStroller + '"';
    html += ' data-babytips="' + hasBabyTips + '"';
    html += ' style="animation-delay:' + (i * 0.05) + 's">';
    html += '<summary>';
    html += '<div class="card-top">';
    html += '<span class="card-name">' + esc(item.title) + '</span>';
    html += '<div class="card-chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 5l7 7-7 7"/></svg></div>';
    html += '</div>';
    if (g.subtitle) html += '<div class="card-sub">' + esc(g.subtitle) + '</div>';
    html += '</summary>';
    html += '<div class="card-body">';

    if (g.mustDo && g.mustDo.length > 0) {
      html += '<div class="place-section">';
      html += '<div class="place-section-label">Must-Do</div>';
      html += '<ul class="place-list">';
      g.mustDo.forEach(function(m) { html += '<li>' + esc(m) + '</li>'; });
      html += '</ul></div>';
    }

    if (g.babyTips) {
      var bt = g.babyTips;
      html += '<div class="place-section">';
      html += '<div class="place-section-label">아이 동반 팁</div>';
      if (bt.stroller) {
        html += '<div class="baby-tip"><div class="baby-tip-label">유모차</div>';
        html += '<div class="baby-tip-text">' + esc(bt.stroller) + '</div></div>';
      }
      if (bt.restSpots && bt.restSpots.length > 0) {
        html += '<div class="baby-tip"><div class="baby-tip-label">쉴 곳</div>';
        bt.restSpots.forEach(function(s) { html += '<div class="baby-tip-text">' + esc(s) + '</div>'; });
        html += '</div>';
      }
      if (bt.restroom) {
        html += '<div class="baby-tip"><div class="baby-tip-label">화장실</div>';
        html += '<div class="baby-tip-text">' + esc(bt.restroom) + '</div></div>';
      }
      if (bt.nursingRoom) {
        html += '<div class="baby-tip"><div class="baby-tip-label">수유실</div>';
        html += '<div class="baby-tip-text">' + esc(bt.nursingRoom) + '</div></div>';
      }
      if (bt.recommendedRoute) {
        html += '<div class="baby-tip"><div class="baby-tip-label">추천 동선</div>';
        html += '<div class="baby-tip-text">' + esc(bt.recommendedRoute) + '</div></div>';
      }
      html += '</div>';
    }

    if (g.practicalInfo) {
      var pi = g.practicalInfo;
      html += '<div class="place-section">';
      html += '<div class="place-section-label">실용 정보</div>';
      html += '<div class="info-grid">';
      if (pi.address) html += '<span class="info-label">주소</span><span class="info-value">' + esc(pi.address) + '</span>';
      if (pi.phone) html += '<span class="info-label">전화</span><span class="info-value">' + esc(pi.phone) + '</span>';
      if (pi.fee) html += '<span class="info-label">입장료</span><span class="info-value">' + esc(pi.fee) + '</span>';
      if (pi.hours) html += '<span class="info-label">운영시간</span><span class="info-value">' + esc(pi.hours) + '</span>';
      if (pi.parking) html += '<span class="info-label">주차</span><span class="info-value">' + esc(pi.parking) + '</span>';
      if (pi.timeNeeded) html += '<span class="info-label">소요시간</span><span class="info-value">' + esc(pi.timeNeeded) + '</span>';
      if (pi.fromAccommodation) html += '<span class="info-label">숙소에서</span><span class="info-value">' + esc(pi.fromAccommodation) + '</span>';
      if (pi.closedDays) html += '<span class="info-label">휴무</span><span class="info-value">' + esc(pi.closedDays) + '</span>';
      html += '</div>';
      if (pi.mapUrl) {
        html += '<a class="rest-map-link" href="' + escAttr(pi.mapUrl) + '" target="_blank" rel="noopener">';
        html += '지도에서 보기';
        html += '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M7 17L17 7M17 7H7M17 7v10"/></svg>';
        html += '</a>';
      }
      html += '</div>';
    }
    html += '</div></details>';
  });

  html += '</div>';
  return html;
}

// ═══ ③ RESTAURANTS ═══
var allRestaurants = [];
var restSortMode = 'rating';
var restTypeFilter = 'all';
var userLat = null, userLng = null;

(function() {
  var params = new URLSearchParams(location.search);
  if (params.get('testloc') === '1') {
    userLat = 35.8579382;
    userLng = 129.262038;
    restSortMode = 'distance';
  }
})();

function extractRestaurants(days) {
  var map = {};
  days.forEach(function(day) {
    day.items.forEach(function(item) {
      if (item.cat !== 'meal' && item.cat !== 'cafe') return;
      if (!item.options) return;
      item.options.forEach(function(opt) {
        var key = opt.name;
        if (!key) return;
        if (!map[key]) {
          map[key] = {
            name:opt.name, menu:opt.menu||opt.desc||'', hours:opt.hours||'',
            loc:opt.loc||'', lat:opt.lat||null, lng:opt.lng||null,
            dad:opt.dad||'', dadNote:opt.dadNote||'', hiro:opt.hiro||'', hiroNote:opt.hiroNote||'',
            rating:opt.rating||null, ratingSource:opt.ratingSource||'',
            priceRange:opt.priceRange||'', menuDetail:opt.menuDetail||null,
            mapUrl:opt.mapUrl||'', category:opt.category||'', cat:item.cat,
            type: item.cat === 'cafe' ? 'cafe' : 'meal',
            meals:[], distKm:null
          };
        }
        map[key].meals.push('Day ' + day.dayNum + ' ' + (item.time || ''));
        if (!map[key].hours && opt.hours) map[key].hours = opt.hours;
        if (!map[key].lat && opt.lat) { map[key].lat = opt.lat; map[key].lng = opt.lng; }
        if (!map[key].rating && opt.rating) map[key].rating = opt.rating;
        if (opt.dad === 'good') map[key].dad = 'good';
        if (opt.hiro === 'good') map[key].hiro = 'good';
      });
    });
  });
  return Object.values(map);
}

function sortRestaurants(list) {
  if (restSortMode === 'distance' && userLat) {
    list.forEach(function(r) { r.distKm = (r.lat && r.lng) ? haversineKm(userLat, userLng, r.lat, r.lng) : 9999; });
    list.sort(function(a, b) { return a.distKm - b.distKm; });
  } else {
    list.sort(function(a, b) {
      var ra = a.rating || 0, rb = b.rating || 0;
      if (rb !== ra) return rb - ra;
      return a.name.localeCompare(b.name);
    });
  }
  return list;
}

function haversineKm(lat1, lng1, lat2, lng2) {
  var R = 6371;
  var dLat = (lat2 - lat1) * Math.PI / 180;
  var dLng = (lng2 - lng1) * Math.PI / 180;
  var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)*Math.sin(dLng/2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function parseOpenClosed(hoursStr) {
  if (!hoursStr) return { status: 'unknown', label: '' };
  var m = hoursStr.match(/(\d{1,2}):?(\d{2})?\s*[~\-]\s*(\d{1,2}):?(\d{2})?/);
  if (!m) return { status: 'unknown', label: hoursStr };
  var now = new Date();
  var nowMin = now.getHours()*60 + now.getMinutes();
  var openMin = parseInt(m[1])*60 + (m[2]?parseInt(m[2]):0);
  var closeMin = parseInt(m[3])*60 + (m[4]?parseInt(m[4]):0);
  return nowMin >= openMin && nowMin < closeMin
    ? { status: 'open', label: '영업 중' }
    : { status: 'closed', label: '영업 종료' };
}

function renderRestaurants(days) {
  allRestaurants = extractRestaurants(days);
  allRestaurants = sortRestaurants(allRestaurants);

  var html = '<div id="restaurants" style="margin-top:28px">';
  html += '<div class="section-hero fade-up">';
  html += '<div class="section-label">Restaurants</div>';
  html += '<div class="section-title">식당 · 카페 가이드</div>';
  html += '<div class="section-subtitle">' + allRestaurants.length + '곳 · 메뉴 · 알레르기 정보</div>';
  html += '</div>';

  // 식당/카페 카운트 계산
  var mealCount = 0, cafeCount = 0;
  allRestaurants.forEach(function(r) {
    if (r.type === 'cafe') cafeCount++;
    else mealCount++;
  });

  html += '<div class="rest-sub-tabs" id="restSubTabs">';
  html += '<button class="rest-sub-tab' + (restTypeFilter === 'all' ? ' active' : '') + '" data-type="all" onclick="filterRestType(\'all\')">전체 (' + allRestaurants.length + ')</button>';
  html += '<button class="rest-sub-tab' + (restTypeFilter === 'meal' ? ' active' : '') + '" data-type="meal" onclick="filterRestType(\'meal\')">식당 (' + mealCount + ')</button>';
  html += '<button class="rest-sub-tab' + (restTypeFilter === 'cafe' ? ' active' : '') + '" data-type="cafe" onclick="filterRestType(\'cafe\')">카페 (' + cafeCount + ')</button>';
  html += '</div>';

  html += '<div class="sort-bar">';
  html += '<button class="sort-btn' + (restSortMode === 'rating' ? ' active' : '') + '" onclick="changeRestSort(\'rating\')">별점순</button>';
  html += '<button class="sort-btn' + (restSortMode === 'distance' ? ' active' : '') + '" onclick="changeRestSort(\'distance\')">' + (userLat ? '거리순' : '거리순 (위치 필요)') + '</button>';
  html += '</div>';

  html += '<div id="restList">';
  html += renderRestCards(allRestaurants);
  html += '</div></div>';
  return html;
}

function renderRestCards(list) {
  var html = '';
  list.forEach(function(r, i) {
    var oc = parseOpenClosed(r.hours);
    html += '<details class="card fade-up" data-section="restaurants"';
    html += ' data-dad="' + escAttr(r.dad || '') + '"';
    html += ' data-hiro="' + escAttr(r.hiro || '') + '"';
    html += ' data-category="' + escAttr(r.category || '') + '"';
    html += ' data-hours="' + escAttr(oc.status) + '"';
    html += ' data-type="' + escAttr(r.type || r.cat || 'meal') + '"';
    html += ' style="animation-delay:' + (i * 0.04) + 's">';
    html += '<summary>';
    html += '<div class="card-top">';
    html += '<span class="card-name">' + esc(r.name) + '</span>';
    if (r.rating) html += '<span class="rest-rating">' + r.rating.toFixed(1) + '</span>';
    html += '<div class="card-chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 5l7 7-7 7"/></svg></div>';
    html += '</div>';
    html += '<div class="rest-meta">';
    if (r.menu) html += '<span class="rest-menu-brief">' + esc(r.menu) + '</span>';
    if (oc.status !== 'unknown') html += '<span class="open-tag ' + oc.status + '">' + oc.label + '</span>';
    if (r.distKm !== null && r.distKm < 100) html += '<span class="rest-dist">' + (r.distKm < 1 ? r.distKm.toFixed(1) : Math.round(r.distKm)) + 'km</span>';
    html += '</div>';
    html += '</summary>';

    html += '<div class="card-body">';
    if (r.menuDetail && r.menuDetail.length > 0) {
      r.menuDetail.forEach(function(m) {
        html += '<div class="rest-info">' + esc(m.item);
        if (m.price) html += ' <span style="color:var(--text-light)">' + formatPrice(m.price) + '</span>';
        html += '</div>';
      });
    } else if (r.menu) {
      html += '<div class="rest-info"><span class="rest-info-label">메뉴</span>' + esc(r.menu) + '</div>';
    }
    if (r.priceRange) html += '<div class="rest-info"><span class="rest-info-label">가격대</span>' + esc(r.priceRange) + '</div>';
    if (r.hours) html += '<div class="rest-info"><span class="rest-info-label">영업시간</span>' + esc(r.hours) + '</div>';
    if (r.loc) html += '<div class="rest-info"><span class="rest-info-label">위치</span>' + esc(r.loc) + '</div>';

    var badges = buildBadges(r);
    if (badges) html += '<div class="badges">' + badges + '</div>';

    if (r.meals.length > 0) {
      var um = [];
      r.meals.forEach(function(m) { if (um.indexOf(m) === -1) um.push(m); });
      html += '<div class="rest-meals">' + um.join(' / ') + '</div>';
    }
    if (r.mapUrl) {
      html += '<a class="rest-map-link" href="' + escAttr(r.mapUrl) + '" target="_blank" rel="noopener">';
      html += '지도에서 보기';
      html += '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M7 17L17 7M17 7H7M17 7v10"/></svg>';
      html += '</a>';
    }
    html += '</div></details>';
  });
  return html;
}

function changeRestSort(mode) {
  if (mode === 'distance' && !userLat) { requestRestLocation(); return; }
  restSortMode = mode;
  allRestaurants = sortRestaurants(allRestaurants);
  render();
}

function requestRestLocation() {
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(function(pos) {
    userLat = pos.coords.latitude;
    userLng = pos.coords.longitude;
    restSortMode = 'distance';
    render();
  }, function() {}, { enableHighAccuracy: false, timeout: 10000, maximumAge: 300000 });
}

function buildBadges(opt) {
  var b = '';
  if (opt.dad === 'good') b += '<span class="badge badge-dad-good">아빠 OK</span>';
  if (opt.dad === 'caution') b += '<span class="badge badge-dad-caution">아빠 주의' + (opt.dadNote ? ' · ' + esc(opt.dadNote) : '') + '</span>';
  if (opt.hiro === 'good') b += '<span class="badge badge-hiro-good">히로 OK</span>';
  if (opt.hiro === 'caution') b += '<span class="badge badge-hiro-caution">히로 주의' + (opt.hiroNote ? ' · ' + esc(opt.hiroNote) : '') + '</span>';
  return b;
}

function filterRestType(type) {
  restTypeFilter = type;
  document.querySelectorAll('.rest-sub-tab').forEach(function(t) {
    t.classList.toggle('active', t.getAttribute('data-type') === type);
  });
  applyFilters();
}

// ═══ ④ STAY ═══
var STAY_DATA = {
  name: '까사멜로우', nameEn: 'Casa Mellow',
  desc: '아이와 함께하는 서툰 여행을 응원하며',
  address: '경상북도 경주시 북군4길 75',
  phone: '010-3583-6648', email: 'ssoong6648@naver.com',
  instagram: '@casa.mellow',
  checkin: '15:30', checkout: '11:00',
  parking: '건물 외부 전용 주차장',
  mapUrl: 'https://map.naver.com/p/search/까사멜로우 경주',
  stayfolioUrl: 'https://www.stayfolio.com/findstay/casa-mellow',
  rooms: [
    { name: 'A-1', type: '복층', people: '4/8명', bed: 'Q2 + S1', bath: '2.5', price: '289,000~' },
    { name: 'A-2', type: '복층', people: '4/8명', bed: 'Q2 + S1', bath: '2.5', price: '329,000~' },
    { name: 'B', type: '독채', people: '4/8명', bed: '4개', bath: '2', price: '329,000~' }
  ],
  amenities: {
    kitchen: ['인덕션', '전자레인지', '식기세척기', '토스터기', '캡슐커피머신', '전기포트', '제빙기', '조리도구', '기본조미료', '와인잔'],
    bath: ['샴푸', '컨디셔너', '바디워시', '핸드워시', '치약', '타월', '샤워가운'],
    general: ['TV', '냉장고', '세탁기', '헤어드라이어', '스피커', '슬리퍼', '생수'],
    baby: ['젖병소독기', '유아용 어메니티', '유아 샤워용품', '키즈가구']
  },
  kids: ['실내 키즈룸 (미끄럼틀, 놀이기구)', '야외 모래 놀이터', '미니 바이킹', '전 객실 키즈 어메니티'],
  pool: { depth: '약 70cm', note: '온수 풀 · 사계절 이용 · 시간 제한 없음 · 보호자 동반 필수' },
  bbq: { note: '무료 이용 · 전기그릴 기본 제공 · 시간 제한 없음', extra: '웨버 가스그릴 추가 가능 (유료)' },
  rules: ['전 공간 절대 금연', '실내 냄새나는 음식 조리 금지', '퇴실 전 정리 및 분리수거', '야간 소음 주의', '24개월 미만 영유아 무료', '기준인원 초과 시 1인 1박 30,000원']
};

function renderStay() {
  var s = STAY_DATA;
  var html = '<div id="stay" style="margin-top:28px">';

  html += '<div class="section-hero fade-up">';
  html += '<div class="section-label">Stay</div>';
  html += '<div class="section-title">숙소 안내</div>';
  html += '<div class="section-subtitle">' + esc(s.name) + ' · 5박</div>';
  html += '</div>';

  // 기본 정보
  html += '<details class="card fade-up" open>';
  html += '<summary><div class="card-top"><span class="card-name">' + esc(s.name) + '</span>';
  html += '<div class="card-chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 5l7 7-7 7"/></svg></div>';
  html += '</div><div class="card-sub">' + esc(s.desc) + '</div></summary>';
  html += '<div class="card-body">';
  html += '<div class="info-grid">';
  html += '<span class="info-label">주소</span><span class="info-value">' + esc(s.address) + '</span>';
  html += '<span class="info-label">체크인</span><span class="info-value">' + esc(s.checkin) + '</span>';
  html += '<span class="info-label">체크아웃</span><span class="info-value">' + esc(s.checkout) + '</span>';
  html += '<span class="info-label">주차</span><span class="info-value">' + esc(s.parking) + '</span>';
  html += '<span class="info-label">연락처</span><span class="info-value">' + esc(s.phone) + '</span>';
  html += '<span class="info-label">인스타</span><span class="info-value">' + esc(s.instagram) + '</span>';
  html += '</div>';
  html += '<div class="link-row">';
  html += '<a href="' + escAttr(s.mapUrl) + '" target="_blank" class="link-btn link-btn-outline">지도 보기</a>';
  html += '<a href="' + escAttr(s.stayfolioUrl) + '" target="_blank" class="link-btn link-btn-solid">스테이폴리오</a>';
  html += '</div>';
  html += '</div></details>';

  // 객실 정보
  html += '<details class="card fade-up" style="animation-delay:0.06s">';
  html += '<summary><div class="card-top"><span class="card-name">객실 정보</span>';
  html += '<div class="card-chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 5l7 7-7 7"/></svg></div>';
  html += '</div><div class="card-sub">전 객실 복층 · 키즈룸 · 온수풀</div></summary>';
  html += '<div class="card-body">';
  html += '<div class="stay-room-grid">';
  s.rooms.forEach(function(r) {
    html += '<div class="stay-room-chip"><div class="stay-room-label">' + esc(r.name) + '</div>';
    html += '<div class="stay-room-detail">' + esc(r.type) + '<br>' + esc(r.people) + '<br>' + esc(r.bed) + '<br>욕실 ' + esc(r.bath) + '</div></div>';
  });
  html += '</div>';
  html += '<div class="info-grid">';
  html += '<span class="info-label">1층</span><span class="info-value">거실 · 주방 · 키즈룸 · 세탁실 · BBQ · 풀장</span>';
  html += '<span class="info-label">2층</span><span class="info-value">침실 · 테라스 · 화장실/샤워실</span>';
  html += '<span class="info-label">초과</span><span class="info-value">1인 1박 30,000원 (24개월 미만 무료)</span>';
  html += '</div></div></details>';

  // 키즈 시설
  html += '<details class="card fade-up" style="animation-delay:0.12s">';
  html += '<summary><div class="card-top"><span class="card-name">키즈 시설</span>';
  html += '<div class="card-chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 5l7 7-7 7"/></svg></div>';
  html += '</div><div class="card-sub">실내 키즈룸 + 야외 놀이터</div></summary>';
  html += '<div class="card-body">';
  html += '<ul class="place-list">';
  s.kids.forEach(function(k) { html += '<li>' + esc(k) + '</li>'; });
  html += '</ul>';
  html += '<div class="highlight-box" style="margin-top:12px">';
  html += '<div class="highlight-label">Baby Amenity</div>';
  html += '<div class="highlight-text">' + s.amenities.baby.map(esc).join(' · ') + '</div>';
  html += '</div></div></details>';

  // 수영장 & BBQ
  html += '<details class="card fade-up" style="animation-delay:0.18s">';
  html += '<summary><div class="card-top"><span class="card-name">수영장 · BBQ</span>';
  html += '<div class="card-chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 5l7 7-7 7"/></svg></div>';
  html += '</div><div class="card-sub">온수 풀 · 전기그릴 무료</div></summary>';
  html += '<div class="card-body">';
  html += '<div class="place-section"><div class="place-section-label">Pool</div>';
  html += '<div class="info-grid">';
  html += '<span class="info-label">수심</span><span class="info-value">' + esc(s.pool.depth) + '</span>';
  html += '<span class="info-label">이용</span><span class="info-value">' + esc(s.pool.note) + '</span>';
  html += '</div></div>';
  html += '<div class="place-section"><div class="place-section-label">BBQ</div>';
  html += '<div class="info-grid">';
  html += '<span class="info-label">기본</span><span class="info-value">' + esc(s.bbq.note) + '</span>';
  html += '<span class="info-label">추가</span><span class="info-value">' + esc(s.bbq.extra) + '</span>';
  html += '</div></div></div></details>';

  // 비품
  html += '<details class="card fade-up" style="animation-delay:0.24s">';
  html += '<summary><div class="card-top"><span class="card-name">비품 · 어메니티</span>';
  html += '<div class="card-chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 5l7 7-7 7"/></svg></div>';
  html += '</div><div class="card-sub">주방 · 욕실 · 일반</div></summary>';
  html += '<div class="card-body">';
  [{l:'Kitchen',items:s.amenities.kitchen},{l:'Bath',items:s.amenities.bath},{l:'General',items:s.amenities.general}].forEach(function(g) {
    html += '<div class="place-section"><div class="place-section-label">' + g.l + '</div>';
    html += '<div class="amenity-tags">';
    g.items.forEach(function(item) { html += '<span class="amenity-tag">' + esc(item) + '</span>'; });
    html += '</div></div>';
  });
  html += '</div></details>';

  // 이용 규칙
  html += '<details class="card fade-up" style="animation-delay:0.3s">';
  html += '<summary><div class="card-top"><span class="card-name">이용 규칙</span>';
  html += '<div class="card-chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 5l7 7-7 7"/></svg></div>';
  html += '</div><div class="card-sub">숙소 이용 시 참고사항</div></summary>';
  html += '<div class="card-body">';
  html += '<ul class="place-list">';
  s.rules.forEach(function(r) { html += '<li>' + esc(r) + '</li>'; });
  html += '</ul></div></details>';

  html += '</div>';
  return html;
}

// ═══ FOOTER ═══
function renderFooter() {
  var html = '<div class="footer fade-up">';
  html += '<a href="/" class="footer-cta">';
  html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>';
  html += '일정 상세 보기</a>';
  html += '<div class="footer-note">식당 별점·가격은 참고용이며 현장과 다를 수 있습니다</div>';
  html += '</div>';
  return html;
}

// ═══ SECTION NAV ═══
function scrollToSection(id) {
  var el = document.getElementById(id);
  if (el) {
    var offset = 100;
    var y = el.getBoundingClientRect().top + window.pageYOffset - offset;
    window.scrollTo({ top: y, behavior: 'smooth' });
  }
  document.querySelectorAll('.section-nav-btn').forEach(function(btn) { btn.classList.remove('active'); });
  event.currentTarget.classList.add('active');
}

var spyTimer = null;
window.addEventListener('scroll', function() {
  var btn = document.getElementById('scrollTopBtn');
  if (window.scrollY > 400) btn.classList.add('visible');
  else btn.classList.remove('visible');

  if (spyTimer) return;
  spyTimer = setTimeout(function() {
    spyTimer = null;
    var sections = ['places', 'restaurants', 'stay'];
    var active = sections[0];
    sections.forEach(function(id) {
      var el = document.getElementById(id);
      if (el && el.getBoundingClientRect().top < 140) active = id;
    });
    var idx = sections.indexOf(active);
    document.querySelectorAll('.section-nav-btn').forEach(function(btn, i) {
      btn.classList.toggle('active', i === idx);
    });
  }, 100);
});

// ═══ UTILS ═══
// ═══ THEME ═══
function initTheme() {
  var saved = localStorage.getItem('gj_theme');
  if (saved) {
    document.documentElement.setAttribute('data-theme', saved);
  }
  updateThemeIcon();
}
function toggleTheme() {
  var current = document.documentElement.getAttribute('data-theme');
  var isDark = current === 'dark' || (!current && window.matchMedia('(prefers-color-scheme:dark)').matches);
  var next = isDark ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('gj_theme', next);
  updateThemeIcon();
}
function updateThemeIcon() {
  var theme = document.documentElement.getAttribute('data-theme');
  var isDark = theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme:dark)').matches);
  document.getElementById('themeIcon').innerHTML = isDark
    ? '<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>'
    : '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
}
initTheme();

// ═══ FONT SIZE ═══
var fontSizes = ['medium', 'large', 'small'];

function initFontSize() {
  var saved = localStorage.getItem('gj_fontsize') || 'medium';
  document.documentElement.setAttribute('data-fontsize', saved);
  updateFontSizeIcon(saved);
}

function cycleFontSize() {
  var current = document.documentElement.getAttribute('data-fontsize') || 'medium';
  var idx = fontSizes.indexOf(current);
  var next = fontSizes[(idx + 1) % fontSizes.length];
  document.documentElement.setAttribute('data-fontsize', next);
  localStorage.setItem('gj_fontsize', next);
  updateFontSizeIcon(next);
}

function updateFontSizeIcon(size) {
  var btn = document.getElementById('fontSizeTrigger');
  if (!btn) return;
  var labels = { small: '가-', medium: '가', large: '가+' };
  btn.textContent = labels[size];
}

initFontSize();

function formatDate(s) { var p=s.split('-'); return parseInt(p[1])+'/'+parseInt(p[2]); }
function formatPrice(n) { return n ? n.toLocaleString() + '원' : ''; }
function esc(s) { if(!s) return ''; var d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
function escAttr(s) { return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ═══ SEARCH / FILTER ═══
var activeFilters = new Set();

function toggleSearch() {
  var wrapper = document.getElementById('searchBarWrapper');
  var trigger = document.getElementById('searchTrigger');
  var isOpen = wrapper.classList.toggle('open');
  trigger.classList.toggle('active', isOpen);

  if (!isOpen) {
    // 검색 바 닫을 때 모든 필터 해제
    activeFilters.clear();
    document.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.remove('active'); });
    applyFilters();
  }
}

function toggleFilter(chip) {
  var filter = chip.getAttribute('data-filter');
  chip.classList.toggle('active');

  if (activeFilters.has(filter)) {
    activeFilters.delete(filter);
  } else {
    activeFilters.add(filter);
  }
  applyFilters();
}

function applyFilters() {
  var countEl = document.getElementById('filterResultCount');

  // 필터 없으면 전부 보이기 (restTypeFilter는 별도 적용)
  if (activeFilters.size === 0) {
    document.querySelectorAll('.card[data-section="places"]').forEach(function(card) {
      card.style.display = '';
    });
    document.querySelectorAll('.card[data-section="restaurants"]').forEach(function(card) {
      if (restTypeFilter !== 'all' && card.getAttribute('data-type') !== restTypeFilter) {
        card.style.display = 'none';
      } else {
        card.style.display = '';
      }
    });
    // empty state 숨기기
    document.querySelectorAll('.search-empty').forEach(function(el) { el.classList.remove('visible'); });
    if (countEl) { countEl.classList.remove('visible'); countEl.textContent = ''; }
    return;
  }

  var totalVisible = 0;
  var sectionCounts = { restaurants: 0, places: 0 };

  // 식당 카드 필터링
  document.querySelectorAll('.card[data-section="restaurants"]').forEach(function(card) {
    var match = true;
    activeFilters.forEach(function(f) {
      switch(f) {
        case 'hiro':
          if (card.getAttribute('data-hiro') !== 'good') match = false;
          break;
        case 'dad':
          if (card.getAttribute('data-dad') !== 'good') match = false;
          break;
        case 'cafe':
          var cat = (card.getAttribute('data-category') || '').toLowerCase();
          if (cat.indexOf('cafe') === -1 && cat.indexOf('dessert') === -1) match = false;
          break;
        case 'korean':
          var catK = (card.getAttribute('data-category') || '').toLowerCase();
          if (catK.indexOf('korean') === -1) match = false;
          break;
        case 'open':
          if (card.getAttribute('data-hours') !== 'open') match = false;
          break;
        case 'nursing':
          // 식당에는 수유실 정보 없음 → 필터 무시 (식당 카드 hide 하지 않음)
          break;
        case 'stroller':
          // 식당에는 유모차 정보 없음 → 필터 무시 (식당 카드 hide 하지 않음)
          break;
      }
    });

    // 장소 전용 필터만 선택된 경우 식당은 모두 숨김
    var hasPlaceOnlyFilter = false;
    var hasNonPlaceFilter = false;
    activeFilters.forEach(function(f) {
      if (f === 'nursing' || f === 'stroller') hasPlaceOnlyFilter = true;
      else hasNonPlaceFilter = true;
    });
    if (hasPlaceOnlyFilter && !hasNonPlaceFilter) match = false;

    // 식당/카페 서브탭 필터 적용
    if (restTypeFilter !== 'all' && card.getAttribute('data-type') !== restTypeFilter) match = false;

    card.style.display = match ? '' : 'none';
    if (match) { sectionCounts.restaurants++; totalVisible++; }
  });

  // 장소 카드 필터링
  document.querySelectorAll('.card[data-section="places"]').forEach(function(card) {
    var match = true;
    activeFilters.forEach(function(f) {
      switch(f) {
        case 'hiro':
          // 장소: babyTips 존재 여부로 판단
          if (card.getAttribute('data-babytips') !== '1') match = false;
          break;
        case 'nursing':
          if (card.getAttribute('data-nursing') !== '1') match = false;
          break;
        case 'stroller':
          if (card.getAttribute('data-stroller') !== '1') match = false;
          break;
        case 'dad':
          // 장소에는 아빠 정보 없음 → 필터 무시
          break;
        case 'cafe':
          // 장소에는 카페 카테고리 없음 → 필터 무시
          break;
        case 'korean':
          // 장소에는 한식 카테고리 없음 → 필터 무시
          break;
        case 'open':
          // 장소에는 영업시간 정보 없음 → 필터 무시
          break;
      }
    });

    // 식당 전용 필터만 선택된 경우 장소는 모두 숨김
    var hasRestOnlyFilter = false;
    var hasNonRestFilter = false;
    activeFilters.forEach(function(f) {
      if (f === 'dad' || f === 'cafe' || f === 'korean' || f === 'open') hasRestOnlyFilter = true;
      else hasNonRestFilter = true;
    });
    if (hasRestOnlyFilter && !hasNonRestFilter) match = false;

    card.style.display = match ? '' : 'none';
    if (match) { sectionCounts.places++; totalVisible++; }
  });

  // 어떤 필터가 어떤 섹션에 관련되는지 파악
  var hasRestRelevant = false;
  var hasPlaceRelevant = false;
  activeFilters.forEach(function(f) {
    if (f === 'hiro' || f === 'dad' || f === 'cafe' || f === 'korean' || f === 'open') hasRestRelevant = true;
    if (f === 'hiro' || f === 'nursing' || f === 'stroller') hasPlaceRelevant = true;
  });

  // 결과 카운트 표시
  if (countEl) {
    var parts = [];
    if (hasRestRelevant) parts.push('식당 ' + sectionCounts.restaurants + '곳');
    if (hasPlaceRelevant) parts.push('장소 ' + sectionCounts.places + '곳');
    if (parts.length > 0) {
      countEl.textContent = parts.join(' · ') + ' 일치';
      countEl.classList.add('visible');
    } else {
      countEl.classList.remove('visible');
    }
  }

  // 섹션별 empty state 관리 (해당 섹션에 관련 필터가 있을 때만)
  manageEmptyState('restaurants', hasRestRelevant ? sectionCounts.restaurants : -1);
  manageEmptyState('places', hasPlaceRelevant ? sectionCounts.places : -1);

  // 매칭 섹션이 1개면 section nav 자동 활성화
  var activeSections = [];
  if (sectionCounts.restaurants > 0) activeSections.push('restaurants');
  if (sectionCounts.places > 0) activeSections.push('places');
  if (activeSections.length === 1) {
    var targetId = activeSections[0];
    document.querySelectorAll('.section-nav-btn').forEach(function(btn) { btn.classList.remove('active'); });
    var sectionIdx = ['places', 'restaurants', 'stay'].indexOf(targetId);
    if (sectionIdx >= 0) {
      document.querySelectorAll('.section-nav-btn')[sectionIdx].classList.add('active');
    }
    // 해당 섹션으로 스크롤
    var sectionEl = document.getElementById(targetId);
    if (sectionEl) {
      var y = sectionEl.getBoundingClientRect().top + window.pageYOffset - 100;
      window.scrollTo({ top: y, behavior: 'smooth' });
    }
  }
}

function manageEmptyState(sectionId, count) {
  var sectionEl = document.getElementById(sectionId);
  if (!sectionEl) return;

  var emptyEl = sectionEl.querySelector('.search-empty');
  // count === -1: 해당 섹션에 관련 필터 없음 → empty state 숨김
  if (count === 0 && activeFilters.size > 0) {
    if (!emptyEl) {
      emptyEl = document.createElement('div');
      emptyEl.className = 'search-empty';
      emptyEl.innerHTML = '<div class="search-empty-title">아직 찾지 못했어요</div>' +
        '<div class="search-empty-desc">다른 필터를 선택하거나, 필터를 줄여 보세요.</div>';
      sectionEl.appendChild(emptyEl);
    }
    emptyEl.classList.add('visible');
  } else if (emptyEl) {
    emptyEl.classList.remove('visible');
  }
}

// ═══ CHAT ═══════════════════════════════════════════════════
var chatOpen = false;
var chatBusy = false;

function escapeHtmlChat(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function toggleChat() {
  chatOpen = !chatOpen;
  document.getElementById('chatOverlay').classList.toggle('open', chatOpen);
  document.getElementById('chatSheet').classList.toggle('open', chatOpen);
  document.getElementById('chatFab').classList.toggle('hidden', chatOpen);
  if (chatOpen) {
    setTimeout(function() { document.getElementById('chatInput').focus(); }, 350);
    scrollChatBottom();
  }
}

function closeChat() {
  chatOpen = false;
  document.getElementById('chatOverlay').classList.remove('open');
  document.getElementById('chatSheet').classList.remove('open');
  document.getElementById('chatFab').classList.remove('hidden');
}

function scrollChatBottom() {
  var el = document.getElementById('chatMessages');
  if (el) el.scrollTop = el.scrollHeight;
}

function appendChatMsg(role, text) {
  var container = document.getElementById('chatMessages');
  var welcome = container.querySelector('.chat-welcome');
  if (welcome) welcome.style.display = 'none';

  var div = document.createElement('div');
  div.className = 'chat-msg ' + role;
  if (role === 'bot') {
    div.innerHTML = '<div class="msg-label">포저</div>' + escapeHtmlChat(text).replace(/\n/g, '<br>');
  } else if (role === 'error') {
    div.textContent = text;
  } else {
    div.textContent = text;
  }
  container.appendChild(div);
  scrollChatBottom();
  return div;
}

function showTyping() {
  var container = document.getElementById('chatMessages');
  var div = document.createElement('div');
  div.className = 'chat-msg bot typing';
  div.id = 'chatTyping';
  div.innerHTML = '<div class="msg-label">포저</div><div class="dots"><span></span><span></span><span></span></div>';
  container.appendChild(div);
  scrollChatBottom();
}

function removeTyping() {
  var el = document.getElementById('chatTyping');
  if (el) el.remove();
}

async function sendChat() {
  if (chatBusy) return;
  var input = document.getElementById('chatInput');
  var msg = input.value.trim();
  if (!msg) return;

  input.value = '';
  appendChatMsg('user', msg);
  chatBusy = true;
  document.getElementById('chatSendBtn').disabled = true;
  showTyping();

  try {
    var resp = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg })
    });
    removeTyping();
    var data = await resp.json();
    if (!resp.ok) {
      appendChatMsg('error', data.error || '요청에 실패했습니다');
    } else {
      appendChatMsg('bot', data.reply || '응답을 받지 못했어요.');
    }
  } catch (e) {
    removeTyping();
    appendChatMsg('error', '포저에게 연결할 수 없습니다. 잠시 후 다시 시도해주세요.');
  }
  chatBusy = false;
  document.getElementById('chatSendBtn').disabled = false;
}

function chatHint(text) {
  document.getElementById('chatInput').value = text;
  sendChat();
}

document.addEventListener('DOMContentLoaded', function() {
  var chatInput = document.getElementById('chatInput');
  if (chatInput) {
    chatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChat();
      }
    });
  }
});
</script>

<!-- 채팅 버블 -->
<button class="chat-fab" id="chatFab" onclick="toggleChat()" aria-label="포저와 대화">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
</button>

<!-- 채팅 오버레이 -->
<div class="chat-overlay" id="chatOverlay" onclick="closeChat()"></div>

<!-- 채팅 시트 -->
<div class="chat-sheet" id="chatSheet">
  <div class="chat-sheet-header">
    <div>
      <div class="chat-sheet-title">포저와 대화</div>
      <div class="chat-sheet-subtitle">AI 여행 보좌관</div>
    </div>
    <button class="chat-close-btn" onclick="closeChat()" aria-label="닫기">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </button>
  </div>
  <div class="chat-messages" id="chatMessages">
    <div class="chat-welcome">
      <div class="chat-welcome-icon">&#x1F9ED;</div>
      <div class="chat-welcome-title">안녕하세요, 포저입니다</div>
      <div class="chat-welcome-desc">경주 여행에 대해 무엇이든 물어보세요.<br>일정 변경, 맛집 추천, 관광 정보 등<br>무엇이든 도와드릴게요.</div>
      <div class="chat-welcome-hints">
        <div class="chat-hint-chip" onclick="chatHint('내일 일정 알려줘')">내일 일정</div>
        <div class="chat-hint-chip" onclick="chatHint('근처 맛집 추천해줘')">맛집 추천</div>
        <div class="chat-hint-chip" onclick="chatHint('아이랑 갈만한 곳')">아이와 함께</div>
      </div>
    </div>
  </div>
  <div class="chat-input-row">
    <textarea class="chat-input" id="chatInput" rows="1" placeholder="메시지를 입력하세요..."></textarea>
    <button class="chat-send-btn" id="chatSendBtn" onclick="sendChat()" aria-label="전송">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4z"/></svg>
    </button>
  </div>
</div>

</body>
</html>
