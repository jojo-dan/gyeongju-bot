<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>경주 가족여행</title>
<meta property="og:title" content="경주 가족여행 2026">
<meta property="og:description" content="2026.02.19~24 경주 가족여행 일정 · 식당 · 관광지">
<meta property="og:image" content="https://gyeongju-trip.vercel.app/og-image.png">
<meta property="og:url" content="https://gyeongju-trip.vercel.app">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #E5E5E5;
  --housing: #FFFFFF;
  --display: #2A2A2A;
  --display-text: #FFFFFF;
  --display-dim: rgba(255,255,255,0.65);
  --accent: #E85D2A;
  --text: #1A1A1A;
  --text-mid: #555;
  --text-light: #666;
  --border: #D5D5D5;
  --item-bg: #F5F3F0;
  --item-text: #1A1A1A;
  --item-text-mid: #444;
  --item-text-dim: #666;
  --serif: 'Playfair Display', Georgia, 'Noto Serif KR', serif;
  --mono: 'IBM Plex Mono', 'SF Mono', monospace;
  --system: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', sans-serif;
  --radius-device: 16px;
  --radius-display: 10px;
  --radius-btn: 8px;
  --shadow-device: 0 2px 24px rgba(0,0,0,0.08), 0 0 0 1px rgba(0,0,0,0.03);
  --shadow-btn: 0 1px 3px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
}

body {
  font-family: var(--system);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

/* ═══ HEADER ═══ */
.header {
  padding: 32px 20px 24px;
  text-align: center;
}
.header h1 {
  font-family: var(--serif);
  font-size: 28px;
  font-weight: 700;
  letter-spacing: -0.5px;
  color: var(--text);
  margin-bottom: 4px;
}
.header .sub-info {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 500;
  color: var(--text-mid);
  letter-spacing: 0.5px;
  text-transform: uppercase;
}
.header .update-time {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text-light);
  margin-top: 6px;
  letter-spacing: 0.3px;
}

/* ═══ DEVICE CONTAINER ═══ */
.device {
  max-width: 420px;
  margin: 0 auto;
  padding: 0 16px;
}

/* ═══ DAY TABS (Toggle Group) ═══ */
.day-tabs {
  display: flex;
  gap: 0;
  max-width: 420px;
  margin: 0 auto 16px;
  padding: 0 16px;
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--bg);
  padding-top: 8px;
  padding-bottom: 8px;
}
.day-tabs::-webkit-scrollbar { display: none; }
.day-tab {
  flex: 1 1 0;
  padding: 12px 0;
  font-family: var(--mono);
  font-size: 14px;
  font-weight: 600;
  color: var(--text-mid);
  background: var(--housing);
  border: 1px solid var(--border);
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.15s ease;
  text-align: center;
  min-height: 44px;
}
.day-tab:first-child { border-radius: var(--radius-btn) 0 0 var(--radius-btn); }
.day-tab:last-child { border-radius: 0 var(--radius-btn) var(--radius-btn) 0; }
.day-tab:not(:first-child) { border-left: none; }
.day-tab.active {
  background: var(--text);
  color: #fff;
  border-color: var(--text);
}
.day-tab .tab-date {
  display: block;
  font-size: 12px;
  font-weight: 400;
  color: var(--text-light);
  margin-top: 2px;
}
.day-tab.active .tab-date { color: rgba(255,255,255,0.7); }

/* ═══ DISPLAY CARD (Main Device) ═══ */
.display-card {
  background: var(--housing);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  overflow: hidden;
  margin-bottom: 16px;
}
.display-screen {
  background: var(--display);
  margin: 12px;
  border-radius: var(--radius-display);
  padding: 20px 16px;
  position: relative;
}
.display-screen::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  border-radius: var(--radius-display);
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0,0,0,0.03) 2px,
    rgba(0,0,0,0.03) 4px
  );
  pointer-events: none;
}
.display-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.display-label {
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--accent);
  letter-spacing: 1px;
}
.display-indicator {
  display: flex;
  gap: 4px;
}
.display-indicator span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(255,255,255,0.3);
}
.display-indicator span.on { background: var(--display-text); }

.day-title-display {
  font-family: var(--mono);
  font-size: 22px;
  font-weight: 600;
  color: var(--display-text);
  margin-bottom: 6px;
  letter-spacing: 1px;
}
.day-subtitle {
  font-family: var(--mono);
  font-size: 14px;
  color: var(--display-dim);
}

/* ═══ LEVEL METER (Day Progress) ═══ */
.level-meter {
  padding: 0 16px 16px;
}
.meter-bar {
  height: 3px;
  background: rgba(0,0,0,0.08);
  border-radius: 2px;
  position: relative;
  overflow: visible;
}
.meter-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  transition: width 0.3s ease;
}
.meter-ticks {
  display: flex;
  justify-content: space-between;
  margin-top: 6px;
}
.meter-tick {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text-light);
}

/* ═══ ITEM CARDS ═══ */
.items-list {
  padding: 0 0 8px;
}

.item-card {
  background: var(--housing);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  margin-bottom: 12px;
  overflow: hidden;
}
.item-display {
  background: var(--item-bg);
  margin: 10px;
  border-radius: var(--radius-display);
  padding: 16px;
}
.item-top-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
.item-status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.item-status-dot.planned { background: #BBBBBB; }
.item-status-dot.done { background: #22C55E; }
.item-status-dot.skipped { background: #EF4444; }

.item-time {
  font-family: var(--mono);
  font-size: 13px;
  color: var(--item-text-dim);
  letter-spacing: 0.5px;
  font-weight: 500;
}
.item-cat-label {
  font-family: var(--system);
  font-size: 12px;
  color: var(--accent);
  margin-left: auto;
  font-weight: 600;
}

.item-title {
  font-family: var(--system);
  font-size: 18px;
  font-weight: 700;
  color: var(--item-text);
  letter-spacing: -0.2px;
}
.item-title.skipped {
  text-decoration: line-through;
  color: var(--item-text-dim);
}

/* ═══ OPTIONS (in display) ═══ */
.options-list {
  margin-top: 10px;
  border-top: 1px solid rgba(0,0,0,0.06);
  padding-top: 10px;
}
.option-item {
  padding: 10px 12px;
  border-radius: 6px;
  margin-bottom: 8px;
  font-family: var(--system);
  font-size: 14px;
  color: var(--item-text-mid);
  background: rgba(255,255,255,0.6);
  transition: all 0.15s;
}
.option-item.chosen {
  background: rgba(34, 139, 34, 0.08);
  color: #1A6B1A;
  border: 1px solid rgba(34, 139, 34, 0.2);
}
.option-name { font-weight: 700; color: var(--item-text); }
.option-item.chosen .option-name { color: #1A6B1A; }
.option-menu { color: var(--item-text-mid); font-size: 13px; }
.option-badges { margin-top: 6px; display: flex; gap: 6px; flex-wrap: wrap; }
.badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-family: var(--system);
  font-size: 12px;
  font-weight: 600;
}
.badge-dad-good { background: #DEF7E5; color: #1A6B1A; }
.badge-dad-caution { background: #FDE8E0; color: #C04A1A; }
.badge-hiro-good { background: #DBEAFE; color: #1D4ED8; }
.badge-hiro-caution { background: #FEE2E2; color: #C53030; }

.chosen-tag {
  font-family: var(--system);
  font-size: 12px;
  font-weight: 700;
  color: #1A6B1A;
}

/* ═══ ITEM NOTE ═══ */
.item-note-row {
  padding: 10px 14px 12px;
  font-family: var(--system);
  font-size: 14px;
  color: var(--text-mid);
}
.item-note-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-light);
  margin-bottom: 3px;
}

/* ═══ LOADING ═══ */
.loading {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-light);
  font-family: var(--system);
  font-size: 14px;
}
.loading .spinner {
  display: inline-block;
  width: 24px; height: 24px;
  border: 2px solid var(--border);
  border-top-color: var(--text);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ═══ ERROR ═══ */
.error-banner {
  max-width: 420px;
  margin: 0 auto;
  padding: 12px 16px;
  font-family: var(--system);
  font-size: 14px;
  text-align: center;
  color: #C04A1A;
  background: rgba(232,93,42,0.08);
  border-radius: var(--radius-btn);
  display: none;
}
.error-banner.show { display: block; margin-bottom: 12px; }

/* ═══ TOAST ═══ */
.toast {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: var(--text);
  color: #fff;
  padding: 14px 28px;
  border-radius: var(--radius-btn);
  font-family: var(--system);
  font-size: 15px;
  font-weight: 600;
  z-index: 400;
  transition: transform 0.3s;
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* ═══ LOCATION BANNER ═══ */
.location-banner {
  max-width: 420px;
  margin: 0 auto 16px;
  padding: 0 16px;
}
.location-banner .banner-device {
  background: var(--housing);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  overflow: hidden;
}
.location-banner .screen {
  background: var(--display);
  margin: 12px;
  border-radius: var(--radius-display);
  padding: 20px 16px;
  text-align: center;
}
.location-banner .screen p {
  font-family: var(--system);
  font-size: 15px;
  color: var(--display-text);
  line-height: 1.6;
}
.location-banner .banner-buttons {
  display: flex;
  gap: 10px;
  padding: 0 12px 12px;
}
.location-banner .btn-primary {
  flex: 1;
  padding: 12px 0;
  font-family: var(--system);
  font-size: 15px;
  font-weight: 700;
  color: #fff;
  background: var(--text);
  border: none;
  border-radius: var(--radius-btn);
  cursor: pointer;
  min-height: 44px;
  box-shadow: var(--shadow-btn);
  transition: opacity 0.15s;
}
.location-banner .btn-primary:active { opacity: 0.8; }
.location-banner .btn-secondary {
  flex: 1;
  padding: 12px 0;
  font-family: var(--system);
  font-size: 15px;
  font-weight: 600;
  color: var(--text-mid);
  background: var(--housing);
  border: 1px solid var(--border);
  border-radius: var(--radius-btn);
  cursor: pointer;
  min-height: 44px;
  transition: opacity 0.15s;
}
.location-banner .btn-secondary:active { opacity: 0.8; }

/* ═══ ITEM DISTANCE ═══ */
.item-distance {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 500;
  color: var(--item-text-dim);
  margin-top: 4px;
  letter-spacing: 0.2px;
}
.item-distance.nearby {
  color: var(--accent);
  font-weight: 600;
}
.item-distance.far-away {
  color: var(--text-light);
}

/* ═══ OPTION DISTANCE ═══ */
.option-distance {
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 500;
  color: var(--item-text-dim);
  float: right;
  margin-left: 8px;
}
.option-distance.nearby {
  color: var(--accent);
}

/* ═══ REFRESH BUTTON ═══ */
.refresh-btn {
  display: none;
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius-btn);
  padding: 4px 10px;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--text-mid);
  cursor: pointer;
  margin-top: 6px;
  transition: opacity 0.15s;
  min-height: 28px;
}
.refresh-btn:active { opacity: 0.7; }
.refresh-btn.visible { display: inline-block; }

/* ═══ REFERENCE ═══ */
.reference-section {
  margin-top: 8px;
}
.reference-section h3 {
  font-family: var(--system);
  font-size: 15px;
  font-weight: 700;
  color: var(--text-mid);
  margin-bottom: 12px;
}
.ref-card {
  background: var(--housing);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  padding: 14px 16px;
  margin-bottom: 10px;
}
.ref-card h4 {
  font-family: var(--system);
  font-size: 13px;
  font-weight: 700;
  color: var(--text-mid);
  margin-bottom: 8px;
}
.ref-card ul { list-style: none; }
.ref-card li {
  font-family: var(--system);
  font-size: 14px;
  padding: 4px 0;
  color: var(--text-mid);
}

/* ═══ SPEAKER GRILLE (decorative) ═══ */
.grille {
  display: inline-grid;
  grid-template-columns: repeat(4, 4px);
  gap: 3px;
  opacity: 0.15;
}
.grille span {
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--text);
}
</style>
</head>
<body>

<!-- 메인 앱 -->
<div id="mainApp">
  <div class="header">
    <h1>경주 가족여행</h1>
    <div class="sub-info">
      <span id="tripStatus">2026.02.19 — 02.24</span>
    </div>
    <div class="update-time" id="updateTime"></div>
    <button class="refresh-btn" id="refreshBtn" onclick="requestLocation()">위치 갱신</button>
  </div>

  <!-- 위치 안내 배너 -->
  <div class="location-banner" id="locationBanner" style="display:none;">
    <div class="banner-device">
      <div class="screen">
        <p>위치를 켜면 각 장소까지<br>거리를 확인할 수 있습니다</p>
      </div>
      <div class="banner-buttons">
        <button class="btn-primary" onclick="requestLocation()">위치 켜기</button>
        <button class="btn-secondary" onclick="dismissLocationBanner()">괜찮습니다</button>
      </div>
    </div>
  </div>

  <div class="error-banner" id="errorBanner"></div>

  <div class="day-tabs" id="dayTabs"></div>

  <div class="device">
    <div id="contentArea">
      <div class="loading">
        <div class="spinner"></div>
        <div>일정 불러오는 중...</div>
      </div>
    </div>
  </div>
</div>

<!-- 토스트 -->
<div class="toast" id="toast"></div>

<script>
const POLL_INTERVAL = 30000;

let travelData = null;
let activeDay = 0;
let pollTimer = null;

// 앱 시작
(function init() {
  fetchData();
  pollTimer = setInterval(fetchData, POLL_INTERVAL);
})();

async function fetchData() {
  try {
    const res = await fetch('/api/data');
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    const json = await res.json();
    travelData = json.record;
    hideError();
    render();
  } catch (e) {
    showError('연결 끊김. 다시 시도 중...');
    console.error('fetch error:', e);
  }
}

function render() {
  if (!travelData) return;
  updateHeader();
  renderTabs();
  renderDayContent();
}

function updateHeader() {
  const meta = travelData.meta;
  if (meta && meta.lastUpdated) {
    const d = new Date(meta.lastUpdated);
    document.getElementById('updateTime').textContent =
      `마지막 업데이트: ${formatDateTime(d)}`;
  }
  const now = new Date();
  const tripStart = new Date('2026-02-19T00:00:00+09:00');
  const tripEnd = new Date('2026-02-24T23:59:59+09:00');
  let status = '2026.02.19 — 02.24';
  if (now < tripStart) {
    const diff = Math.ceil((tripStart - now) / 86400000);
    status = `D-${diff} / 2026.02.19 — 02.24`;
  } else if (now > tripEnd) {
    status = '여행 완료';
  } else {
    const dayNum = Math.floor((now - tripStart) / 86400000) + 1;
    status = `${dayNum}일차 진행 중`;
    if (activeDay === 0) activeDay = dayNum - 1;
  }
  document.getElementById('tripStatus').textContent = status;
}

function renderTabs() {
  const tabs = document.getElementById('dayTabs');
  const days = travelData.days;
  tabs.innerHTML = '';
  days.forEach((day, idx) => {
    const tab = document.createElement('div');
    tab.className = 'day-tab' + (idx === activeDay ? ' active' : '');
    tab.innerHTML = `${day.dayNum}일차<span class="tab-date">${formatTabDate(day.date, day.dow)}</span>`;
    tab.onclick = () => { activeDay = idx; renderTabs(); renderDayContent(); };
    tabs.appendChild(tab);
  });
  const activeTab = tabs.querySelector('.active');
  if (activeTab) activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
}

function renderDayContent() {
  const area = document.getElementById('contentArea');
  const day = travelData.days[activeDay];
  if (!day) { area.innerHTML = '<div class="loading">데이터 없음</div>'; return; }

  const totalItems = day.items.length;
  const doneItems = day.items.filter(i => i.status === 'done' || i.status === 'skipped').length;
  const progress = totalItems > 0 ? (doneItems / totalItems * 100) : 0;

  let html = '';

  // 메인 디스플레이 카드
  html += '<div class="display-card">';
  html += '<div class="display-screen">';
  html += '<div class="display-header">';
  html += `<span class="display-label">일정</span>`;
  html += '<div class="display-indicator">';
  for (let i = 0; i < totalItems; i++) {
    html += `<span class="${i < doneItems ? 'on' : ''}"></span>`;
  }
  html += '</div></div>';
  html += `<div class="day-title-display">${day.title}</div>`;
  html += `<div class="day-subtitle">${day.dayNum}일차 / ${doneItems}/${totalItems} 완료</div>`;
  html += '</div>';

  // 진행 레벨 미터
  html += '<div class="level-meter">';
  html += `<div class="meter-bar"><div class="meter-fill" style="width:${progress}%"></div></div>`;
  html += '<div class="meter-ticks">';
  html += '<span class="meter-tick">0%</span>';
  html += `<span class="meter-tick" style="color:var(--accent)">${Math.round(progress)}%</span>`;
  html += '<span class="meter-tick">100%</span>';
  html += '</div></div>';

  html += '</div>';

  // 일정 아이템 카드들
  html += '<div class="items-list">';
  day.items.forEach((item) => {
    html += renderItemCard(item);
  });
  html += '</div>';

  // reference 섹션
  if (activeDay === travelData.days.length - 1 && travelData.reference) {
    html += renderReference(travelData.reference);
  }

  area.innerHTML = html;
}

function renderItemCard(item) {
  const catLabel = { meal: '식사', cafe: '카페', activity: '관광' };
  const titleClass = item.status === 'skipped' ? ' skipped' : '';

  let html = `<div class="item-card">`;
  html += '<div class="item-display">';

  // 상단 행
  html += '<div class="item-top-row">';
  html += `<span class="item-status-dot ${item.status}"></span>`;
  html += `<span class="item-time">${item.time || ''}</span>`;
  html += `<span class="item-cat-label">${catLabel[item.cat] || ''}</span>`;
  html += '</div>';

  // 제목
  html += `<div class="item-title${titleClass}">${item.title}</div>`;

  // 거리 행 (위치 활성화 시)
  if (userLat && item.options && item.options.length > 0) {
    const distInfo = getItemDistance(item);
    if (distInfo && distInfo.km < 50) {
      const fmt = formatDistance(distInfo.km);
      html += `<div class="item-distance ${fmt.cls}">${fmt.text}</div>`;
    } else if (distInfo && distInfo.km >= 50) {
      html += `<div class="item-distance far-away">${formatDistance(distInfo.km).text}</div>`;
    }
  }

  // 옵션 목록
  if (item.options && item.options.length > 0) {
    // 50km 이상이면 개별 거리 숨김
    const showOptionDist = userLat && !(getItemDistance(item) && getItemDistance(item).km >= 50);
    const multipleOptions = item.options.length >= 2;

    html += '<div class="options-list">';
    item.options.forEach(opt => {
      const isChosen = item.chosen && item.chosen === opt.name;
      html += `<div class="option-item${isChosen ? ' chosen' : ''}">`;

      // 옵션별 소형 거리 (옵션 2개 이상일 때)
      if (showOptionDist && multipleOptions && opt.lat && opt.lng) {
        const optKm = haversineDistance(userLat, userLng, opt.lat, opt.lng);
        const optCls = optKm < 1 ? ' nearby' : '';
        const optText = optKm < 1 ? optKm.toFixed(1) + 'km' : (optKm < 5 ? optKm.toFixed(1) + 'km' : Math.round(optKm) + 'km');
        html += `<span class="option-distance${optCls}">${optText}</span>`;
      }

      html += `<span class="option-name">${opt.name}</span>`;
      if (opt.menu) html += ` <span class="option-menu">— ${opt.menu}</span>`;
      if (isChosen) html += ` <span class="chosen-tag">확정</span>`;

      const badges = [];
      if (opt.dad === 'good') badges.push('<span class="badge badge-dad-good">아빠 OK</span>');
      if (opt.dad === 'caution') badges.push('<span class="badge badge-dad-caution">아빠 주의</span>');
      if (opt.hiro === 'good') badges.push('<span class="badge badge-hiro-good">히로 OK</span>');
      if (opt.hiro === 'caution') {
        let hiroLabel = '히로 주의';
        if (opt.hiroNote) hiroLabel += ` (${opt.hiroNote})`;
        badges.push(`<span class="badge badge-hiro-caution">${hiroLabel}</span>`);
      }
      if (badges.length) html += `<div class="option-badges">${badges.join('')}</div>`;

      html += '</div>';
    });
    html += '</div>';
  }

  html += '</div>'; // item-display

  // 메모
  if (item.note) {
    html += '<div class="item-note-row">';
    html += '<div class="item-note-label">메모</div>';
    html += escapeHtml(item.note);
    html += '</div>';
  }

  html += '</div>';
  return html;
}

function renderReference(ref) {
  let html = '<div class="reference-section"><h3>참고 정보</h3>';

  if (ref.distances && ref.distances.length) {
    html += '<div class="ref-card"><h4>거리 / 소요시간</h4><ul>';
    ref.distances.forEach(d => { html += `<li>${typeof d === 'string' ? d : JSON.stringify(d)}</li>`; });
    html += '</ul></div>';
  }
  if (ref.contacts && ref.contacts.length) {
    html += '<div class="ref-card"><h4>연락처</h4><ul>';
    ref.contacts.forEach(c => { html += `<li>${typeof c === 'string' ? c : JSON.stringify(c)}</li>`; });
    html += '</ul></div>';
  }
  if (ref.shopping && ref.shopping.length) {
    html += '<div class="ref-card"><h4>쇼핑</h4><ul>';
    ref.shopping.forEach(s => { html += `<li>${typeof s === 'string' ? s : JSON.stringify(s)}</li>`; });
    html += '</ul></div>';
  }

  html += '</div>';
  return html;
}

// 유틸
function formatDateTime(d) {
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  const hh = String(d.getHours()).padStart(2, '0');
  const mi = String(d.getMinutes()).padStart(2, '0');
  return `${mm}.${dd} ${hh}:${mi}`;
}

function formatTabDate(dateStr, dow) {
  const parts = dateStr.split('-');
  return `${parseInt(parts[1])}/${parseInt(parts[2])}`;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function escapeAttr(str) {
  return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function showError(msg) {
  const el = document.getElementById('errorBanner');
  el.textContent = msg;
  el.classList.add('show');
}
function hideError() {
  document.getElementById('errorBanner').classList.remove('show');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// ═══ 위치 / 거리 기능 ═══

let userLat = null;
let userLng = null;
let locationTimestamp = 0;
let gpsWarningShown = false;

const GEO_OPTIONS = {
  enableHighAccuracy: false,
  timeout: 10000,
  maximumAge: 300000
};

// 위치 배너 표시 (페이지 로드 1초 후)
function initLocationBanner() {
  // HTTPS 아닌 환경 또는 Geolocation 미지원 시 배너 미표시
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') return;
  if (!navigator.geolocation) return;
  // 이미 거부한 경우 미표시
  if (localStorage.getItem('gj_location_dismissed') === 'true') return;

  setTimeout(() => {
    document.getElementById('locationBanner').style.display = '';
  }, 1000);
}

// [위치 켜기] 클릭
function requestLocation() {
  if (!navigator.geolocation) {
    showToast('이 브라우저에서 위치를 사용할 수 없습니다');
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      userLat = pos.coords.latitude;
      userLng = pos.coords.longitude;
      locationTimestamp = Date.now();

      // 배너 숨김
      document.getElementById('locationBanner').style.display = 'none';

      // 갱신 버튼 표시
      document.getElementById('refreshBtn').classList.add('visible');

      // GPS 정확도 경고 (500m 이상, 1회만)
      if (pos.coords.accuracy > 500 && !gpsWarningShown) {
        gpsWarningShown = true;
        showToast('위치가 정확하지 않을 수 있습니다');
      }

      updateDistances();
    },
    (err) => {
      if (err.code === err.TIMEOUT) {
        showToast('위치를 가져올 수 없습니다');
      } else if (err.code === err.PERMISSION_DENIED) {
        document.getElementById('locationBanner').style.display = 'none';
      } else {
        showToast('위치를 가져올 수 없습니다');
      }
    },
    GEO_OPTIONS
  );
}

// [괜찮습니다] 클릭
function dismissLocationBanner() {
  localStorage.setItem('gj_location_dismissed', 'true');
  document.getElementById('locationBanner').style.display = 'none';
}

// Haversine 거리 계산 (km)
function haversineDistance(lat1, lng1, lat2, lng2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2)
    + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180)
    * Math.sin(dLng / 2) * Math.sin(dLng / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// 거리 포맷
function formatDistance(km) {
  if (km >= 50) return { text: '현재 경주 근처가 아닙니다', cls: 'far-away' };
  if (km < 1) {
    const walkMin = Math.round((km * 1000) / 67);
    return { text: '도보 약 ' + walkMin + '분 (' + km.toFixed(1) + 'km)', cls: 'nearby' };
  }
  const driveMin = Math.round(km / 30 * 60);
  if (km < 5) return { text: '약 ' + km.toFixed(1) + 'km · 차량 약 ' + driveMin + '분', cls: '' };
  return { text: '약 ' + Math.round(km) + 'km · 차량 약 ' + driveMin + '분', cls: '' };
}

// 아이템 대표 거리 계산 (chosen 옵션 우선, 없으면 가장 가까운 옵션)
function getItemDistance(item) {
  if (!userLat || !item.options || item.options.length === 0) return null;

  // 좌표가 있는 옵션만 필터
  const withCoords = item.options.filter(o => o.lat && o.lng);
  if (withCoords.length === 0) return null;

  // chosen 옵션이 좌표가 있으면 우선
  if (item.chosen) {
    const chosen = withCoords.find(o => o.name === item.chosen);
    if (chosen) {
      return { km: haversineDistance(userLat, userLng, chosen.lat, chosen.lng), name: chosen.name };
    }
  }

  // 가장 가까운 옵션
  let closest = null;
  let minKm = Infinity;
  withCoords.forEach(o => {
    const km = haversineDistance(userLat, userLng, o.lat, o.lng);
    if (km < minKm) { minKm = km; closest = o; }
  });
  return closest ? { km: minKm, name: closest.name } : null;
}

// 거리 업데이트 (렌더링 재실행)
function updateDistances() {
  if (travelData) renderDayContent();
  showToast('위치 업데이트됨');
}

// visibilitychange: 30분 경과 시 자동 갱신
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState !== 'visible') return;
  if (!userLat) return;
  if (Date.now() - locationTimestamp > 1800000) {
    requestLocation();
  }
});

// 페이지 로드 후 배너 초기화
document.addEventListener('DOMContentLoaded', initLocationBanner);
</script>
</body>
</html>
