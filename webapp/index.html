<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>경주 가족여행</title>
<meta property="og:title" content="경주 가족여행 2026">
<meta property="og:description" content="2026.02.19~24 경주 가족여행 일정 · 식당 · 관광지">
<meta property="og:image" content="https://gyeongju-trip.vercel.app/og-image.png">
<meta property="og:url" content="https://gyeongju-trip.vercel.app">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/earlyaccess/kopubbatang.css" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg:#FAF7F2;
  --bg-warm:#F3EDE4;
  --housing:#FFFFFF;
  --display:#3D2E1F;
  --display-text:#FAF7F2;
  --display-dim:rgba(250,247,242,0.55);
  --accent:#C45D3E;
  --accent-soft:#E8896E;
  --accent-bg:rgba(196,93,62,0.08);
  --sage:#7B8F6B;
  --sage-bg:rgba(123,143,107,0.1);
  --text:#2C2218;
  --text-mid:#5C4F42;
  --text-light:#8C7E72;
  --text-muted:#A89E94;
  --border:rgba(60,46,31,0.1);
  --border-strong:rgba(60,46,31,0.18);
  --item-bg:#F3EDE4;
  --item-text:#2C2218;
  --item-text-mid:#5C4F42;
  --item-text-dim:#8C7E72;
  --serif:'Spectral','KoPub Batang',Georgia,serif;
  --mono:'DM Mono','SF Mono',monospace;
  --system:'Spectral','KoPub Batang',Georgia,serif;
  --radius-device:20px;
  --radius-display:14px;
  --radius-btn:12px;
  --shadow-device:0 1px 3px rgba(60,46,31,0.06),0 8px 24px rgba(60,46,31,0.04);
  --shadow-btn:0 1px 3px rgba(0,0,0,0.1),inset 0 1px 0 rgba(255,255,255,0.8);
}

/* ═══ DARK MODE ═══ */
[data-theme="dark"]{
  --bg:#1A1714;--bg-warm:#242019;--housing:#2C261F;
  --display:#2C261F;--display-text:#E8E0D6;--display-dim:rgba(232,224,214,0.45);
  --accent:#E8896E;--accent-soft:#C45D3E;--accent-bg:rgba(232,137,110,0.15);
  --sage:#9AB089;--sage-bg:rgba(154,176,137,0.15);
  --text:#E8E0D6;--text-mid:#B5AA9E;--text-light:#8C7E72;--text-muted:#6B5F54;
  --border:rgba(250,247,242,0.08);--border-strong:rgba(250,247,242,0.15);
  --item-bg:#242019;--item-text:#E8E0D6;--item-text-mid:#B5AA9E;--item-text-dim:#8C7E72;
  --shadow-device:0 1px 3px rgba(0,0,0,0.3),0 8px 24px rgba(0,0,0,0.2);
  --shadow-btn:0 1px 3px rgba(0,0,0,0.3);
}
@media(prefers-color-scheme:dark){
  :root:not([data-theme="light"]){
    --bg:#1A1714;--bg-warm:#242019;--housing:#2C261F;
    --display:#2C261F;--display-text:#E8E0D6;--display-dim:rgba(232,224,214,0.45);
    --accent:#E8896E;--accent-soft:#C45D3E;--accent-bg:rgba(232,137,110,0.15);
    --sage:#9AB089;--sage-bg:rgba(154,176,137,0.15);
    --text:#E8E0D6;--text-mid:#B5AA9E;--text-light:#8C7E72;--text-muted:#6B5F54;
    --border:rgba(250,247,242,0.08);--border-strong:rgba(250,247,242,0.15);
    --item-bg:#242019;--item-text:#E8E0D6;--item-text-mid:#B5AA9E;--item-text-dim:#8C7E72;
    --shadow-device:0 1px 3px rgba(0,0,0,0.3),0 8px 24px rgba(0,0,0,0.2);
    --shadow-btn:0 1px 3px rgba(0,0,0,0.3);
  }
}

/* ═══ THEME TOGGLE ═══ */
.theme-toggle{
  position:fixed;top:12px;right:16px;z-index:200;
  width:36px;height:36px;border-radius:50%;
  border:1.5px solid var(--border-strong);
  background:var(--housing);color:var(--text-mid);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);transition:all 0.2s;
}
.theme-toggle:active{transform:scale(0.9)}
.theme-toggle svg{width:16px;height:16px}

/* ═══ GRAIN ═══ */
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:0.03;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-repeat:repeat;background-size:256px;
}

body {
  font-family: var(--system);
  font-size: var(--base-font, 16px);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  -webkit-text-size-adjust:100%;
}

/* ═══ HEADER ═══ */
.header {
  padding: 40px 20px 24px;
  text-align: center;
  position:relative;
}
.header::after{
  content:'';display:block;width:40px;height:2px;
  background:var(--accent);margin:16px auto 0;border-radius:1px;
}
.header h1 {
  font-family: var(--serif);
  font-size: 34px;
  font-weight: 700;
  letter-spacing: -0.5px;
  color: var(--text);
  line-height:1.2;
}
.header .sub-info {
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 400;
  color: var(--text-light);
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-top:8px;
}
.header .update-time {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 6px;
  letter-spacing: 0.3px;
}

/* ═══ DEVICE CONTAINER ═══ */
.device {
  max-width: 440px;
  margin: 0 auto;
  padding: 0 16px;
}

/* ═══ DAY TABS ═══ */
.day-tabs {
  display: flex;
  gap: 6px;
  max-width: 440px;
  margin: 0 auto 20px;
  padding: 0 16px;
  position: sticky;
  top: 0;
  z-index: 100;
  background: linear-gradient(var(--bg),var(--bg) 85%,transparent);
  padding-top: 10px;
  padding-bottom: 14px;
}
.day-tabs::-webkit-scrollbar { display: none; }
.day-tab {
  flex: 1 1 0;
  padding: 10px 0;
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 500;
  color: var(--text-muted);
  background: transparent;
  border: 1.5px solid var(--border);
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
  text-align: center;
  min-height: 44px;
  border-radius: var(--radius-btn);
}
.day-tab:not(.active):active { background:var(--bg-warm) }
.day-tab.active {
  background: var(--display);
  color: var(--display-text);
  border-color: var(--display);
  box-shadow:0 2px 8px rgba(61,46,31,0.2);
}
.day-tab .tab-date {
  display: block;
  font-size: 11px;
  font-weight: 400;
  color: var(--text-muted);
  margin-top: 2px;
}
.day-tab.active .tab-date { color: var(--display-dim); }

/* ═══ DISPLAY CARD (Main Device) ═══ */
.display-card {
  background: var(--display);
  border-radius: var(--radius-device);
  box-shadow: 0 4px 32px rgba(60,46,31,0.12);
  overflow: hidden;
  margin-bottom: 16px;
  position:relative;
}
.display-card::before{
  content:'';position:absolute;top:-20px;right:-20px;
  width:120px;height:120px;border-radius:50%;
  background:rgba(196,93,62,0.12);pointer-events:none;
}
.display-screen {
  padding: 28px 22px;
  position: relative;
}
.display-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.display-label {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  color: var(--accent-soft);
  letter-spacing: 2px;
  text-transform:uppercase;
}
.display-indicator {
  display: flex;
  gap: 4px;
}
.display-indicator span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(250,247,242,0.2);
  transition:background 0.3s;
}
.display-indicator span.on { background: var(--display-text); }

.day-title-display {
  font-family: var(--serif);
  font-size: 26px;
  font-weight: 700;
  color: var(--display-text);
  margin-bottom: 6px;
  letter-spacing: -0.3px;
  line-height:1.25;
}
.day-subtitle {
  font-family: var(--system);
  font-size: 13px;
  color: var(--display-dim);
  font-weight:400;
}

/* ═══ LEVEL METER (Day Progress) ═══ */
.level-meter {
  padding: 0 22px 20px;
}
.meter-bar {
  height: 3px;
  background: rgba(250,247,242,0.15);
  border-radius: 2px;
  position: relative;
  overflow: visible;
}
.meter-fill {
  height: 100%;
  background: var(--accent-soft);
  border-radius: 2px;
  transition: width 0.4s cubic-bezier(0.4,0,0.2,1);
}
.meter-ticks {
  display: flex;
  justify-content: space-between;
  margin-top: 8px;
}
.meter-tick {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--display-dim);
  letter-spacing:0.3px;
}

/* ═══ ITEM CARDS ═══ */
.items-list {
  padding: 0 0 8px;
}

.item-card {
  background: var(--housing);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  margin-bottom: 12px;
  overflow: hidden;
}
.item-display {
  padding: 18px 20px;
}
.item-top-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
.item-status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.item-status-dot.planned { background: var(--text-muted); }
.item-status-dot.done { background: var(--sage); }
.item-status-dot.skipped { background: #EF4444; }

.item-time {
  font-family: var(--mono);
  font-size: 13px;
  color: var(--item-text-dim);
  letter-spacing: 0.5px;
  font-weight: 500;
}
.item-cat-label {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--accent);
  margin-left: auto;
  font-weight: 500;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

.item-title {
  font-family: var(--serif);
  font-size: 20px;
  font-weight: 700;
  color: var(--item-text);
  letter-spacing: -0.2px;
  line-height: 1.3;
}
.item-title.skipped {
  text-decoration: line-through;
  color: var(--item-text-dim);
}

/* ═══ OPTIONS (in display) ═══ */
.options-list {
  margin-top: 12px;
  border-top: 1px solid var(--border);
  padding-top: 12px;
}

/* ═══ OPTION CARD (Accordion) ═══ */
.option-card {
  border-radius: 14px;
  margin-bottom: 8px;
  background: var(--bg-warm);
  border: 1px solid transparent;
  overflow: hidden;
  transition: box-shadow 0.3s, border-color 0.3s;
}
.option-card[open] {
  border-color: var(--border);
  box-shadow: 0 2px 12px rgba(0,0,0,0.06);
}
.option-card.chosen {
  background: var(--sage-bg);
  border-color: rgba(123,143,107,0.25);
}

.option-card summary {
  padding: 12px 14px;
  cursor: pointer;
  list-style: none;
  -webkit-tap-highlight-color: transparent;
}
.option-card summary::-webkit-details-marker { display: none; }

/* 상단 행: 이름 + 별점 + 확정 + chevron */
.option-top {
  display: flex;
  align-items: center;
  gap: 8px;
}
.option-name {
  font-family: var(--serif);
  font-size: 16px;
  font-weight: 700;
  color: var(--item-text);
  flex: 1;
  min-width: 0;
}
.option-card.chosen .option-name {
  color: var(--sage);
}
.option-rating {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 500;
  color: var(--accent);
}
.option-chevron {
  color: var(--text-muted);
  flex-shrink: 0;
  transition: transform 0.2s;
  display: flex;
}
.option-card[open] .option-chevron {
  transform: rotate(90deg);
}

/* 하단 메타: 메뉴 + 영업상태 + 거리 */
.option-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 4px;
  font-size: 13px;
  color: var(--item-text-dim);
}
.option-menu-brief {
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.open-tag {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  padding: 2px 7px;
  border-radius: 6px;
  flex-shrink: 0;
}
.open-tag.open {
  background: var(--sage-bg);
  color: var(--sage);
}
.open-tag.closed {
  background: var(--accent-bg);
  color: var(--accent);
}
.option-dist {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text-muted);
  flex-shrink: 0;
}

/* 펼침 영역 */
.option-body {
  padding: 0 14px 14px;
  border-top: 1px solid var(--border);
  margin-top: 0;
  padding-top: 12px;
}
.option-info {
  font-size: 13px;
  color: var(--item-text-mid);
  padding: 3px 0;
  display: flex;
  justify-content: space-between;
}
.option-info-label {
  font-weight: 600;
  color: var(--item-text-dim);
  margin-right: 8px;
  flex-shrink: 0;
}
.option-map-link {
  display: flex;
  align-items: center;
  gap: 4px;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 500;
  color: var(--accent);
  text-decoration: none;
  margin-top: 10px;
  letter-spacing: 0.3px;
}
.option-map-link:active { opacity: 0.7; }

/* ═══ OPTION SIMPLE (fallback) ═══ */
.option-simple {
  padding: 10px 14px;
  border-radius: 14px;
  margin-bottom: 8px;
  font-family: var(--system);
  font-size: 14px;
  color: var(--item-text-mid);
  background: var(--bg-warm);
  border: 1px solid transparent;
}
.option-simple.chosen {
  background: var(--sage-bg);
  color: var(--sage);
  border-color: rgba(123,143,107,0.25);
}
.option-simple .option-name {
  font-family: var(--system);
  font-size: 14px;
}
.option-simple.chosen .option-name {
  color: var(--sage);
}

.option-badges { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
.badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 6px;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 0.2px;
}
.badge-dad-good { background: var(--sage-bg); color: var(--sage); }
.badge-dad-caution { background: var(--accent-bg); color: var(--accent); }
.badge-hiro-good { background: rgba(100,149,237,0.1); color: #6495ED; }
.badge-hiro-caution { background: var(--accent-bg); color: var(--accent); }

.chosen-tag {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  color: var(--sage);
  letter-spacing: 0.3px;
}

/* ═══ ITEM NOTE ═══ */
.item-note-row {
  padding: 12px 20px 14px;
  font-family: var(--system);
  font-size: 14px;
  color: var(--text-mid);
  border-top: 1px solid var(--border);
}
.item-note-label {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  color: var(--text-light);
  margin-bottom: 4px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

/* ═══ LOADING ═══ */
.loading {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-light);
  font-family: var(--system);
  font-size: 14px;
}
.loading .spinner {
  display: inline-block;
  width: 24px; height: 24px;
  border: 2px solid var(--border);
  border-top-color: var(--text);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ═══ ERROR ═══ */
.error-banner {
  max-width: 420px;
  margin: 0 auto;
  padding: 12px 16px;
  font-family: var(--system);
  font-size: 14px;
  text-align: center;
  color: var(--accent);
  background: var(--accent-bg);
  border-radius: var(--radius-btn);
  display: none;
}
.error-banner.show { display: block; margin-bottom: 12px; }

/* ═══ TOAST ═══ */
.toast {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: var(--text);
  color: #fff;
  padding: 14px 28px;
  border-radius: var(--radius-btn);
  font-family: var(--system);
  font-size: 15px;
  font-weight: 600;
  z-index: 400;
  transition: transform 0.3s;
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* ═══ LOCATION BANNER ═══ */
.location-banner {
  max-width: 420px;
  margin: 0 auto 16px;
  padding: 0 16px;
}
.location-banner .banner-device {
  background: var(--housing);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  overflow: hidden;
}
.location-banner .screen {
  background: var(--display);
  margin: 12px;
  border-radius: var(--radius-display);
  padding: 20px 16px;
  text-align: center;
}
.location-banner .screen p {
  font-family: var(--system);
  font-size: 15px;
  color: var(--display-text);
  line-height: 1.6;
}
.location-banner .banner-buttons {
  display: flex;
  gap: 10px;
  padding: 0 12px 12px;
}
.location-banner .btn-primary {
  flex: 1;
  padding: 12px 0;
  font-family: var(--system);
  font-size: 15px;
  font-weight: 700;
  color: var(--display-text);
  background: var(--display);
  border: none;
  border-radius: var(--radius-btn);
  cursor: pointer;
  min-height: 44px;
  box-shadow: var(--shadow-btn);
  transition: all 0.15s;
}
.location-banner .btn-primary:active { opacity: 0.8; transform:scale(0.98); }
.location-banner .btn-secondary {
  flex: 1;
  padding: 12px 0;
  font-family: var(--system);
  font-size: 15px;
  font-weight: 600;
  color: var(--text-mid);
  background: var(--housing);
  border: 1px solid var(--border-strong);
  border-radius: var(--radius-btn);
  cursor: pointer;
  min-height: 44px;
  transition: all 0.15s;
}
.location-banner .btn-secondary:active { opacity: 0.8; transform:scale(0.98); }

/* ═══ ITEM DISTANCE ═══ */
.item-distance {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 500;
  color: var(--item-text-dim);
  margin-top: 4px;
  letter-spacing: 0.2px;
}
.item-distance.nearby {
  color: var(--accent);
  font-weight: 600;
}
.item-distance.far-away {
  color: var(--text-light);
}

/* (option distance now integrated into .option-dist inside option-card) */

/* ═══ REFRESH BUTTON ═══ */
.refresh-btn {
  display: none;
  background: var(--housing);
  border: 1px solid var(--border-strong);
  border-radius: var(--radius-btn);
  padding: 5px 12px;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  color: var(--text-mid);
  cursor: pointer;
  margin-top: 8px;
  transition: all 0.15s;
  min-height: 28px;
  letter-spacing: 0.3px;
}
.refresh-btn:active { opacity: 0.7; transform:scale(0.97); }
.refresh-btn.visible { display: inline-block; }

/* ═══ REFERENCE ═══ */
.reference-section {
  margin-top: 12px;
}
.reference-section h3 {
  font-family: var(--serif);
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 14px;
  letter-spacing: -0.2px;
}
.ref-card {
  background: var(--housing);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  padding: 16px 20px;
  margin-bottom: 10px;
}
.ref-card h4 {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  color: var(--text-light);
  margin-bottom: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
}
.ref-card ul { list-style: none; }
.ref-card li {
  font-family: var(--system);
  font-size: 14px;
  padding: 5px 0;
  color: var(--text-mid);
  border-bottom: 1px solid var(--border);
}
.ref-card li:last-child { border-bottom: none; }

/* ═══ SPEAKER GRILLE (decorative) ═══ */
.grille {
  display: inline-grid;
  grid-template-columns: repeat(4, 4px);
  gap: 3px;
  opacity: 0.15;
}
.grille span {
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--text);
}

/* ═══ FOOTER SPACE ═══ */
.footer-space {
  height: 40px;
}

/* ═══ PLACE DETAIL (Activity Item 내부) ═══ */
.place-detail {
  border-radius: 14px;
  margin: 10px 0 8px;
  background: var(--bg-warm);
  border: 1px solid transparent;
  overflow: hidden;
  transition: box-shadow 0.3s, border-color 0.3s;
}
.place-detail[open] {
  border-color: var(--border);
  box-shadow: 0 2px 12px rgba(0,0,0,0.06);
}
.place-detail[open] .option-chevron {
  transform: rotate(90deg);
}
.place-detail summary {
  padding: 12px 14px;
  cursor: pointer;
  list-style: none;
  -webkit-tap-highlight-color: transparent;
}
.place-detail summary::-webkit-details-marker { display: none; }

.place-detail-top {
  display: flex;
  align-items: center;
  gap: 8px;
}
.place-detail-icon { font-size: 14px; }
.place-detail-name {
  font-family: var(--serif);
  font-size: 15px;
  font-weight: 600;
  color: var(--item-text);
  flex: 1;
  min-width: 0;
}
.place-detail-hours {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text-muted);
  flex-shrink: 0;
}
.place-detail-tags {
  display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap;
}
.place-tag {
  font-family: var(--mono);
  font-size: 10px;
  padding: 3px 8px;
  border-radius: 6px;
  background: var(--border);
  color: var(--text-mid);
}
.place-tag.baby { background: var(--accent-bg); color: var(--accent); }

.place-detail-body {
  padding: 0 14px 14px;
  border-top: 1px solid var(--border);
  padding-top: 12px;
}
.place-body-label {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  color: var(--text-muted);
  letter-spacing: 0.3px;
  margin: 12px 0 6px;
  text-transform: uppercase;
}
.place-body-label:first-child { margin-top: 0; }
.place-info-row {
  font-size: 13px;
  color: var(--item-text-mid);
  padding: 3px 0;
}
.place-info-label {
  font-weight: 600;
  color: var(--item-text-dim);
  margin-right: 8px;
}
.place-list {
  margin: 0; padding-left: 16px;
  font-size: 13px; color: var(--item-text-mid);
  line-height: 1.7;
}

/* ═══ FONT SIZE TRIGGER ═══ */
.font-size-trigger {
  position: fixed;
  top: 12px;
  right: 60px;
  z-index: 200;
  width: 36px; height: 36px; border-radius: 50%;
  border: 1.5px solid var(--border-strong);
  background: var(--housing);
  color: var(--text-mid);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: all 0.2s;
  font-family: var(--serif);
  font-size: 14px;
  font-weight: 700;
}
.font-size-trigger:active { transform: scale(0.9); }

:root[data-fontsize="small"] { --base-font: 14px; }
:root[data-fontsize="large"] { --base-font: 18px; }

/* ═══ CHAT BUBBLE & SHEET ═══ */
.chat-fab {
  position: fixed; bottom: 24px; right: 20px; z-index: 300;
  width: 52px; height: 52px; border-radius: 50%;
  background: var(--accent); color: #fff; border: none;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 16px rgba(196,93,62,0.35);
  transition: transform 0.2s, box-shadow 0.2s;
}
.chat-fab:active { transform: scale(0.9); }
.chat-fab svg { width: 24px; height: 24px; }
.chat-fab.hidden { display: none; }

.chat-overlay {
  position: fixed; inset: 0; z-index: 400;
  background: rgba(0,0,0,0.3); backdrop-filter: blur(2px);
  opacity: 0; pointer-events: none; transition: opacity 0.25s;
}
.chat-overlay.open { opacity: 1; pointer-events: auto; }

.chat-sheet {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 401;
  max-width: 480px; margin: 0 auto;
  height: 65vh; max-height: 520px;
  background: var(--bg);
  border-radius: 20px 20px 0 0;
  box-shadow: 0 -4px 32px rgba(0,0,0,0.12);
  display: flex; flex-direction: column;
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
}
.chat-sheet.open { transform: translateY(0); }

.chat-sheet-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 20px 12px;
  border-bottom: 1px solid var(--border);
}
.chat-sheet-title {
  font-family: var(--serif); font-size: 16px; font-weight: 600;
  color: var(--text);
}
.chat-sheet-subtitle {
  font-family: var(--mono); font-size: 11px;
  color: var(--text-muted); margin-top: 2px;
}
.chat-close-btn {
  width: 32px; height: 32px; border-radius: 50%;
  border: 1px solid var(--border); background: var(--housing);
  color: var(--text-mid); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}

.chat-messages {
  flex: 1; overflow-y: auto; padding: 16px 16px 8px;
  display: flex; flex-direction: column; gap: 10px;
  -webkit-overflow-scrolling: touch;
}

.chat-msg {
  max-width: 85%; padding: 10px 14px;
  border-radius: 16px; font-size: 14px; line-height: 1.55;
  font-family: var(--serif); word-break: break-word;
}
.chat-msg.user {
  align-self: flex-end;
  background: var(--accent); color: #fff;
  border-bottom-right-radius: 4px;
}
.chat-msg.bot {
  align-self: flex-start;
  background: var(--housing); color: var(--text);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}
.chat-msg.bot .msg-label {
  font-family: var(--mono); font-size: 10px;
  color: var(--accent); margin-bottom: 4px; font-weight: 500;
}
.chat-msg.typing .dots span {
  display: inline-block; width: 6px; height: 6px;
  background: var(--text-muted); border-radius: 50%;
  margin: 0 2px; animation: dotBounce 1.2s infinite;
}
.chat-msg.typing .dots span:nth-child(2) { animation-delay: 0.2s; }
.chat-msg.typing .dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes dotBounce {
  0%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-6px); }
}

.chat-msg.error {
  align-self: center; max-width: 90%;
  background: rgba(196,93,62,0.08); color: var(--accent);
  font-size: 12px; text-align: center;
  border-radius: 10px; border: 1px solid rgba(196,93,62,0.15);
}

.chat-input-row {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 16px 14px;
  border-top: 1px solid var(--border);
  background: var(--bg);
}
.chat-input {
  flex: 1; border: 1.5px solid var(--border-strong);
  border-radius: 20px; padding: 10px 16px;
  font-family: var(--serif); font-size: 14px;
  background: var(--housing); color: var(--text);
  outline: none; resize: none; max-height: 80px;
}
.chat-input:focus { border-color: var(--accent); }
.chat-input::placeholder { color: var(--text-muted); }
.chat-send-btn {
  width: 38px; height: 38px; border-radius: 50%;
  background: var(--accent); color: #fff; border: none;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: opacity 0.15s;
  flex-shrink: 0;
}
.chat-send-btn:disabled { opacity: 0.4; cursor: default; }
.chat-send-btn svg { width: 18px; height: 18px; }

.chat-welcome {
  text-align: center; padding: 32px 20px;
  color: var(--text-mid); font-family: var(--serif);
}
.chat-welcome-icon { font-size: 32px; margin-bottom: 12px; }
.chat-welcome-title { font-size: 15px; font-weight: 600; margin-bottom: 6px; color: var(--text); }
.chat-welcome-desc { font-size: 13px; line-height: 1.6; }
.chat-welcome-hints {
  display: flex; flex-wrap: wrap; gap: 6px;
  justify-content: center; margin-top: 16px;
}
.chat-hint-chip {
  font-family: var(--mono); font-size: 11px;
  padding: 6px 12px; border-radius: 20px;
  background: var(--housing); border: 1px solid var(--border-strong);
  color: var(--text-mid); cursor: pointer;
  transition: all 0.15s;
}
.chat-hint-chip:hover { background: var(--accent-bg); color: var(--accent); border-color: var(--accent); }
</style>
</head>
<body>

<!-- 글자 크기 -->
<button class="font-size-trigger" id="fontSizeTrigger" onclick="cycleFontSize()" aria-label="글자 크기">가</button>

<!-- 테마 토글 -->
<button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="테마 전환">
  <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
</button>

<!-- 메인 앱 -->
<div id="mainApp">
  <div class="header">
    <h1>경주 가족여행</h1>
    <div class="sub-info">
      <span id="tripStatus">2026.02.19 — 02.24</span>
    </div>
    <div class="update-time" id="updateTime"></div>
    <div style="margin-top:12px"><a href="/guide" style="font-family:var(--mono);font-size:12px;font-weight:500;color:var(--text-mid);text-decoration:none;border:1px solid var(--border-strong);border-radius:var(--radius-btn);padding:8px 18px;background:var(--housing);display:inline-block;letter-spacing:0.5px;transition:all 0.15s">가이드 보기</a></div>
    <button class="refresh-btn" id="refreshBtn" onclick="requestLocation()">위치 갱신</button>
  </div>

  <!-- 위치 안내 배너 -->
  <div class="location-banner" id="locationBanner" style="display:none;">
    <div class="banner-device">
      <div class="screen">
        <p>위치를 켜면 각 장소까지<br>거리를 확인할 수 있습니다</p>
      </div>
      <div class="banner-buttons">
        <button class="btn-primary" onclick="requestLocation()">위치 켜기</button>
        <button class="btn-secondary" onclick="dismissLocationBanner()">괜찮습니다</button>
      </div>
    </div>
  </div>

  <div class="error-banner" id="errorBanner"></div>

  <div class="day-tabs" id="dayTabs"></div>

  <div class="device">
    <div id="contentArea">
      <div class="loading">
        <div class="spinner"></div>
        <div>일정 불러오는 중...</div>
      </div>
    </div>
  </div>
</div>

<!-- 토스트 -->
<div class="toast" id="toast"></div>

<script>
// ═══ 테마 초기화 ═══
function initTheme(){
  var saved=localStorage.getItem('gj_theme');
  if(saved) document.documentElement.setAttribute('data-theme',saved);
  updateThemeIcon();
}
function toggleTheme(){
  var current=document.documentElement.getAttribute('data-theme');
  var isDark=current==='dark'||(!current&&window.matchMedia('(prefers-color-scheme:dark)').matches);
  var next=isDark?'light':'dark';
  document.documentElement.setAttribute('data-theme',next);
  localStorage.setItem('gj_theme',next);
  updateThemeIcon();
}
function updateThemeIcon(){
  var theme=document.documentElement.getAttribute('data-theme');
  var isDark=theme==='dark'||(!theme&&window.matchMedia('(prefers-color-scheme:dark)').matches);
  var el=document.getElementById('themeIcon');
  if(el) el.innerHTML=isDark
    ?'<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>'
    :'<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
}
initTheme();

// ═══ 글자 크기 ═══
var fontSizes = ['medium', 'large', 'small'];

function initFontSize() {
  var saved = localStorage.getItem('gj_fontsize') || 'medium';
  document.documentElement.setAttribute('data-fontsize', saved);
  updateFontSizeIcon(saved);
}

function cycleFontSize() {
  var current = document.documentElement.getAttribute('data-fontsize') || 'medium';
  var idx = fontSizes.indexOf(current);
  var next = fontSizes[(idx + 1) % fontSizes.length];
  document.documentElement.setAttribute('data-fontsize', next);
  localStorage.setItem('gj_fontsize', next);
  updateFontSizeIcon(next);
}

function updateFontSizeIcon(size) {
  var btn = document.getElementById('fontSizeTrigger');
  if (!btn) return;
  var labels = { small: '가-', medium: '가', large: '가+' };
  btn.textContent = labels[size];
}

initFontSize();

// ═══ STAY_DATA (guide.html에서 복사) ═══
var STAY_DATA = {
  name: '까사멜로우', nameEn: 'Casa Mellow',
  desc: '아이와 함께하는 서툰 여행을 응원하며',
  address: '경상북도 경주시 북군4길 75',
  phone: '010-3583-6648', email: 'ssoong6648@naver.com',
  instagram: '@casa.mellow',
  checkin: '15:30', checkout: '11:00',
  parking: '건물 외부 전용 주차장',
  mapUrl: 'https://map.naver.com/p/search/까사멜로우 경주',
  stayfolioUrl: 'https://www.stayfolio.com/findstay/casa-mellow',
  rooms: [
    { name: 'A-1', type: '복층', people: '4/8명', bed: 'Q2 + S1', bath: '2.5', price: '289,000~' },
    { name: 'A-2', type: '복층', people: '4/8명', bed: 'Q2 + S1', bath: '2.5', price: '329,000~' },
    { name: 'B', type: '독채', people: '4/8명', bed: '4개', bath: '2', price: '329,000~' }
  ],
  amenities: {
    kitchen: ['인덕션', '전자레인지', '식기세척기', '토스터기', '캡슐커피머신', '전기포트', '제빙기', '조리도구', '기본조미료', '와인잔'],
    bath: ['샴푸', '컨디셔너', '바디워시', '핸드워시', '치약', '타월', '샤워가운'],
    general: ['TV', '냉장고', '세탁기', '헤어드라이어', '스피커', '슬리퍼', '생수'],
    baby: ['젖병소독기', '유아용 어메니티', '유아 샤워용품', '키즈가구']
  },
  kids: ['실내 키즈룸 (미끄럼틀, 놀이기구)', '야외 모래 놀이터', '미니 바이킹', '전 객실 키즈 어메니티'],
  pool: { depth: '약 70cm', note: '온수 풀 · 사계절 이용 · 시간 제한 없음 · 보호자 동반 필수' },
  bbq: { note: '무료 이용 · 전기그릴 기본 제공 · 시간 제한 없음', extra: '웨버 가스그릴 추가 가능 (유료)' },
  rules: ['전 공간 절대 금연', '실내 냄새나는 음식 조리 금지', '퇴실 전 정리 및 분리수거', '야간 소음 주의', '24개월 미만 영유아 무료', '기준인원 초과 시 1인 1박 30,000원']
};

// ═══ 홈플러스 guide 데이터 패치 ═══
function patchGuideData(days) {
  days.forEach(function(day) {
    day.items.forEach(function(item) {
      if (item.title && item.title.indexOf('홈플러스') !== -1 && !item.guide) {
        item.guide = {
          subtitle: '경주 유일의 대형 할인점 · 2024 메가푸드마켓 리뉴얼',
          mustDo: ['BBQ 식재료·간식·음료 장보기', '아기 간식·이유식 재료 확보'],
          babyTips: {
            stroller: '단층 매장이라 유모차 이동 편리',
            nursingRoom: '매장 내 수유실 (전화확인: 054-770-8000)',
            restSpots: ['수퍼윙스 키즈카페 (1층)']
          },
          practicalInfo: {
            hours: '09:00~22:00',
            parking: '1층 고객주차장 + 2층 옥상주차장 (유료, 구매시 무료)',
            phone: '054-770-8000',
            closedDays: '매월 둘째·넷째 일요일 (\u26A0\uFE0F 2/22 휴무!)',
            address: '경상북도 경주시 공단로 97',
            fromAccommodation: '까사멜로우에서 차량 약 15분',
            mapUrl: 'https://map.naver.com/p/search/홈플러스%20경주점'
          }
        };
      }
    });
  });
}

// ═══ 장소 상세 카드 (activity 아이템 내부) ═══
function isStayItem(item) {
  if (!item.title) return false;
  return item.title.indexOf('체크인') !== -1 || item.title.indexOf('정착') !== -1;
}

function renderPlaceDetail(item) {
  if (isStayItem(item)) return renderStayDetail();
  var g = item.guide;
  if (!g) return '';

  var html = '<details class="place-detail">';
  html += '<summary>';
  html += '<div class="place-detail-top">';
  html += '<span class="place-detail-icon">\uD83D\uDCCD</span>';
  html += '<span class="place-detail-name">' + escapeHtml(g.subtitle || item.title) + '</span>';
  if (g.practicalInfo && g.practicalInfo.hours) {
    html += '<span class="place-detail-hours">' + escapeHtml(g.practicalInfo.hours) + '</span>';
  }
  html += '<div class="option-chevron"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 18l6-6-6-6"/></svg></div>';
  html += '</div>';

  // summary 태그들
  var tags = [];
  if (g.practicalInfo && g.practicalInfo.parking) tags.push('주차 가능');
  if (g.babyTips && g.babyTips.stroller) tags.push({text: '유모차 OK', cls: 'baby'});
  if (g.babyTips && g.babyTips.nursingRoom) tags.push({text: '수유실', cls: 'baby'});
  if (tags.length) {
    html += '<div class="place-detail-tags">';
    tags.forEach(function(t) {
      if (typeof t === 'string') html += '<span class="place-tag">' + t + '</span>';
      else html += '<span class="place-tag ' + t.cls + '">' + t.text + '</span>';
    });
    html += '</div>';
  }
  html += '</summary>';

  html += '<div class="place-detail-body">';

  // 필수 체험
  if (g.mustDo && g.mustDo.length) {
    html += '<div class="place-body-label">꼭 할 것</div><ul class="place-list">';
    g.mustDo.forEach(function(m) { html += '<li>' + escapeHtml(m) + '</li>'; });
    html += '</ul>';
  }

  // 아기 팁
  if (g.babyTips && Object.keys(g.babyTips).length) {
    html += '<div class="place-body-label">아기 동반 팁</div>';
    var bt = g.babyTips;
    if (bt.stroller) html += '<div class="place-info-row"><span class="place-info-label">유모차</span>' + escapeHtml(bt.stroller) + '</div>';
    if (bt.nursingRoom) html += '<div class="place-info-row"><span class="place-info-label">수유실</span>' + escapeHtml(bt.nursingRoom) + '</div>';
    if (bt.restroom) html += '<div class="place-info-row"><span class="place-info-label">화장실</span>' + escapeHtml(bt.restroom) + '</div>';
    if (bt.restSpots && bt.restSpots.length) {
      html += '<div class="place-info-row"><span class="place-info-label">쉴 곳</span>' + bt.restSpots.map(escapeHtml).join(', ') + '</div>';
    }
    if (bt.recommendedRoute) html += '<div class="place-info-row"><span class="place-info-label">추천 동선</span>' + escapeHtml(bt.recommendedRoute) + '</div>';
  }

  // 실용 정보
  if (g.practicalInfo) {
    html += '<div class="place-body-label">실용 정보</div>';
    var pi = g.practicalInfo;
    if (pi.address) html += '<div class="place-info-row"><span class="place-info-label">주소</span>' + escapeHtml(pi.address) + '</div>';
    if (pi.hours) html += '<div class="place-info-row"><span class="place-info-label">영업시간</span>' + escapeHtml(pi.hours) + '</div>';
    if (pi.fee) html += '<div class="place-info-row"><span class="place-info-label">입장료</span>' + escapeHtml(pi.fee) + '</div>';
    if (pi.phone) html += '<div class="place-info-row"><span class="place-info-label">전화</span>' + escapeHtml(pi.phone) + '</div>';
    if (pi.parking) html += '<div class="place-info-row"><span class="place-info-label">주차</span>' + escapeHtml(pi.parking) + '</div>';
    if (pi.timeNeeded) html += '<div class="place-info-row"><span class="place-info-label">소요시간</span>' + escapeHtml(pi.timeNeeded) + '</div>';
    if (pi.closedDays) html += '<div class="place-info-row"><span class="place-info-label">휴무</span>' + escapeHtml(pi.closedDays) + '</div>';
    if (pi.fromAccommodation) html += '<div class="place-info-row"><span class="place-info-label">숙소에서</span>' + escapeHtml(pi.fromAccommodation) + '</div>';
  }

  // 지도 링크
  var mapUrl = (g.practicalInfo && g.practicalInfo.mapUrl) || '';
  if (!mapUrl && item.options && item.options[0] && item.options[0].mapUrl) mapUrl = item.options[0].mapUrl;
  if (mapUrl) {
    html += '<a class="option-map-link" href="' + escapeAttr(mapUrl) + '" target="_blank">지도에서 보기 <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a>';
  }

  html += '</div></details>';
  return html;
}

function renderStayDetail() {
  if (typeof STAY_DATA === 'undefined') return '';
  var s = STAY_DATA;
  var html = '<details class="place-detail stay-detail">';
  html += '<summary><div class="place-detail-top">';
  html += '<span class="place-detail-icon">\uD83C\uDFE0</span>';
  html += '<span class="place-detail-name">' + escapeHtml(s.name) + '</span>';
  html += '<span class="place-detail-hours">체크인 ' + escapeHtml(s.checkin) + '</span>';
  html += '<div class="option-chevron"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 18l6-6-6-6"/></svg></div>';
  html += '</div></summary>';
  html += '<div class="place-detail-body">';
  html += '<div class="place-info-row"><span class="place-info-label">주소</span>' + escapeHtml(s.address) + '</div>';
  html += '<div class="place-info-row"><span class="place-info-label">전화</span>' + escapeHtml(s.phone) + '</div>';
  html += '<div class="place-info-row"><span class="place-info-label">체크인/아웃</span>' + s.checkin + ' / ' + s.checkout + '</div>';
  html += '<div class="place-info-row"><span class="place-info-label">주차</span>' + escapeHtml(s.parking) + '</div>';
  if (s.kids && s.kids.length) {
    html += '<div class="place-body-label">키즈 시설</div><ul class="place-list">';
    s.kids.forEach(function(k) { html += '<li>' + escapeHtml(k) + '</li>'; });
    html += '</ul>';
  }
  if (s.amenities && s.amenities.baby && s.amenities.baby.length) {
    html += '<div class="place-body-label">아기 용품</div>';
    html += '<div class="place-info-row">' + s.amenities.baby.map(escapeHtml).join(', ') + '</div>';
  }
  if (s.pool) {
    html += '<div class="place-body-label">풀장</div>';
    html += '<div class="place-info-row">' + escapeHtml(s.pool.note) + '</div>';
  }
  if (s.mapUrl) {
    html += '<a class="option-map-link" href="' + escapeAttr(s.mapUrl) + '" target="_blank">지도에서 보기 ↗</a>';
  }
  html += '</div></details>';
  return html;
}

const POLL_INTERVAL = 30000;

let travelData = null;
let activeDay = 0;
let pollTimer = null;

// 앱 시작
(function init() {
  fetchData();
  pollTimer = setInterval(fetchData, POLL_INTERVAL);
})();

async function fetchData() {
  try {
    const res = await fetch('/api/data');
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    const json = await res.json();
    travelData = json.record;
    hideError();
    render();
  } catch (e) {
    showError('연결 끊김. 다시 시도 중...');
    console.error('fetch error:', e);
  }
}

function render() {
  if (!travelData) return;
  updateHeader();
  renderTabs();
  renderDayContent();
}

function updateHeader() {
  const meta = travelData.meta;
  if (meta && meta.lastUpdated) {
    const d = new Date(meta.lastUpdated);
    document.getElementById('updateTime').textContent =
      `마지막 업데이트: ${formatDateTime(d)}`;
  }
  // URL query param으로 특정 일자 선택 (?day=2)
  const urlParams = new URLSearchParams(location.search);
  const dayParam = urlParams.get('day');
  if (dayParam && !window._dayParamApplied) {
    const d = parseInt(dayParam);
    if (d >= 1 && d <= travelData.days.length) {
      activeDay = d - 1;
      window._dayParamApplied = true;
    }
  }

  const now = new Date();
  const tripStart = new Date('2026-02-19T00:00:00+09:00');
  const tripEnd = new Date('2026-02-24T23:59:59+09:00');
  let status = '2026.02.19 — 02.24';
  if (now < tripStart) {
    const diff = Math.ceil((tripStart - now) / 86400000);
    status = `D-${diff} / 2026.02.19 — 02.24`;
  } else if (now > tripEnd) {
    status = '여행 완료';
  } else {
    const dayNum = Math.floor((now - tripStart) / 86400000) + 1;
    status = `${dayNum}일차 진행 중`;
    if (activeDay === 0 && !dayParam) activeDay = dayNum - 1;
  }
  document.getElementById('tripStatus').textContent = status;
}

function renderTabs() {
  const tabs = document.getElementById('dayTabs');
  const days = travelData.days;
  tabs.innerHTML = '';
  days.forEach((day, idx) => {
    const tab = document.createElement('div');
    tab.className = 'day-tab' + (idx === activeDay ? ' active' : '');
    tab.innerHTML = `${day.dayNum}일차<span class="tab-date">${formatTabDate(day.date, day.dow)}</span>`;
    tab.onclick = () => { activeDay = idx; renderTabs(); renderDayContent(); };
    tabs.appendChild(tab);
  });
  const activeTab = tabs.querySelector('.active');
  if (activeTab) activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
}

function renderDayContent() {
  patchGuideData(travelData.days);
  const area = document.getElementById('contentArea');
  const day = travelData.days[activeDay];
  if (!day) { area.innerHTML = '<div class="loading">데이터 없음</div>'; return; }

  const totalItems = day.items.length;
  const doneItems = day.items.filter(i => i.status === 'done' || i.status === 'skipped').length;
  const progress = totalItems > 0 ? (doneItems / totalItems * 100) : 0;

  let html = '';

  // 메인 디스플레이 카드
  html += '<div class="display-card">';
  html += '<div class="display-screen">';
  html += '<div class="display-header">';
  html += `<span class="display-label">일정</span>`;
  html += '<div class="display-indicator">';
  for (let i = 0; i < totalItems; i++) {
    html += `<span class="${i < doneItems ? 'on' : ''}"></span>`;
  }
  html += '</div></div>';
  html += `<div class="day-title-display">${day.title}</div>`;
  html += `<div class="day-subtitle">${day.dayNum}일차 / ${doneItems}/${totalItems} 완료</div>`;
  html += '</div>';

  // 진행 레벨 미터
  html += '<div class="level-meter">';
  html += `<div class="meter-bar"><div class="meter-fill" style="width:${progress}%"></div></div>`;
  html += '<div class="meter-ticks">';
  html += '<span class="meter-tick">0%</span>';
  html += `<span class="meter-tick" style="color:var(--accent)">${Math.round(progress)}%</span>`;
  html += '<span class="meter-tick">100%</span>';
  html += '</div></div>';

  html += '</div>';

  // 일정 아이템 카드들
  html += '<div class="items-list">';
  day.items.forEach((item) => {
    html += renderItemCard(item);
  });
  html += '</div>';

  // reference 섹션
  if (activeDay === travelData.days.length - 1 && travelData.reference) {
    html += renderReference(travelData.reference);
  }

  area.innerHTML = html;
}

// ═══ 영업 상태 파싱 (guide.html에서 포팅) ═══
function parseOpenClosed(hoursStr) {
  if (!hoursStr) return null;
  var m = hoursStr.match(/(\d{1,2}):?(\d{2})?\s*[~\-]\s*(\d{1,2}):?(\d{2})?/);
  if (!m) return null;
  var now = new Date();
  var nowMin = now.getHours() * 60 + now.getMinutes();
  var openMin = parseInt(m[1]) * 60 + (m[2] ? parseInt(m[2]) : 0);
  var closeMin = parseInt(m[3]) * 60 + (m[4] ? parseInt(m[4]) : 0);
  return nowMin >= openMin && nowMin < closeMin
    ? { status: 'open', text: '영업중' }
    : { status: 'closed', text: '영업종료' };
}

// ═══ 옵션 카드 렌더링 (enriched data) ═══
function renderOptionCard(opt, item) {
  const isChosen = item.chosen && item.chosen === opt.name;
  const showOptionDist = userLat && !(getItemDistance(item) && getItemDistance(item).km >= 50);

  let html = '<details class="option-card' + (isChosen ? ' chosen' : '') + '"' + (isChosen ? ' open' : '') + '>';
  html += '<summary>';

  // 상단: 이름 + 별점 + 확정 + chevron
  html += '<div class="option-top">';
  html += '<span class="option-name">' + escapeHtml(opt.name) + '</span>';
  if (opt.rating) html += '<span class="option-rating">' + opt.rating + '</span>';
  if (isChosen) html += '<span class="chosen-tag">확정</span>';
  html += '<div class="option-chevron"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M9 18l6-6-6-6"/></svg></div>';
  html += '</div>';

  // 메타: 메뉴 + 영업상태 + 거리
  html += '<div class="option-meta">';
  if (opt.menu) html += '<span class="option-menu-brief">' + escapeHtml(opt.menu) + '</span>';
  if (opt.hours) {
    var oc = parseOpenClosed(opt.hours);
    if (oc) html += '<span class="open-tag ' + oc.status + '">' + oc.text + '</span>';
  }
  if (showOptionDist && opt.lat && opt.lng) {
    var km = haversineDistance(userLat, userLng, opt.lat, opt.lng);
    html += '<span class="option-dist">' + (km < 1 ? km.toFixed(1) : Math.round(km)) + 'km</span>';
  }
  html += '</div>';
  html += '</summary>';

  // 펼침 영역
  html += '<div class="option-body">';

  // 메뉴 상세
  if (opt.menuDetail && opt.menuDetail.length) {
    opt.menuDetail.forEach(function(m) {
      html += '<div class="option-info">' + escapeHtml(m.item);
      if (m.price) html += '<span>' + Number(m.price).toLocaleString() + '원</span>';
      html += '</div>';
    });
  }

  // 가격대
  if (opt.priceRange) {
    html += '<div class="option-info"><span class="option-info-label">가격대</span>' + escapeHtml(opt.priceRange) + '</div>';
  }

  // 영업시간
  if (opt.hours) {
    html += '<div class="option-info"><span class="option-info-label">영업시간</span>' + escapeHtml(opt.hours) + '</div>';
  }

  // 위치
  if (opt.loc) {
    html += '<div class="option-info"><span class="option-info-label">위치</span>' + escapeHtml(opt.loc) + '</div>';
  }

  // 뱃지
  var badges = [];
  if (opt.dad === 'good') badges.push('<span class="badge badge-dad-good">아빠 OK</span>');
  if (opt.dad === 'caution') badges.push('<span class="badge badge-dad-caution">아빠 주의' + (opt.dadNote ? ' · ' + escapeHtml(opt.dadNote) : '') + '</span>');
  if (opt.hiro === 'good') badges.push('<span class="badge badge-hiro-good">히로 OK</span>');
  if (opt.hiro === 'caution') badges.push('<span class="badge badge-hiro-caution">히로 주의' + (opt.hiroNote ? ' · ' + escapeHtml(opt.hiroNote) : '') + '</span>');
  if (badges.length) html += '<div class="option-badges">' + badges.join('') + '</div>';

  // 지도 링크
  if (opt.mapUrl) {
    html += '<a class="option-map-link" href="' + escapeAttr(opt.mapUrl) + '" target="_blank">지도에서 보기 <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a>';
  }

  html += '</div></details>';
  return html;
}

// ═══ 단순 옵션 렌더링 (non-enriched fallback) ═══
function renderSimpleOption(opt, item) {
  const isChosen = item.chosen && item.chosen === opt.name;
  let html = '<div class="option-simple' + (isChosen ? ' chosen' : '') + '">';
  html += '<span class="option-name">' + escapeHtml(opt.name) + '</span>';
  if (opt.menu) html += ' <span class="option-menu-brief" style="color:var(--item-text-dim);font-size:13px">— ' + escapeHtml(opt.menu) + '</span>';
  if (isChosen) html += ' <span class="chosen-tag">확정</span>';

  // 뱃지
  var badges = [];
  if (opt.dad === 'good') badges.push('<span class="badge badge-dad-good">아빠 OK</span>');
  if (opt.dad === 'caution') badges.push('<span class="badge badge-dad-caution">아빠 주의' + (opt.dadNote ? ' · ' + escapeHtml(opt.dadNote) : '') + '</span>');
  if (opt.hiro === 'good') badges.push('<span class="badge badge-hiro-good">히로 OK</span>');
  if (opt.hiro === 'caution') badges.push('<span class="badge badge-hiro-caution">히로 주의' + (opt.hiroNote ? ' · ' + escapeHtml(opt.hiroNote) : '') + '</span>');
  if (badges.length) html += '<div class="option-badges">' + badges.join('') + '</div>';

  html += '</div>';
  return html;
}

function renderItemCard(item) {
  const catLabel = { meal: '식사', cafe: '카페', activity: '관광' };
  const titleClass = item.status === 'skipped' ? ' skipped' : '';

  let html = `<div class="item-card">`;
  html += '<div class="item-display">';

  // 상단 행
  html += '<div class="item-top-row">';
  html += `<span class="item-status-dot ${item.status}"></span>`;
  html += `<span class="item-time">${item.time || ''}</span>`;
  html += `<span class="item-cat-label">${catLabel[item.cat] || ''}</span>`;
  html += '</div>';

  // 제목
  html += `<div class="item-title${titleClass}">${item.title}</div>`;

  // 장소 상세 카드
  if (item.cat === 'activity') {
    html += renderPlaceDetail(item);
  }

  // 거리 행 (위치 활성화 시)
  if (userLat && item.options && item.options.length > 0) {
    const distInfo = getItemDistance(item);
    if (distInfo && distInfo.km < 50) {
      const fmt = formatDistance(distInfo.km);
      html += `<div class="item-distance ${fmt.cls}">${fmt.text}</div>`;
    } else if (distInfo && distInfo.km >= 50) {
      html += `<div class="item-distance far-away">${formatDistance(distInfo.km).text}</div>`;
    }
  }

  // 옵션 목록
  if (item.options && item.options.length > 0) {
    html += '<div class="options-list">';
    item.options.forEach(opt => {
      const hasRichData = opt.rating || opt.menuDetail || opt.hours || opt.mapUrl;
      if (hasRichData) {
        html += renderOptionCard(opt, item);
      } else {
        html += renderSimpleOption(opt, item);
      }
    });
    html += '</div>';
  }

  html += '</div>'; // item-display

  // 메모
  if (item.note) {
    html += '<div class="item-note-row">';
    html += '<div class="item-note-label">메모</div>';
    html += escapeHtml(item.note);
    html += '</div>';
  }

  html += '</div>';
  return html;
}

function renderReference(ref) {
  let html = '<div class="reference-section"><h3>참고 정보</h3>';

  if (ref.distances && ref.distances.length) {
    html += '<div class="ref-card"><h4>거리 / 소요시간</h4><ul>';
    ref.distances.forEach(d => { html += `<li>${typeof d === 'string' ? d : JSON.stringify(d)}</li>`; });
    html += '</ul></div>';
  }
  if (ref.contacts && ref.contacts.length) {
    html += '<div class="ref-card"><h4>연락처</h4><ul>';
    ref.contacts.forEach(c => { html += `<li>${typeof c === 'string' ? c : JSON.stringify(c)}</li>`; });
    html += '</ul></div>';
  }
  if (ref.shopping && ref.shopping.length) {
    html += '<div class="ref-card"><h4>쇼핑</h4><ul>';
    ref.shopping.forEach(s => { html += `<li>${typeof s === 'string' ? s : JSON.stringify(s)}</li>`; });
    html += '</ul></div>';
  }

  html += '</div>';
  return html;
}

// 유틸
function formatDateTime(d) {
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  const hh = String(d.getHours()).padStart(2, '0');
  const mi = String(d.getMinutes()).padStart(2, '0');
  return `${mm}.${dd} ${hh}:${mi}`;
}

function formatTabDate(dateStr, dow) {
  const parts = dateStr.split('-');
  return `${parseInt(parts[1])}/${parseInt(parts[2])}`;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function escapeAttr(str) {
  return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function showError(msg) {
  const el = document.getElementById('errorBanner');
  el.textContent = msg;
  el.classList.add('show');
}
function hideError() {
  document.getElementById('errorBanner').classList.remove('show');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// ═══ 위치 / 거리 기능 ═══

let userLat = null;
let userLng = null;
let locationTimestamp = 0;
let gpsWarningShown = false;

const GEO_OPTIONS = {
  enableHighAccuracy: false,
  timeout: 10000,
  maximumAge: 300000
};

// 위치 배너 표시 (페이지 로드 1초 후)
function initLocationBanner() {
  // HTTPS 아닌 환경 또는 Geolocation 미지원 시 배너 미표시
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') return;
  if (!navigator.geolocation) return;
  // 이미 거부한 경우 미표시
  if (localStorage.getItem('gj_location_dismissed') === 'true') return;

  setTimeout(() => {
    document.getElementById('locationBanner').style.display = '';
  }, 1000);
}

// [위치 켜기] 클릭
function requestLocation() {
  if (!navigator.geolocation) {
    showToast('이 브라우저에서 위치를 사용할 수 없습니다');
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      userLat = pos.coords.latitude;
      userLng = pos.coords.longitude;
      locationTimestamp = Date.now();

      // 배너 숨김
      document.getElementById('locationBanner').style.display = 'none';

      // 갱신 버튼 표시
      document.getElementById('refreshBtn').classList.add('visible');

      // GPS 정확도 경고 (500m 이상, 1회만)
      if (pos.coords.accuracy > 500 && !gpsWarningShown) {
        gpsWarningShown = true;
        showToast('위치가 정확하지 않을 수 있습니다');
      }

      updateDistances();
    },
    (err) => {
      if (err.code === err.TIMEOUT) {
        showToast('위치를 가져올 수 없습니다');
      } else if (err.code === err.PERMISSION_DENIED) {
        document.getElementById('locationBanner').style.display = 'none';
      } else {
        showToast('위치를 가져올 수 없습니다');
      }
    },
    GEO_OPTIONS
  );
}

// [괜찮습니다] 클릭
function dismissLocationBanner() {
  localStorage.setItem('gj_location_dismissed', 'true');
  document.getElementById('locationBanner').style.display = 'none';
}

// Haversine 거리 계산 (km)
function haversineDistance(lat1, lng1, lat2, lng2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2)
    + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180)
    * Math.sin(dLng / 2) * Math.sin(dLng / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// 거리 포맷
function formatDistance(km) {
  if (km >= 50) return { text: '현재 경주 근처가 아닙니다', cls: 'far-away' };
  if (km < 1) {
    const walkMin = Math.round((km * 1000) / 67);
    return { text: '도보 약 ' + walkMin + '분 (' + km.toFixed(1) + 'km)', cls: 'nearby' };
  }
  const driveMin = Math.round(km / 30 * 60);
  if (km < 5) return { text: '약 ' + km.toFixed(1) + 'km · 차량 약 ' + driveMin + '분', cls: '' };
  return { text: '약 ' + Math.round(km) + 'km · 차량 약 ' + driveMin + '분', cls: '' };
}

// 아이템 대표 거리 계산 (chosen 옵션 우선, 없으면 가장 가까운 옵션)
function getItemDistance(item) {
  if (!userLat || !item.options || item.options.length === 0) return null;

  // 좌표가 있는 옵션만 필터
  const withCoords = item.options.filter(o => o.lat && o.lng);
  if (withCoords.length === 0) return null;

  // chosen 옵션이 좌표가 있으면 우선
  if (item.chosen) {
    const chosen = withCoords.find(o => o.name === item.chosen);
    if (chosen) {
      return { km: haversineDistance(userLat, userLng, chosen.lat, chosen.lng), name: chosen.name };
    }
  }

  // 가장 가까운 옵션
  let closest = null;
  let minKm = Infinity;
  withCoords.forEach(o => {
    const km = haversineDistance(userLat, userLng, o.lat, o.lng);
    if (km < minKm) { minKm = km; closest = o; }
  });
  return closest ? { km: minKm, name: closest.name } : null;
}

// 거리 업데이트 (렌더링 재실행)
function updateDistances() {
  if (travelData) renderDayContent();
  showToast('위치 업데이트됨');
}

// visibilitychange: 30분 경과 시 자동 갱신
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState !== 'visible') return;
  if (!userLat) return;
  if (Date.now() - locationTimestamp > 1800000) {
    requestLocation();
  }
});

// 테스트 위치 오버라이드 (?testloc=1 → 까사멜로우)
function applyTestLocation() {
  const params = new URLSearchParams(location.search);
  if (params.get('testloc') !== '1') return false;

  userLat = 35.8579382;
  userLng = 129.262038;
  locationTimestamp = Date.now();

  document.getElementById('locationBanner').style.display = 'none';
  document.getElementById('refreshBtn').classList.add('visible');

  const indicator = document.createElement('div');
  indicator.className = 'update-time';
  indicator.style.color = 'var(--accent)';
  indicator.textContent = '테스트 위치: 까사멜로우 (숙소)';
  document.querySelector('.header').appendChild(indicator);

  if (travelData) renderDayContent();
  return true;
}

// 페이지 로드 후 초기화
document.addEventListener('DOMContentLoaded', () => {
  if (!applyTestLocation()) initLocationBanner();
});

// ═══ CHAT ═══════════════════════════════════════════════════
var chatOpen = false;
var chatBusy = false;
var chatMessages = [];

function toggleChat() {
  chatOpen = !chatOpen;
  document.getElementById('chatOverlay').classList.toggle('open', chatOpen);
  document.getElementById('chatSheet').classList.toggle('open', chatOpen);
  document.getElementById('chatFab').classList.toggle('hidden', chatOpen);
  if (chatOpen) {
    setTimeout(function() { document.getElementById('chatInput').focus(); }, 350);
    scrollChatBottom();
  }
}

function closeChat() {
  chatOpen = false;
  document.getElementById('chatOverlay').classList.remove('open');
  document.getElementById('chatSheet').classList.remove('open');
  document.getElementById('chatFab').classList.remove('hidden');
}

function scrollChatBottom() {
  var el = document.getElementById('chatMessages');
  if (el) el.scrollTop = el.scrollHeight;
}

function appendChatMsg(role, text) {
  var container = document.getElementById('chatMessages');
  var welcome = container.querySelector('.chat-welcome');
  if (welcome) welcome.style.display = 'none';

  var div = document.createElement('div');
  div.className = 'chat-msg ' + role;
  if (role === 'bot') {
    div.innerHTML = '<div class="msg-label">포저</div>' + escapeHtml(text).replace(/\n/g, '<br>');
  } else if (role === 'error') {
    div.textContent = text;
  } else {
    div.textContent = text;
  }
  container.appendChild(div);
  scrollChatBottom();
  return div;
}

function showTyping() {
  var container = document.getElementById('chatMessages');
  var div = document.createElement('div');
  div.className = 'chat-msg bot typing';
  div.id = 'chatTyping';
  div.innerHTML = '<div class="msg-label">포저</div><div class="dots"><span></span><span></span><span></span></div>';
  container.appendChild(div);
  scrollChatBottom();
}

function removeTyping() {
  var el = document.getElementById('chatTyping');
  if (el) el.remove();
}

async function sendChat() {
  if (chatBusy) return;
  var input = document.getElementById('chatInput');
  var msg = input.value.trim();
  if (!msg) return;

  input.value = '';
  appendChatMsg('user', msg);
  chatBusy = true;
  document.getElementById('chatSendBtn').disabled = true;
  showTyping();

  try {
    var resp = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg })
    });
    removeTyping();
    var data = await resp.json();
    if (!resp.ok) {
      appendChatMsg('error', data.error || '요청에 실패했습니다');
    } else {
      appendChatMsg('bot', data.reply || '응답을 받지 못했어요.');
      if (data.data_modified) {
        showToast('포저가 일정을 수정했어요. 새로고침합니다.');
        setTimeout(function() { loadTravelData(); }, 1500);
      }
    }
  } catch (e) {
    removeTyping();
    appendChatMsg('error', '포저에게 연결할 수 없습니다. 잠시 후 다시 시도해주세요.');
  }
  chatBusy = false;
  document.getElementById('chatSendBtn').disabled = false;
}

function chatHint(text) {
  document.getElementById('chatInput').value = text;
  sendChat();
}

// 키보드 Enter 전송
document.addEventListener('DOMContentLoaded', function() {
  var chatInput = document.getElementById('chatInput');
  if (chatInput) {
    chatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChat();
      }
    });
  }
});
</script>

<!-- 채팅 버블 -->
<button class="chat-fab" id="chatFab" onclick="toggleChat()" aria-label="포저와 대화">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
</button>

<!-- 채팅 오버레이 -->
<div class="chat-overlay" id="chatOverlay" onclick="closeChat()"></div>

<!-- 채팅 시트 -->
<div class="chat-sheet" id="chatSheet">
  <div class="chat-sheet-header">
    <div>
      <div class="chat-sheet-title">포저와 대화</div>
      <div class="chat-sheet-subtitle">AI 여행 보좌관</div>
    </div>
    <button class="chat-close-btn" onclick="closeChat()" aria-label="닫기">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </button>
  </div>
  <div class="chat-messages" id="chatMessages">
    <div class="chat-welcome">
      <div class="chat-welcome-icon">&#x1F9ED;</div>
      <div class="chat-welcome-title">안녕하세요, 포저입니다</div>
      <div class="chat-welcome-desc">경주 여행에 대해 무엇이든 물어보세요.<br>일정 변경, 맛집 추천, 관광 정보 등<br>무엇이든 도와드릴게요.</div>
      <div class="chat-welcome-hints">
        <div class="chat-hint-chip" onclick="chatHint('내일 일정 알려줘')">내일 일정</div>
        <div class="chat-hint-chip" onclick="chatHint('근처 맛집 추천해줘')">맛집 추천</div>
        <div class="chat-hint-chip" onclick="chatHint('아이랑 갈만한 곳')">아이와 함께</div>
      </div>
    </div>
  </div>
  <div class="chat-input-row">
    <textarea class="chat-input" id="chatInput" rows="1" placeholder="메시지를 입력하세요..."></textarea>
    <button class="chat-send-btn" id="chatSendBtn" onclick="sendChat()" aria-label="전송">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4z"/></svg>
    </button>
  </div>
</div>

</body>
</html>
