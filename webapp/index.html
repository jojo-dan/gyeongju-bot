<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ê²½ì£¼ ê°€ì¡±ì—¬í–‰</title>
<meta property="og:title" content="ê²½ì£¼ ê°€ì¡±ì—¬í–‰ 2026">
<meta property="og:description" content="2026.02.19~24 ê²½ì£¼ ê°€ì¡±ì—¬í–‰ ì¼ì • Â· ì‹ë‹¹ Â· ê´€ê´‘ì§€ Â· ì§€ë„">
<meta property="og:image" content="https://gyeongju-trip.vercel.app/og-image.png">
<meta property="og:url" content="https://gyeongju-trip.vercel.app">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5612fbbe8c2401ba1497a119c2c44a7c&libraries=services"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #E5E5E5;
  --housing: #FFFFFF;
  --display: #2A2A2A;
  --display-text: #FFFFFF;
  --display-dim: rgba(255,255,255,0.65);
  --accent: #E85D2A;
  --text: #1A1A1A;
  --text-mid: #555;
  --text-light: #666;
  --border: #D5D5D5;
  --item-bg: #F5F3F0;
  --item-text: #1A1A1A;
  --item-text-mid: #444;
  --item-text-dim: #666;
  --serif: 'Playfair Display', Georgia, 'Noto Serif KR', serif;
  --mono: 'IBM Plex Mono', 'SF Mono', monospace;
  --system: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', sans-serif;
  --radius-device: 16px;
  --radius-display: 10px;
  --radius-btn: 8px;
  --shadow-device: 0 2px 24px rgba(0,0,0,0.08), 0 0 0 1px rgba(0,0,0,0.03);
  --shadow-btn: 0 1px 3px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
}

body {
  font-family: var(--system);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding-bottom: 72px;
}

/* â•â•â• HEADER â•â•â• */
.header {
  padding: 32px 20px 24px;
  text-align: center;
}
.header h1 {
  font-family: var(--serif);
  font-size: 28px;
  font-weight: 700;
  letter-spacing: -0.5px;
  color: var(--text);
  margin-bottom: 4px;
}
.header .sub-info {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 500;
  color: var(--text-mid);
  letter-spacing: 0.5px;
  text-transform: uppercase;
}
.header .update-time {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text-light);
  margin-top: 6px;
  letter-spacing: 0.3px;
}

/* â•â•â• DEVICE CONTAINER â•â•â• */
.device {
  max-width: 420px;
  margin: 0 auto;
  padding: 0 16px;
}

/* â•â•â• DAY TABS (Toggle Group) â•â•â• */
.day-tabs {
  display: flex;
  gap: 0;
  max-width: 420px;
  margin: 0 auto 16px;
  padding: 0 16px;
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--bg);
  padding-top: 8px;
  padding-bottom: 8px;
}
.day-tabs::-webkit-scrollbar { display: none; }
.day-tab {
  flex: 1 1 0;
  padding: 12px 0;
  font-family: var(--mono);
  font-size: 14px;
  font-weight: 600;
  color: var(--text-mid);
  background: var(--housing);
  border: 1px solid var(--border);
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.15s ease;
  text-align: center;
  min-height: 44px;
}
.day-tab:first-child { border-radius: var(--radius-btn) 0 0 var(--radius-btn); }
.day-tab:last-child { border-radius: 0 var(--radius-btn) var(--radius-btn) 0; }
.day-tab:not(:first-child) { border-left: none; }
.day-tab.active {
  background: var(--text);
  color: #fff;
  border-color: var(--text);
}
.day-tab .tab-date {
  display: block;
  font-size: 12px;
  font-weight: 400;
  color: var(--text-light);
  margin-top: 2px;
}
.day-tab.active .tab-date { color: rgba(255,255,255,0.7); }

/* â•â•â• DISPLAY CARD (Main Device) â•â•â• */
.display-card {
  background: var(--housing);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  overflow: hidden;
  margin-bottom: 16px;
}
.display-screen {
  background: var(--display);
  margin: 12px;
  border-radius: var(--radius-display);
  padding: 20px 16px;
  position: relative;
}
.display-screen::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  border-radius: var(--radius-display);
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0,0,0,0.03) 2px,
    rgba(0,0,0,0.03) 4px
  );
  pointer-events: none;
}
.display-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.display-label {
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--accent);
  letter-spacing: 1px;
}
.display-indicator {
  display: flex;
  gap: 4px;
}
.display-indicator span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(255,255,255,0.3);
}
.display-indicator span.on { background: var(--display-text); }

.day-title-display {
  font-family: var(--mono);
  font-size: 22px;
  font-weight: 600;
  color: var(--display-text);
  margin-bottom: 6px;
  letter-spacing: 1px;
}
.day-subtitle {
  font-family: var(--mono);
  font-size: 14px;
  color: var(--display-dim);
}

/* â•â•â• CONTROL ROW â•â•â• */
.control-row {
  display: flex;
  padding: 0 12px 12px;
  gap: 6px;
}
.ctrl-btn {
  flex: 1;
  padding: 12px;
  background: var(--bg);
  border: none;
  border-radius: var(--radius-btn);
  font-family: var(--system);
  font-size: 13px;
  font-weight: 600;
  color: var(--text-mid);
  cursor: pointer;
  box-shadow: var(--shadow-btn);
  transition: all 0.1s ease;
  min-height: 44px;
}
.ctrl-btn:active {
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.15);
  transform: translateY(1px);
}
.ctrl-btn.active {
  background: var(--text);
  color: #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

/* â•â•â• LEVEL METER (Day Progress) â•â•â• */
.level-meter {
  padding: 0 16px 16px;
}
.meter-bar {
  height: 3px;
  background: rgba(0,0,0,0.08);
  border-radius: 2px;
  position: relative;
  overflow: visible;
}
.meter-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  transition: width 0.3s ease;
}
.meter-ticks {
  display: flex;
  justify-content: space-between;
  margin-top: 6px;
}
.meter-tick {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text-light);
}

/* â•â•â• ITEM CARDS â•â•â• */
.items-list {
  padding: 0 0 8px;
}

.item-card {
  background: var(--housing);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  margin-bottom: 12px;
  overflow: hidden;
}
.item-display {
  background: var(--item-bg);
  margin: 10px;
  border-radius: var(--radius-display);
  padding: 16px;
}
.item-top-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
.item-status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.item-status-dot.planned { background: #BBBBBB; }
.item-status-dot.done { background: #22C55E; }
.item-status-dot.skipped { background: #EF4444; }

.item-time {
  font-family: var(--mono);
  font-size: 13px;
  color: var(--item-text-dim);
  letter-spacing: 0.5px;
  font-weight: 500;
}
.item-cat-label {
  font-family: var(--system);
  font-size: 12px;
  color: var(--accent);
  margin-left: auto;
  font-weight: 600;
}

.item-title {
  font-family: var(--system);
  font-size: 18px;
  font-weight: 700;
  color: var(--item-text);
  letter-spacing: -0.2px;
}
.item-title.skipped {
  text-decoration: line-through;
  color: var(--item-text-dim);
}

/* â•â•â• OPTIONS (in display) â•â•â• */
.options-list {
  margin-top: 10px;
  border-top: 1px solid rgba(0,0,0,0.06);
  padding-top: 10px;
}
.option-item {
  padding: 10px 12px;
  border-radius: 6px;
  margin-bottom: 8px;
  font-family: var(--system);
  font-size: 14px;
  color: var(--item-text-mid);
  background: rgba(255,255,255,0.6);
  transition: all 0.15s;
}
.option-item.chosen {
  background: rgba(34, 139, 34, 0.08);
  color: #1A6B1A;
  border: 1px solid rgba(34, 139, 34, 0.2);
}
.option-name { font-weight: 700; color: var(--item-text); }
.option-item.chosen .option-name { color: #1A6B1A; }
.option-menu { color: var(--item-text-mid); font-size: 13px; }
.option-badges { margin-top: 6px; display: flex; gap: 6px; flex-wrap: wrap; }
.badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-family: var(--system);
  font-size: 12px;
  font-weight: 600;
}
.badge-dad-good { background: #DEF7E5; color: #1A6B1A; }
.badge-dad-caution { background: #FDE8E0; color: #C04A1A; }
.badge-hiro-good { background: #DBEAFE; color: #1D4ED8; }
.badge-hiro-caution { background: #FEE2E2; color: #C53030; }

.chosen-tag {
  font-family: var(--system);
  font-size: 12px;
  font-weight: 700;
  color: #1A6B1A;
}

/* â•â•â• ITEM NOTE â•â•â• */
.item-note-row {
  padding: 10px 14px 12px;
  font-family: var(--system);
  font-size: 14px;
  color: var(--text-mid);
}
.item-note-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-light);
  margin-bottom: 3px;
}

/* â•â•â• ADMIN BAR â•â•â• */
.admin-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--housing);
  border-top: 1px solid var(--border);
  padding: 12px 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  z-index: 200;
}
.admin-bar button {
  padding: 12px 24px;
  background: var(--bg);
  color: var(--text-mid);
  border: 1px solid var(--border);
  border-radius: var(--radius-btn);
  font-family: var(--system);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: var(--shadow-btn);
  transition: all 0.1s;
  min-height: 44px;
}
.admin-bar button:active {
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.15);
}
.admin-bar button.active-admin {
  background: var(--text);
  color: #fff;
  border-color: var(--text);
}
.admin-bar .admin-status {
  font-family: var(--system);
  font-size: 13px;
  color: #16A34A;
  font-weight: 600;
}

/* â•â•â• EDIT CONTROLS (Admin) â•â•â• */
.edit-controls {
  padding: 10px 12px 12px;
  border-top: 1px solid var(--border);
}
.edit-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
.edit-row label {
  font-family: var(--system);
  font-size: 13px;
  font-weight: 600;
  color: var(--text-light);
  min-width: 44px;
}
.edit-row select, .edit-row input {
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-btn);
  font-family: var(--system);
  font-size: 14px;
  flex: 1;
  min-width: 0;
  background: var(--bg);
  min-height: 44px;
}
.edit-row select:focus, .edit-row input:focus {
  border-color: var(--text);
  outline: none;
}
.save-btn {
  width: 100%;
  padding: 12px;
  background: var(--text);
  color: #fff;
  border: none;
  border-radius: var(--radius-btn);
  font-family: var(--system);
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 4px;
  min-height: 44px;
}
.save-btn:active { opacity: 0.8; }

/* â•â•â• PIN MODAL â•â•â• */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.3);
  backdrop-filter: blur(4px);
  z-index: 300;
  align-items: center;
  justify-content: center;
}
.modal-overlay.show { display: flex; }
.modal {
  background: var(--housing);
  border-radius: var(--radius-device);
  padding: 28px 24px;
  width: 280px;
  text-align: center;
  box-shadow: 0 8px 40px rgba(0,0,0,0.15);
}
.modal h3 {
  font-family: var(--system);
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 20px;
  color: var(--text);
}
.modal input {
  width: 100%;
  padding: 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-btn);
  font-family: var(--mono);
  font-size: 24px;
  text-align: center;
  letter-spacing: 12px;
  margin-bottom: 12px;
  background: var(--bg);
}
.modal input:focus { border-color: var(--text); outline: none; }
.modal .modal-buttons { display: flex; gap: 8px; }
.modal .modal-buttons button {
  flex: 1;
  padding: 14px;
  border: none;
  border-radius: var(--radius-btn);
  font-family: var(--system);
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  min-height: 44px;
}
.modal .btn-cancel { background: var(--bg); color: var(--text-mid); }
.modal .btn-confirm { background: var(--text); color: #fff; }
.modal .error-msg { color: #DC2626; font-family: var(--system); font-size: 13px; margin-top: 4px; }

/* â•â•â• LOADING â•â•â• */
.loading {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-light);
  font-family: var(--system);
  font-size: 14px;
}
.loading .spinner {
  display: inline-block;
  width: 24px; height: 24px;
  border: 2px solid var(--border);
  border-top-color: var(--text);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â•â•â• ERROR â•â•â• */
.error-banner {
  max-width: 420px;
  margin: 0 auto;
  padding: 12px 16px;
  font-family: var(--system);
  font-size: 14px;
  text-align: center;
  color: #C04A1A;
  background: rgba(232,93,42,0.08);
  border-radius: var(--radius-btn);
  display: none;
}
.error-banner.show { display: block; margin-bottom: 12px; }

/* â•â•â• TOAST â•â•â• */
.toast {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: var(--text);
  color: #fff;
  padding: 14px 28px;
  border-radius: var(--radius-btn);
  font-family: var(--system);
  font-size: 15px;
  font-weight: 600;
  z-index: 400;
  transition: transform 0.3s;
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* â•â•â• REFERENCE â•â•â• */
.reference-section {
  margin-top: 8px;
}
.reference-section h3 {
  font-family: var(--system);
  font-size: 15px;
  font-weight: 700;
  color: var(--text-mid);
  margin-bottom: 12px;
}
.ref-card {
  background: var(--housing);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  padding: 14px 16px;
  margin-bottom: 10px;
}
.ref-card h4 {
  font-family: var(--system);
  font-size: 13px;
  font-weight: 700;
  color: var(--text-mid);
  margin-bottom: 8px;
}
.ref-card ul { list-style: none; }
.ref-card li {
  font-family: var(--system);
  font-size: 14px;
  padding: 4px 0;
  color: var(--text-mid);
}

/* â•â•â• MAP VIEW â•â•â• */
.map-container {
  background: var(--housing);
  border-radius: var(--radius-device);
  box-shadow: var(--shadow-device);
  overflow: hidden;
  margin-bottom: 12px;
}
.map-screen {
  background: var(--display);
  margin: 12px;
  border-radius: var(--radius-display);
  position: relative;
  overflow: hidden;
}
.map-screen #kakaoMap {
  width: 100%;
  height: 300px;
}
/* scanline ì œê±° - ì§€ë„ ë§ˆì»¤ ê°€ë¦¼ ë°©ì§€ */
.map-place-list {
  padding: 8px 12px 12px;
}
.map-place-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: var(--item-bg);
  border-radius: 8px;
  margin-bottom: 6px;
  cursor: pointer;
  transition: background 0.15s;
  font-family: var(--system);
}
.map-place-item:active {
  background: var(--border);
}
.map-place-num {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--accent);
  color: #fff;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.map-place-num.done { background: #22C55E; }
.map-place-num.skipped { background: #EF4444; }
.map-place-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--item-text);
  flex: 1;
}
.map-place-time {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--item-text-dim);
}
.map-loading {
  height: 300px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--display-dim);
  font-family: var(--system);
  font-size: 14px;
}

/* â•â•â• SPEAKER GRILLE (decorative) â•â•â• */
.grille {
  display: inline-grid;
  grid-template-columns: repeat(4, 4px);
  gap: 3px;
  opacity: 0.15;
}
.grille span {
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--text);
}
</style>
</head>
<body>

<!-- ë©”ì¸ ì•± -->
<div id="mainApp">
  <div class="header">
    <h1>ê²½ì£¼ ê°€ì¡±ì—¬í–‰</h1>
    <div class="sub-info">
      <span id="tripStatus">2026.02.19 â€” 02.24</span>
    </div>
    <div class="update-time" id="updateTime"></div>
  </div>

  <div class="error-banner" id="errorBanner"></div>

  <div class="day-tabs" id="dayTabs"></div>

  <div class="device">
    <div id="contentArea">
      <div class="loading">
        <div class="spinner"></div>
        <div>ì¼ì • ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>
  </div>

  <div class="admin-bar">
    <button id="mapBtn" onclick="toggleMapView()">ì§€ë„</button>
    <button id="adminBtn" onclick="toggleAdmin()">ê´€ë¦¬</button>
    <span id="adminStatus"></span>
  </div>
</div>

<!-- PIN ëª¨ë‹¬ -->
<div class="modal-overlay" id="pinModal">
  <div class="modal">
    <h3>ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
    <input type="password" id="pinInput" maxlength="4" inputmode="numeric" pattern="[0-9]*">
    <div class="error-msg" id="pinError"></div>
    <div class="modal-buttons">
      <button class="btn-cancel" onclick="closePinModal()">ì·¨ì†Œ</button>
      <button class="btn-confirm" onclick="checkPin()">í™•ì¸</button>
    </div>
  </div>
</div>

<!-- í† ìŠ¤íŠ¸ -->
<div class="toast" id="toast"></div>

<script>
const ADMIN_PIN = '4545';
const POLL_INTERVAL = 30000;

let travelData = null;
let activeDay = 0;
let isAdmin = false;
let isMapView = false;
let pollTimer = null;
let kakaoMap = null;
let mapMarkers = [];
let mapPolyline = null;
let mapInfoWindow = null;
const coordsCache = {}; // ì¥ì†Œëª… â†’ {lat, lng} ìºì‹œ
const GYEONGJU_CENTER = { lat: 35.8562, lng: 129.2247 };

// ì•± ì‹œì‘
(function init() {
  fetchData();
  pollTimer = setInterval(fetchData, POLL_INTERVAL);
})();

async function fetchData() {
  try {
    const res = await fetch('/api/data');
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    const json = await res.json();
    travelData = json.record;
    hideError();
    render();
  } catch (e) {
    showError('ì—°ê²° ëŠê¹€. ë‹¤ì‹œ ì‹œë„ ì¤‘...');
    console.error('fetch error:', e);
  }
}

async function saveData() {
  try {
    travelData.meta.lastUpdated = new Date().toISOString();
    const res = await fetch('/api/save', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(travelData)
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    showToast('ì €ì¥ ì™„ë£Œ');
    render();
  } catch (e) {
    showToast('ì €ì¥ ì‹¤íŒ¨');
    console.error('save error:', e);
  }
}

function render() {
  if (!travelData) return;
  updateHeader();
  renderTabs();
  if (isMapView) {
    renderMapView();
  } else {
    renderDayContent();
  }
}

function updateHeader() {
  const meta = travelData.meta;
  if (meta && meta.lastUpdated) {
    const d = new Date(meta.lastUpdated);
    document.getElementById('updateTime').textContent =
      `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${formatDateTime(d)}`;
  }
  const now = new Date();
  const tripStart = new Date('2026-02-19T00:00:00+09:00');
  const tripEnd = new Date('2026-02-24T23:59:59+09:00');
  let status = '2026.02.19 â€” 02.24';
  if (now < tripStart) {
    const diff = Math.ceil((tripStart - now) / 86400000);
    status = `D-${diff} / 2026.02.19 â€” 02.24`;
  } else if (now > tripEnd) {
    status = 'ì—¬í–‰ ì™„ë£Œ';
  } else {
    const dayNum = Math.floor((now - tripStart) / 86400000) + 1;
    status = `${dayNum}ì¼ì°¨ ì§„í–‰ ì¤‘`;
    if (activeDay === 0) activeDay = dayNum - 1;
  }
  document.getElementById('tripStatus').textContent = status;
}

function renderTabs() {
  const tabs = document.getElementById('dayTabs');
  const days = travelData.days;
  tabs.innerHTML = '';
  days.forEach((day, idx) => {
    const tab = document.createElement('div');
    tab.className = 'day-tab' + (idx === activeDay ? ' active' : '');
    tab.innerHTML = `${day.dayNum}ì¼ì°¨<span class="tab-date">${formatTabDate(day.date, day.dow)}</span>`;
    tab.onclick = () => { activeDay = idx; renderTabs(); if (isMapView) renderMapView(); else renderDayContent(); };
    tabs.appendChild(tab);
  });
  const activeTab = tabs.querySelector('.active');
  if (activeTab) activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
}

function renderDayContent() {
  const area = document.getElementById('contentArea');
  const day = travelData.days[activeDay];
  if (!day) { area.innerHTML = '<div class="loading">ë°ì´í„° ì—†ìŒ</div>'; return; }

  // ì§„í–‰ë¥  ê³„ì‚°
  const totalItems = day.items.length;
  const doneItems = day.items.filter(i => i.status === 'done' || i.status === 'skipped').length;
  const progress = totalItems > 0 ? (doneItems / totalItems * 100) : 0;

  let html = '';

  // ë©”ì¸ ë””ìŠ¤í”Œë ˆì´ ì¹´ë“œ
  html += '<div class="display-card">';
  html += '<div class="display-screen">';
  html += '<div class="display-header">';
  html += `<span class="display-label">ì¼ì •</span>`;
  html += '<div class="display-indicator">';
  for (let i = 0; i < totalItems; i++) {
    html += `<span class="${i < doneItems ? 'on' : ''}"></span>`;
  }
  html += '</div></div>';
  html += `<div class="day-title-display">${day.title}</div>`;
  html += `<div class="day-subtitle">${day.dayNum}ì¼ì°¨ / ${doneItems}/${totalItems} ì™„ë£Œ</div>`;
  html += '</div>';

  // ì§„í–‰ ë ˆë²¨ ë¯¸í„°
  html += '<div class="level-meter">';
  html += `<div class="meter-bar"><div class="meter-fill" style="width:${progress}%"></div></div>`;
  html += '<div class="meter-ticks">';
  html += '<span class="meter-tick">0%</span>';
  html += `<span class="meter-tick" style="color:var(--accent)">${Math.round(progress)}%</span>`;
  html += '<span class="meter-tick">100%</span>';
  html += '</div></div>';

  html += '</div>';

  // ì¼ì • ì•„ì´í…œ ì¹´ë“œë“¤
  html += '<div class="items-list">';
  day.items.forEach((item, itemIdx) => {
    html += renderItemCard(item, itemIdx);
  });
  html += '</div>';

  // reference ì„¹ì…˜
  if (activeDay === travelData.days.length - 1 && travelData.reference) {
    html += renderReference(travelData.reference);
  }

  area.innerHTML = html;
}

function renderItemCard(item, itemIdx) {
  const catLabel = { meal: 'ì‹ì‚¬', cafe: 'ì¹´í˜', activity: 'ê´€ê´‘' };
  const titleClass = item.status === 'skipped' ? ' skipped' : '';

  let html = `<div class="item-card">`;
  html += '<div class="item-display">';

  // ìƒë‹¨ í–‰
  html += '<div class="item-top-row">';
  html += `<span class="item-status-dot ${item.status}"></span>`;
  html += `<span class="item-time">${item.time || ''}</span>`;
  html += `<span class="item-cat-label">${catLabel[item.cat] || ''}</span>`;
  html += '</div>';

  // ì œëª©
  html += `<div class="item-title${titleClass}">${item.title}</div>`;

  // ì˜µì…˜ ëª©ë¡
  if (item.options && item.options.length > 0) {
    html += '<div class="options-list">';
    item.options.forEach(opt => {
      const isChosen = item.chosen && item.chosen === opt.name;
      html += `<div class="option-item${isChosen ? ' chosen' : ''}">`;
      html += `<span class="option-name">${opt.name}</span>`;
      if (opt.menu) html += ` <span class="option-menu">â€” ${opt.menu}</span>`;
      if (isChosen) html += ` <span class="chosen-tag">í™•ì •</span>`;

      const badges = [];
      if (opt.dad === 'good') badges.push('<span class="badge badge-dad-good">ì•„ë¹  OK</span>');
      if (opt.dad === 'caution') badges.push('<span class="badge badge-dad-caution">ì•„ë¹  ì£¼ì˜</span>');
      if (opt.hiro === 'good') badges.push('<span class="badge badge-hiro-good">íˆë¡œ OK</span>');
      if (opt.hiro === 'caution') {
        let hiroLabel = 'íˆë¡œ ì£¼ì˜';
        if (opt.hiroNote) hiroLabel += ` (${opt.hiroNote})`;
        badges.push(`<span class="badge badge-hiro-caution">${hiroLabel}</span>`);
      }
      if (badges.length) html += `<div class="option-badges">${badges.join('')}</div>`;

      html += '</div>';
    });
    html += '</div>';
  }

  html += '</div>'; // item-display ë‹«ê¸°

  // ë©”ëª¨
  if (item.note) {
    html += '<div class="item-note-row">';
    html += '<div class="item-note-label">ë©”ëª¨</div>';
    html += escapeHtml(item.note);
    html += '</div>';
  }

  // ê´€ë¦¬ì í¸ì§‘ UI
  if (isAdmin) {
    html += renderEditControls(item, itemIdx);
  }

  html += '</div>';
  return html;
}

function renderEditControls(item, itemIdx) {
  let html = '<div class="edit-controls">';

  html += '<div class="edit-row">';
  html += '<label>ìƒíƒœ</label>';
  html += `<select onchange="updateItemField(${activeDay}, ${itemIdx}, 'status', this.value)">`;
  const statusLabel = { planned: 'ì˜ˆì •', done: 'ì™„ë£Œ', skipped: 'ê±´ë„ˆëœ€' };
  ['planned', 'done', 'skipped'].forEach(s => {
    html += `<option value="${s}"${item.status === s ? ' selected' : ''}>${statusLabel[s]}</option>`;
  });
  html += '</select></div>';

  if (item.options && item.options.length > 0) {
    html += '<div class="edit-row">';
    html += '<label>ì„ íƒ</label>';
    html += `<select onchange="updateItemField(${activeDay}, ${itemIdx}, 'chosen', this.value)">`;
    html += `<option value="">â€”</option>`;
    item.options.forEach(opt => {
      html += `<option value="${escapeAttr(opt.name)}"${item.chosen === opt.name ? ' selected' : ''}>${opt.name}</option>`;
    });
    html += '</select></div>';
  }

  html += '<div class="edit-row">';
  html += '<label>ë©”ëª¨</label>';
  html += `<input type="text" value="${escapeAttr(item.note || '')}" onchange="updateItemField(${activeDay}, ${itemIdx}, 'note', this.value)" placeholder="ë©”ëª¨ ì…ë ¥...">`;
  html += '</div>';

  html += `<button class="save-btn" onclick="saveData()">ë³€ê²½ì‚¬í•­ ì €ì¥</button>`;
  html += '</div>';
  return html;
}

function updateItemField(dayIdx, itemIdx, field, value) {
  if (!travelData) return;
  travelData.days[dayIdx].items[itemIdx][field] = value;
}

function renderReference(ref) {
  let html = '<div class="reference-section"><h3>ì°¸ê³  ì •ë³´</h3>';

  if (ref.distances && ref.distances.length) {
    html += '<div class="ref-card"><h4>ê±°ë¦¬ / ì†Œìš”ì‹œê°„</h4><ul>';
    ref.distances.forEach(d => { html += `<li>${typeof d === 'string' ? d : JSON.stringify(d)}</li>`; });
    html += '</ul></div>';
  }
  if (ref.contacts && ref.contacts.length) {
    html += '<div class="ref-card"><h4>ì—°ë½ì²˜</h4><ul>';
    ref.contacts.forEach(c => { html += `<li>${typeof c === 'string' ? c : JSON.stringify(c)}</li>`; });
    html += '</ul></div>';
  }
  if (ref.shopping && ref.shopping.length) {
    html += '<div class="ref-card"><h4>ì‡¼í•‘</h4><ul>';
    ref.shopping.forEach(s => { html += `<li>${typeof s === 'string' ? s : JSON.stringify(s)}</li>`; });
    html += '</ul></div>';
  }

  html += '</div>';
  return html;
}

// ê´€ë¦¬ì ëª¨ë“œ
function toggleAdmin() {
  if (isAdmin) {
    isAdmin = false;
    document.getElementById('adminBtn').classList.remove('active-admin');
    document.getElementById('adminStatus').textContent = '';
    render();
  } else {
    openPinModal();
  }
}

function openPinModal() {
  document.getElementById('pinModal').classList.add('show');
  document.getElementById('pinInput').value = '';
  document.getElementById('pinError').textContent = '';
  setTimeout(() => document.getElementById('pinInput').focus(), 100);
}

function closePinModal() {
  document.getElementById('pinModal').classList.remove('show');
}

function checkPin() {
  const pin = document.getElementById('pinInput').value;
  if (pin === ADMIN_PIN) {
    isAdmin = true;
    closePinModal();
    document.getElementById('adminBtn').classList.add('active-admin');
    document.getElementById('adminStatus').textContent = 'í™œì„±í™”';
    render();
  } else {
    document.getElementById('pinError').textContent = 'ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸';
  }
}

document.getElementById('pinInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') checkPin();
});

// ìœ í‹¸
function formatDateTime(d) {
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  const hh = String(d.getHours()).padStart(2, '0');
  const mi = String(d.getMinutes()).padStart(2, '0');
  return `${mm}.${dd} ${hh}:${mi}`;
}

function formatTabDate(dateStr, dow) {
  const parts = dateStr.split('-');
  return `${parseInt(parts[1])}/${parseInt(parts[2])}`;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function escapeAttr(str) {
  return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function showError(msg) {
  const el = document.getElementById('errorBanner');
  el.textContent = msg;
  el.classList.add('show');
}
function hideError() {
  document.getElementById('errorBanner').classList.remove('show');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// â•â•â• ì§€ë„ ê¸°ëŠ¥ â•â•â•

function toggleMapView() {
  isMapView = !isMapView;
  const btn = document.getElementById('mapBtn');
  if (isMapView) {
    btn.classList.add('active-admin');
  } else {
    btn.classList.remove('active-admin');
    kakaoMap = null;
  }
  render();
}

function renderMapView() {
  const area = document.getElementById('contentArea');
  const day = travelData.days[activeDay];
  if (!day) return;

  // ì¥ì†Œ ëª©ë¡ ì¶”ì¶œ
  const places = extractPlaces(day);

  let html = '<div class="map-container">';
  html += '<div class="map-screen"><div id="kakaoMap"><div class="map-loading">ì§€ë„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div></div>';
  html += '<div class="map-place-list">';
  const catIcon = { meal: 'ğŸ½', cafe: 'â˜•', activity: 'ğŸ“' };
  places.forEach((p, i) => {
    const statusCls = p.status === 'done' ? ' done' : p.status === 'skipped' ? ' skipped' : '';
    const dimStyle = p.isGeneric ? ' style="opacity:0.5"' : '';
    html += `<div class="map-place-item"${dimStyle} onclick="panToPlace(${i})">`;
    html += `<span class="map-place-num${statusCls}">${i + 1}</span>`;
    html += `<span class="map-place-name">${catIcon[p.cat] || ''} ${escapeHtml(p.name)}</span>`;
    html += `<span class="map-place-time">${p.time || ''}</span>`;
    html += '</div>';
  });
  html += '</div></div>';

  area.innerHTML = html;

  // ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” (DOM ë Œë”ë§ í›„)
  setTimeout(() => initKakaoMap(places), 100);
}

// ê²€ìƒ‰ ë¶ˆê°€ëŠ¥í•œ ì¼ë°˜ í™œë™ í‚¤ì›Œë“œ
const SKIP_KEYWORDS = ['ì´ë™', 'ì¶œë°œ', 'ë„ì°©', 'ì²´í¬ì¸', 'ì²´í¬ì•„ì›ƒ', 'ì •ì°©', 'ì¤€ë¹„', 'ë§ˆë¼í†¤', 'ëŒ€ê¸°', 'ë³µê·€'];

function extractPlaces(day) {
  const places = [];
  day.items.forEach(item => {
    // ì¼ë°˜ í™œë™(ì´ë™, ì²´í¬ì¸ ë“±)ì€ ìŠ¤í‚µ
    const isGeneric = SKIP_KEYWORDS.some(kw => item.title.includes(kw));

    let name = '';
    let searchQuery = '';

    if (item.chosen && item.options) {
      const opt = item.options.find(o => o.name === item.chosen);
      if (opt) { name = opt.name; searchQuery = 'ê²½ì£¼ ' + opt.name; }
    }
    if (!name && item.options && item.options.length > 0) {
      name = item.options[0].name;
      searchQuery = 'ê²½ì£¼ ' + item.options[0].name;
    }
    if (!name) {
      name = item.title;
      if (!isGeneric) searchQuery = 'ê²½ì£¼ ' + item.title;
    }

    places.push({
      name: name,
      title: item.title,
      time: item.time || '',
      status: item.status,
      cat: item.cat,
      searchQuery: searchQuery, // ë¹ˆ ë¬¸ìì—´ì´ë©´ ê²€ìƒ‰ ìŠ¤í‚µ
      isGeneric: isGeneric && !searchQuery
    });
  });
  return places;
}

// ìˆ™ì†Œ ê³ ì • ì¢Œí‘œ
const ACCOMMODATION = { lat: 35.8428, lng: 129.2155, name: 'ê¹Œì‚¬ë©œë¡œìš° (ìˆ™ì†Œ)' };

function initKakaoMap(places) {
  const container = document.getElementById('kakaoMap');
  if (!container || typeof kakao === 'undefined') {
    console.error('ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ ì‹¤íŒ¨');
    return;
  }

  const center = new kakao.maps.LatLng(GYEONGJU_CENTER.lat, GYEONGJU_CENTER.lng);
  kakaoMap = new kakao.maps.Map(container, { center: center, level: 7 });
  mapMarkers = [];
  mapInfoWindow = null;

  // ìˆ™ì†Œ ë§ˆì»¤ (í•­ìƒ í‘œì‹œ)
  addAccommodationMarker();

  // ê²€ìƒ‰ ê°€ëŠ¥í•œ ì¥ì†Œë§Œ í•„í„°
  const searchablePlaces = places.map((p, i) => ({ ...p, originalIdx: i })).filter(p => p.searchQuery);

  if (searchablePlaces.length === 0) {
    // ê²€ìƒ‰í•  ì¥ì†Œ ì—†ìœ¼ë©´ ìˆ™ì†Œ ì¤‘ì‹¬
    kakaoMap.setCenter(new kakao.maps.LatLng(ACCOMMODATION.lat, ACCOMMODATION.lng));
    kakaoMap.setLevel(5);
    return;
  }

  const ps = new kakao.maps.services.Places();
  const coords = new Array(places.length).fill(null);
  let resolved = 0;
  const total = searchablePlaces.length;

  searchablePlaces.forEach(place => {
    const idx = place.originalIdx;

    // ìºì‹œ í™•ì¸
    if (coordsCache[place.searchQuery]) {
      coords[idx] = coordsCache[place.searchQuery];
      resolved++;
      if (resolved === total) drawMarkers(places, coords);
      return;
    }

    ps.keywordSearch(place.searchQuery, function(data, searchStatus) {
      if (searchStatus === kakao.maps.services.Status.OK && data.length > 0) {
        const result = data[0];
        const c = { lat: parseFloat(result.y), lng: parseFloat(result.x), placeName: result.place_name };
        coordsCache[place.searchQuery] = c;
        coords[idx] = c;
        console.log(`[ì§€ë„] "${place.searchQuery}" â†’ ${result.place_name}`);
      } else {
        console.warn(`[ì§€ë„] "${place.searchQuery}" ê²€ìƒ‰ ì‹¤íŒ¨`);
        coords[idx] = null;
      }
      resolved++;
      if (resolved === total) drawMarkers(places, coords);
    }, { location: center, radius: 30000, size: 1 });
  });
}

function addAccommodationMarker() {
  const pos = new kakao.maps.LatLng(ACCOMMODATION.lat, ACCOMMODATION.lng);
  const content = `<div style="
    padding:4px 10px;border-radius:20px;
    background:#1A1A1A;color:#fff;
    font-family:-apple-system,sans-serif;font-size:12px;font-weight:600;
    box-shadow:0 2px 8px rgba(0,0,0,0.3);
    white-space:nowrap;
  ">ğŸ  ${ACCOMMODATION.name}</div>`;
  const overlay = new kakao.maps.CustomOverlay({
    position: pos,
    content: content,
    yAnchor: 1.3
  });
  overlay.setMap(kakaoMap);
}

function drawMarkers(places, coords) {
  if (!kakaoMap) return;
  const bounds = new kakao.maps.LatLngBounds();
  const pathCoords = [];
  mapMarkers = new Array(places.length).fill(null);

  // ìˆ™ì†Œë„ boundsì— í¬í•¨
  bounds.extend(new kakao.maps.LatLng(ACCOMMODATION.lat, ACCOMMODATION.lng));

  let foundCount = 0;
  places.forEach((place, idx) => {
    const c = coords[idx];
    if (!c) return;
    foundCount++;

    const position = new kakao.maps.LatLng(c.lat, c.lng);
    bounds.extend(position);
    pathCoords.push(position);

    // ë§ˆì»¤ ìƒ‰ìƒ
    let color = '#E85D2A';
    if (place.status === 'done') color = '#22C55E';
    else if (place.status === 'skipped') color = '#EF4444';

    // ì¹´í…Œê³ ë¦¬ ì•„ì´ì½˜
    const catIcon = { meal: 'ğŸ½', cafe: 'â˜•', activity: 'ğŸ“' };
    const icon = catIcon[place.cat] || 'ğŸ“';

    // ì»¤ìŠ¤í…€ ë§ˆì»¤ (ë²ˆí˜¸ + ì¥ì†Œëª…)
    const markerContent = `<div style="display:flex;flex-direction:column;align-items:center;">
      <div style="
        padding:4px 10px;border-radius:16px;
        background:${color};color:#fff;
        font-family:-apple-system,sans-serif;font-size:13px;font-weight:700;
        box-shadow:0 2px 8px rgba(0,0,0,0.3);
        white-space:nowrap;
      ">${icon} ${escapeHtml(place.name)}</div>
      <div style="
        width:0;height:0;
        border-left:6px solid transparent;
        border-right:6px solid transparent;
        border-top:8px solid ${color};
      "></div>
    </div>`;

    const overlay = new kakao.maps.CustomOverlay({
      position: position,
      content: markerContent,
      yAnchor: 1
    });
    overlay.setMap(kakaoMap);
    mapMarkers[idx] = { overlay, position, place, coord: c };
  });

  // ë™ì„  ë¼ì¸
  if (pathCoords.length >= 2) {
    if (mapPolyline) mapPolyline.setMap(null);
    mapPolyline = new kakao.maps.Polyline({
      path: pathCoords,
      strokeWeight: 3,
      strokeColor: '#E85D2A',
      strokeOpacity: 0.6,
      strokeStyle: 'dashed'
    });
    mapPolyline.setMap(kakaoMap);
  }

  // ë²”ìœ„ ì¡°ì •
  kakaoMap.setBounds(bounds, 50, 50, 50, 50);

  console.log(`[ì§€ë„] ${foundCount}/${places.length} ì¥ì†Œ í‘œì‹œ ì™„ë£Œ`);
}

function panToPlace(idx) {
  if (!kakaoMap || !mapMarkers[idx]) {
    showToast('ìœ„ì¹˜ ì •ë³´ ì—†ìŒ');
    return;
  }
  const m = mapMarkers[idx];
  kakaoMap.setLevel(4);
  kakaoMap.panTo(m.position);
}
</script>
</body>
</html>
