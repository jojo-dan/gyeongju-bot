# T-003 [S-001] (P1) (AI) 웹앱 사용자 위치 기반 거리 표시

**Status**: READY_FOR_REVIEW

**work_type**: CODE

**done_rule**:
- Code PR merge + Closeout PR merge(오너) = DONE

---

## Goal

웹앱 일정표에서 사용자의 현재 위치 기준으로 각 장소까지의 대략적 거리를 표시한다.

---

## Acceptance Criteria

- [x] 위치 안내 배너 표시 (디바이스 카드 스타일)
- [x] 브라우저 Geolocation API로 위치 획득 (1회, enableHighAccuracy: false)
- [x] 아이템 카드 제목 아래에 거리 행 표시
- [x] 옵션 2개 이상인 항목에 옵션별 거리 표시
- [x] 1km 미만 시 주황색 강조 + 도보 시간 표시
- [x] 위치 거부 시 거리만 숨기고 일정 정상 동작
- [x] 여행 JSON에 좌표(lat/lng) 사전 저장
- [x] 수동 갱신 버튼 + 30분 자동 갱신
- [x] 카카오 SDK `<script>` 태그 제거 (좌표 사전 저장으로 불필요)
- [x] 코난(QA) 실동작 검증 통과

---

## Notes

- **기획서**: [docs/T-003-distance-feature-spec.md](../docs/T-003-distance-feature-spec.md)
- 오너 피드백: `briefing/reviewed/GYEONGJU_BOT_FEEDBACK.md` 항목 #4
- deps: T-001 (지도/관리 제거 완료 후 구현)
- DECISIONS.md 기록: D-20260211-002(좌표 사전 저장), D-20260211-003(카카오 SDK 제거)

---

## Plan (GO 전에 작성)

### 변경 파일
- `webapp/index.html` — 위치 배너 UI, 거리 행 렌더링, Geolocation 호출, Haversine 계산, 카카오 SDK 제거
- `src/tool_definitions.py` — option 스키마에 lat/lng 필드 추가
- `scripts/collect_coords.py` — 좌표 수집 스크립트 (신규)

### 검증 방법
1. Vercel 로컬에서 위치 배너 표시 → 위치 허용 → 거리 표시 확인
2. 위치 거부 → 일정 정상 동작 확인
3. 탭 전환 시 거리 재계산 확인
4. 브라우저 콘솔 에러 없음
5. 코난(QA) 실동작 검증

### 리스크 & 롤백
- Risk: 좌표 데이터가 없는 장소에서 거리 표시 누락 → 엣지 케이스로 처리 (행 생략)
- Risk: 카카오 SDK 제거 후 다른 의존성 발견 → git revert로 복원
- Rollback: `git checkout main -- webapp/index.html`

---

## Review Pack (READY_FOR_REVIEW)

- Release impact: minor

### Scope
웹앱에 사용자 위치 기반 거리 표시 기능 추가. 브라우저 Geolocation API + Haversine 직선거리 계산. 좌표는 jsonbin 여행 JSON에 사전 저장. 카카오 SDK 제거.

### Changed files
| 파일 | 변경 | 유형 |
|------|------|------|
| `webapp/index.html` | 위치 배너, 거리 행, Geolocation, Haversine, 갱신 UI, 카카오 SDK 제거 (726행→1014행) | 수정 |
| `scripts/collect_coords.py` | 23개 장소 좌표 수집 스크립트 (KNOWN_COORDS + Kakao REST API 모드) | 신규 |
| `src/tool_definitions.py` | update_option/add_option/add_item에 lat/lng 파라미터 추가 | 수정 |
| `docs/T-003-distance-feature-spec.md` | 기획서 (Mermaid 다이어그램, UX/기술 설계, 엣지 케이스) | 신규 |

### How to verify
1. `https://gyeongju-trip.vercel.app` 에서 접속
2. 위치 배너 → [위치 켜기] → 각 카드에 거리 표시
3. [괜찮습니다] → 배너 사라짐, 일정 정상
4. 브라우저 콘솔 JS 에러 없음

### Self-check results
- [x] AC 전체 10개 항목 충족
- [x] 카카오 SDK 완전 제거 (grep 0건)
- [x] Haversine 거리 검증 (대릉원→불국사 11.83km, 서울→경주 277km)
- [x] jsonbin 28/34 option에 좌표 반영 (비장소 6개 정상 제외)
- [x] 엣지 케이스 5건 코드 검증 통과
- [x] JS 구문 검증 통과 (node --check)
- [x] HTML 구조 검증 통과

## Evidence
- 코난(QA) 전항목 PASS (FAIL 0, WARN 1-배포환경 무관)
- AC 대조: 9/9 PASS
- 거리 계산 단위 검증: 11/11 PASS
- 데이터 검증: 6/6 PASS
- 엣지 케이스: 5/5 PASS

## Risks & rollback
- Risk: 추정 좌표 11개는 ~300m 오차 가능 (Kakao REST API 키 확보 후 정밀 검증 예정)
- Rollback: `git checkout main -- webapp/index.html src/tool_definitions.py && rm scripts/collect_coords.py`
